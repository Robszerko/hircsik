<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dinamikus Napszak Hírszalag</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js" type="module"></script>
    <script src="https://unpkg.com/suncalc@1.8.0/suncalc.js"></script>

    <style>
        :root {
            --accent-main: #00838F;
            --accent-gold: #B8860B;
            --font-display: 'Oswald', sans-serif;
            --font-body: 'Roboto', sans-serif;
            --stars1: radial-gradient(1px 1px at 20px 30px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 40px 70px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 50px 160px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 90px 40px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 130px 80px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 160px 120px, white, rgba(255,255,255,0));
            --stars2: radial-gradient(1.5px 1.5px at 10px 90px, white, rgba(255,255,255,0)), radial-gradient(1.5px 1.5px at 70px 20px, white, rgba(255,255,255,0)), radial-gradient(1.5px 1.5px at 120px 140px, white, rgba(255,255,255,0));
        }

        /* --- DINAMIKUS NAPSZAK TÉMÁK --- */
        body.theme-night      { --bg-main-gradient: linear-gradient(145deg, #020111, #191621); --text-primary: #E4E6EB; --text-secondary: #B0B3B8; --border-color: #3A3B3C; }
        body.theme-predawn    { --bg-main-gradient: linear-gradient(145deg, #191621, #2c2a4f); --text-primary: #E4E6EB; --text-secondary: #B0B3B8; --border-color: #2c2a4f; }
        body.theme-dawn       { --bg-main-gradient: linear-gradient(145deg, #2c2a4f, #7c4d8e, #d192a0); --text-primary: #2c3e50; --text-secondary: #606770; --border-color: #7c4d8e; }
        body.theme-sunrise    { --bg-main-gradient: linear-gradient(145deg, #f7cac9, #ff9a3f); --text-primary: #2c3e50; --text-secondary: #606770; --border-color: #f7cac9; }
        body.theme-morning    { --bg-main-gradient: linear-gradient(145deg, #E0F7FA, #87CEEB); --text-primary: #1C1E21; --text-secondary: #606770; --border-color: #B2EBF2; }
        body.theme-day        { --bg-main-gradient: linear-gradient(145deg, #81D4FA, #29B6F6); --text-primary: #1C1E21; --text-secondary: #005689; --border-color: #4FC3F7; }
        body.theme-afternoon  { --bg-main-gradient: linear-gradient(145deg, #29B6F6, #FFD700); --text-primary: #1C1E21; --text-secondary: #606770; --border-color: #FFECB3; }
        body.theme-sunset     { --bg-main-gradient: linear-gradient(145deg, #d94e3c, #ff9a3f); --text-primary: #2c3e50; --text-secondary: #606770; --border-color: #ff9a3f; }
        body.theme-dusk       { --bg-main-gradient: linear-gradient(145deg, #d94e3c, #483D8B); --text-primary: #E4E6EB; --text-secondary: #B0B3B8; --border-color: #483D8B; }
        body.theme-civil-dusk { --bg-main-gradient: linear-gradient(145deg, #483D8B, #2c3e50); --text-primary: #E4E6EB; --text-secondary: #B0B3B8; --border-color: #2c3e50; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #111; font-family: var(--font-body); }
        
        .news-ticker-container {
            background: var(--bg-main-gradient); display: flex;
            border-radius: 6px; margin: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            overflow: hidden; border: 1px solid var(--border-color);
            transition: background 1.5s ease-in-out, border-color 1.5s ease-in-out;
        }

        .ticker-body { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; }

        body.theme-night .news-ticker-container, body.theme-predawn .news-ticker-container {
            background: var(--stars1), var(--stars2), var(--bg-main-gradient);
            background-repeat: repeat, repeat, no-repeat;
            background-size: 500px 500px, 800px 800px, 100% 100%;
        }

        .ticker-main-row { display: flex; align-items: stretch; flex-grow: 1; min-height: 110px; }
        .ticker-label { background-color: #2C3E50; color: #ECF0F1; padding: 0 15px 0 25px; display: flex; flex-direction: column; align-items: flex-start; justify-content: center; font-family: var(--font-display); border-right: 1px solid #444; min-width: 210px; flex-shrink: 0; position: relative; overflow: hidden; }
        
        #intro-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; z-index: 10; transform: scaleX(1); transition: transform 0.8s cubic-bezier(0.86, 0, 0.07, 1) 1.2s; }
        .color-bar { flex-grow: 1; }
        body.loaded #intro-overlay { transform: scaleX(0); transform-origin: left; }
        
        .label-content { opacity: 0; transform: translateY(20px); transition: none; }
        body.loaded .label-content { 
            opacity: 1; 
            transform: translateY(0);
            animation: content-glitch-in 1.2s cubic-bezier(0.7, 0, 0.3, 1) 2s both;
        }

        .ticker-label::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(200,200,200,0.15) 0%, rgba(200,200,200,0.1) 10%, transparent 30%), repeating-linear-gradient(transparent 0, rgba(0,0,0,0.1) 1px, transparent 2px);
            opacity: 0; z-index: 9; pointer-events: none; animation: static-move 0.15s steps(2) infinite;
        }

        body.loaded .ticker-label::before {
            animation: static-move 0.15s steps(2) infinite, static-fade-in-out 1.2s cubic-bezier(0.7, 0, 0.3, 1) 2s both;
        }

        .label-top-row { display: flex; align-items: center; gap: 8px; }
        .ticker-logo { width: 28px; height: 28px; flex-shrink: 0; stroke: #95A5A6; transition: width 0.4s ease, height 0.4s ease; }
        .ticker-logo.glitch-active { animation: glitch-logo 0.25s linear; }
        .brand-name.glitch-text-active { animation: glitch-text 0.3s linear; }
        body.night-mode-active .ticker-logo { width: 24px; height: 24px; }
        .brand-container { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.1; }
        .brand-name { font-size: 1.5rem; letter-spacing: 1px; font-weight: 400; color: #ECF0F1; }
        #night-shift-container { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 3px; width: 100%; }
        #night-shift-label { font-size: 0.85rem; font-weight: 500; color: var(--accent-gold); font-family: var(--font-body); }
        #night-mode-icon { color: var(--accent-gold); flex-shrink: 0; width: 16px; height: 16px; }
        #clock { font-family: var(--font-body); font-size: 0.9rem; font-weight: 500; color: var(--accent-main); letter-spacing: 0.5px; margin-top: 2px; background-color: rgba(0,0,0,0.2); padding: 1px 6px; border-radius: 4px; white-space: nowrap; transition: color 1.5s ease-in-out; }
        #clock .clock-colon { animation: blink 1.2s step-end infinite; }
        #nameday { font-size: 0.8rem; color: #95A5A6; margin-top: 3px; white-space: nowrap; display: none; width: 100%; text-align: center; padding: 0 5px; }

        #loading-indicator { position: absolute; z-index: 5; font-family: var(--font-display); font-size: 1rem; color: var(--accent-main); display: none; justify-content: center; align-items: center; width: 100%; }
        .dot { opacity: 0; animation: loading-dots 1s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        
        .ticker-wrap { flex-grow: 1; overflow: hidden; position: relative; min-width: 0; }
        .ticker-track { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out; will-change: opacity, transform; transform: translateY(10px); display: flex; align-items: center; justify-content: center; }
        .ticker-track.visible { opacity: 1; transform: translateY(0); }
        .ticker-content { position: relative; width: 100%; height: 100%; }

        .ticker-item { display: flex; flex-direction: column; align-items: flex-start; text-align: left; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); padding: 5px 15px; border-radius: 4px; position: absolute; top: 50%; left: 50%; width: 95%; height: 90%; justify-content: center; background-color: transparent; opacity: 0; visibility: hidden; /* When hiding, change visibility instantly AFTER the opacity transition */ transition: opacity 0.5s, visibility 0s linear 0.5s; transform: translate(-50%, -50%); }
        .ticker-item.visible { opacity: 1; visibility: visible; /* When showing, change visibility instantly and transition opacity */ transition: opacity 0.5s; animation: flip-in 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        .ticker-item.calendar-item, .ticker-item.quote-item { align-items: center; text-align: center; }
        
        .ticker-item.has-image { flex-direction: row; gap: 15px; align-items: center; }
        .ticker-item-image-container { width: 85px; height: 85px; flex-shrink: 0; overflow: hidden; border-radius: 5px; }
        .ticker-item-image { width: 100%; height: 100%; object-fit: cover; background-color: rgba(0,0,0,0.1); }
        .ticker-item-content-wrapper { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; height: 100%; justify-content: center; }
        .ticker-item.has-image .ticker-item-description { -webkit-line-clamp: 2; }
        
        .ticker-item-header { display: flex; align-items: center; margin-bottom: 4px; width: 100%; }
        .ticker-item .meta { color: var(--text-secondary); margin-right: 0.5rem; font-weight: 400; display: flex; align-items: center; white-space: nowrap; }
        .favicon-img { width: 16px; height: 16px; margin-right: 6px; border-radius: 3px; }
        .ticker-item .source { font-weight: 700; color: var(--accent-gold); }
        .ticker-item a { color: var(--text-primary); text-decoration: none; font-weight: 700; transition: all 0.3s, color 1.5s ease-in-out; width: 100%; }
        .ticker-item a:hover { color: var(--accent-main); }
        .ticker-item-description { font-size: 0.9rem; font-weight: 400; color: var(--text-secondary); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .ticker-item.breaking-highlight { font-weight: 700; color: var(--text-primary); animation: pulse-bg 2s infinite, flip-in 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        .ticker-item svg { width: 16px; height: 16px; margin-right: 10px; flex-shrink: 0; stroke-width: 2; }
        .ticker-item.news-intro-item, .ticker-item.calendar-item, .ticker-item.quote-item { color: var(--text-primary); transition: color 1.5s ease-in-out; }
        
        .announcement-item {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        .announcement-item .brand-name {
            font-size: 1.2rem;
            color: var(--text-primary);
        }
        .announcement-item .ticker-logo {
            width: 24px;
            height: 24px;
            stroke: var(--text-secondary);
        }
        .announcement-item p {
            font-size: 0.9rem;
            text-align: center;
            color: var(--text-secondary);
            max-width: 80%;
        }

        #breaking-indicator { position: absolute; top: 8px; left: 8px; width: 10px; height: 10px; background-color: #D32F2F; border-radius: 50%; display: none; border: 2px solid #2C3E50; box-shadow: 0 0 10px #D32F2F; z-index: 10; }
        #breaking-indicator.active { display: block; animation: pulse 1.5s infinite; }
        
        @keyframes glitch-logo { 20% { transform: translate(-1px, 1px); } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-1px, -1px); } 80% { transform: translate(1px, 1px); } 100% { transform: translate(0, 0); } }
        @keyframes glitch-text { 0%, 100% { text-shadow: 1px 1px 0 cyan, -1px -1px 0 red; } 25% { text-shadow: -1px -1px 0 cyan, 1px 1px 0 red; } 50% { text-shadow: 1px -1px 0 cyan, -1px 1px 0 red; } 75% { text-shadow: -1px 1px 0 cyan, 1px -1px 0 red; } }
        @keyframes static-move { 0% { background-position: 0 0; } 100% { background-position: 4px 6px; } }
        @keyframes static-fade-in-out { 0% { opacity: 0; } 10% { opacity: 0.8; } 85% { opacity: 0.6; } 100% { opacity: 0; } }
        @keyframes content-glitch-in { 0% { opacity: 0; transform: translateY(20px) scale(1.02); text-shadow: -2px -2px 0 red, 2px 2px 0 cyan; } 15% { opacity: 0.4; transform: translateY(18px) scale(1) skew(-3deg); text-shadow: 2px 2px 0 red, -2px -2px 0 cyan; } 30% { opacity: 0.1; transform: translateY(20px) scale(1.01) skew(3deg); } 45% { opacity: 0.7; transform: translateY(10px) scale(1) skew(0deg); text-shadow: 1px 1px 0 red, -1px -1px 0 cyan; } 60% { opacity: 0.5; transform: translateY(15px); } 85% { opacity: 0.9; transform: translateY(5px); text-shadow: none; } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes flip-in { 0% { transform: translate(-50%, -50%) perspective(600px) rotateY(90deg); opacity: 0; } 100% { transform: translate(-50%, -50%) perspective(600px) rotateY(0); opacity: 1; } }
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pulse { 0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }
        @keyframes pulse-bg { 0% { background-color: rgba(211, 47, 47, 0.1); } 50% { background-color: rgba(211, 47, 47, 0.25); } 100% { background-color: rgba(211, 47, 47, 0.1); } }
        @keyframes loading-dots { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes widget-fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .ticker-controls { min-height: 30px; height: auto; background-color: rgba(0,0,0,0.1); border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: flex-start; flex-wrap: nowrap; padding: 5px 15px; gap: 10px; transition: border-color 1.5s ease-in-out; }
        .control-group { display: flex; align-items: center; gap: 5px; }
        
        .central-controls {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            justify-content: center;
        }

        #filter-controls, #timeline-container {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
            padding-bottom: 2px; /* For focus outline */
        }
        #filter-controls::-webkit-scrollbar, #timeline-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .control-group-label { font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); transition: color 1.5s ease-in-out; white-space: nowrap; }
        .ticker-controls button { background-color: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); border-radius: 4px; padding: 2px 8px; font-family: var(--font-body); font-size: 0.8rem; cursor: pointer; transition: all 0.2s, color 1.5s ease-in-out, border-color 1.5s ease-in-out; text-transform: capitalize; display: flex; align-items: center; gap: 5px; }
        .ticker-controls button:hover { background-color: var(--text-secondary); color: #000; }
        .ticker-controls button.active { background-color: var(--accent-main); color: white; border-color: var(--accent-main); }
        .icon-button svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2.5; }
        #night-mode-message { font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); transition: color 1.5s ease-in-out; white-space: nowrap; margin-left: auto; }
        
        .nav-controls { display: flex; align-items: center; gap: 10px; }
        #news-counter {
            font-size: 0.8rem;
            font-weight: 700;
            font-family: var(--font-display);
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            transition: color 1.5s ease-in-out;
            padding: 2px 8px;
            border: 1px solid transparent; /* to maintain layout */
            border-radius: 4px;
        }

        #timeline-container {
            display: none;
            align-items: center;
            padding: 2px 0;
            width: 100%;
        }
        body.night-mode-active .central-controls {
            display: block;
        }

        body.night-mode-active #timeline-container { display: flex; }
        #timeline-container button {
            flex-shrink: 0;
            padding: 2px 6px;
            font-size: 0.75rem;
        }
        #timeline-container button.active-hour {
            background-color: var(--accent-gold);
            border-color: var(--accent-gold);
            color: #000;
        }


        /* --- DYNAMIC WEATHER WIDGET STYLES --- */
        #world-weather-container {
            flex-shrink: 0; width: 210px;
            border-left: 1px solid var(--border-color);
            padding: 8px 12px;
            display: flex; flex-direction: column; justify-content: center;
            backdrop-filter: blur(8px);
            background-size: cover;
            background-position: center;
            transition: background 1.2s ease-in-out, border-color 1.5s ease-in-out;
            position: relative;
        }
        #world-weather-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            z-index: 1;
        }
        
        .weather-bg-default { background: linear-gradient(145deg, #757F9A, #D7DDE8); }
        .weather-bg-sunny { background: linear-gradient(145deg, #56CCF2, #2F80ED); }
        .weather-bg-night-clear { background: linear-gradient(145deg, #0F2027, #203A43, #2C5364); }
        .weather-bg-cloudy { background: linear-gradient(145deg, #BDBDBD, #6c757d); }
        .weather-bg-rain { background: linear-gradient(145deg, #485563, #29323c); }
        .weather-bg-thunderstorm { background: linear-gradient(145deg, #232526, #414345); }
        .weather-bg-snow { background: linear-gradient(145deg, #E6DADA, #FFFFFF); }
        .weather-bg-fog { background: linear-gradient(145deg, #BCC1C6, #D8DBE0); }

        .weather-widget {
            animation: widget-fade-in 0.8s ease-in-out;
            display: flex;
            flex-direction: column;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        
        #world-weather-container .weather-widget,
        #world-weather-container .weather-widget .weather-time,
        #world-weather-container .weather-widget .weather-description,
        #world-weather-container .weather-widget .weather-details {
            color: #ffffff;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
        }

        .weather-header {
            text-align: center;
            margin-bottom: 4px;
        }
        .weather-location {
            font-size: 1.0rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .weather-time {
            font-size: 0.7rem;
            font-weight: 500;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
        }
        .weather-main-content {
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        .weather-main-icon svg {
            width: 48px;
            height: 48px;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5));
        }
        .weather-temp {
            font-family: var(--font-display);
            font-size: 2.2rem;
            line-height: 1;
        }
        .weather-description {
            font-size: 0.75rem;
            font-weight: 400;
            margin-top: 2px;
        }
        .weather-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            font-size: 0.7rem;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 5px;
            padding-top: 5px;
            opacity: 0.9;
        }
        .weather-detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-basis: 50%;
        }
        .weather-detail-item svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.6));
        }
        #world-weather-container .placeholder {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
            position: relative;
            z-index: 2;
        }
        
        /* --- REFRESH CLOCK STYLES --- */
        #refresh-overlay {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: absolute; top: 0; left: 0;
            z-index: 15; opacity: 0; visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        #refresh-overlay.visible { opacity: 1; visibility: visible; }
        .analog-clock {
            width: 80px; height: 80px;
            border: 3px solid #95A5A6;
            border-radius: 50%; position: relative;
        }
        .analog-clock .hand {
            position: absolute; left: 50%; bottom: 50%;
            background-color: #ECF0F1;
            transform-origin: bottom center;
            border-radius: 2px; z-index: 2;
        }
        .analog-clock .hour-hand { width: 3px; height: 25px; margin-left: -1.5px; }
        .analog-clock .minute-hand { width: 2px; height: 32px; margin-left: -1px; transition: transform 0.2s cubic-bezier(0.4, 1.8, 0.5, 0.75); }
        .analog-clock .second-hand { width: 1px; height: 35px; background-color: var(--accent-gold); margin-left: -0.5px; }
        .analog-clock .center-dot {
            position: absolute; top: 50%; left: 50%;
            width: 6px; height: 6px;
            background-color: var(--accent-gold);
            border-radius: 50%; transform: translate(-50%, -50%);
            z-index: 3;
        }
        #digital-clock-overlay {
            margin-top: 6px; font-family: var(--font-body);
            font-size: 0.8rem; font-weight: 700;
            color: #fff; background-color: rgba(0,0,0,0.4);
            padding: 1px 4px; border-radius: 3px;
            letter-spacing: 0.5px;
        }
        .refresh-text {
            margin-top: 4px; font-size: 0.8rem;
            font-family: var(--font-body); color: var(--accent-main);
            font-weight: 500;
        }
        
        @media (max-width: 950px) {
            .news-ticker-container { flex-direction: column; }
            .ticker-controls { flex-wrap: wrap; }
            #world-weather-container {
                width: 100%;
                border-left: none; border-top: 1px solid var(--border-color);
                padding: 10px 15px;
            }
            .weather-widget {
                flex-direction: row;
                align-items: center;
                justify-content: space-around;
                text-align: left;
            }
            .weather-main-content { order: 1; }
            .weather-details {
                order: 2; flex-direction: column;
                align-items: flex-start; border: none;
                margin: 0; padding: 0; gap: 5px;
            }
            .weather-header, .weather-description { display: none; }
        }
        @media (max-width: 768px) { .ticker-label { min-width: 180px; padding: 0 10px; } .brand-name { font-size: 1.3rem; } .ticker-controls { justify-content: flex-start; } #night-mode-message { text-align: left; } }
        @media (max-width: 520px) {
            .ticker-body { min-height: 155px; } .ticker-main-row { flex-direction: column; } .ticker-label { min-width: 100%; border-right: none; border-bottom: 1px solid #444; flex-direction: row; justify-content: space-between; padding: 5px 10px; } #clock { margin-top: 0; } #night-shift-label { font-size: 0.8rem; } .ticker-wrap { height: 105px; } .ticker-controls { padding: 8px 10px; } #night-mode-message { flex-basis: 100%; } .ticker-controls button span { display: none; } .icon-button { padding: 4px; }
            .weather-widget {
                flex-direction: column;
                text-align: center;
            }
             .weather-main-content, .weather-details { order: 0; }
             .weather-details { flex-direction: row; }
             .weather-header, .weather-description { display: block; }
        }
        @media (max-width: 380px) { .label-top-row { gap: 5px; } .brand-name { font-size: 1.1rem; } body.night-mode-active .ticker-logo { width: 20px; height: 20px; } .ticker-logo { width: 22px; height: 22px; } #clock { font-size: 0.8rem; } .control-group-label { display: none; } }
    </style>
</head>
<body>
    <section class="news-ticker-container">
        <div class="ticker-body">
            <div class="ticker-main-row">
                <div class="ticker-label" id="ticker-label">
                    <div id="intro-overlay">
                        <div class="color-bar" style="background-color: #c0c0c0;"></div> <div class="color-bar" style="background-color: #c0c000;"></div> <div class="color-bar" style="background-color: #00c0c0;"></div> <div class="color-bar" style="background-color: #00c000;"></div> <div class="color-bar" style="background-color: #c000c0;"></div> <div class="color-bar" style="background-color: #c00000;"></div> <div class="color-bar" style="background-color: #0000c0;"></div>
                    </div>
                    <div id="breaking-indicator"></div>
                    
                    <div id="refresh-overlay">
                        <div class="analog-clock">
                            <div class="hand hour-hand" id="hour-hand"></div>
                            <div class="hand minute-hand" id="minute-hand"></div>
                            <div class="hand second-hand" id="second-hand"></div>
                            <div class="center-dot"></div>
                        </div>
                        <div id="digital-clock-overlay">--:--:--</div>
                        <div class="refresh-text">Hírek frissítése...</div>
                    </div>

                    <div class="label-content">
                        <div class="label-top-row">
                            <svg class="ticker-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke-width="5"><circle cx="50" cy="50" r="45" /><ellipse cx="50" cy="50" rx="45" ry="18" /><path d="M50,5 C 30,30 30,70 50,95" /><path d="M50,5 C 70,30 70,70 50,95" /></svg>
                            <div class="brand-container">
                                <span class="brand-name">TKP NEWS</span>
                            </div>
                        </div>
                        <div id="clock">--.--.--. ------ --:--</div>
                        <div id="nameday"></div>
                        <div id="night-shift-container" style="display: none;">
                            <svg id="night-mode-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                            <span id="night-shift-label">Éjszakai műszak</span>
                        </div>
                    </div>
                </div>
                <div class="ticker-wrap" id="ticker-wrap">
                    <div id="ticker-a" class="ticker-track visible"><div class="ticker-content"></div></div>
                    <div id="ticker-b" class="ticker-track"><div class="ticker-content"></div></div>
                </div>
            </div>
            <div class="ticker-controls">
                <div class="control-group nav-controls">
                    <button id="prev-btn" title="Előző hír"><svg class="icon-button" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg><span>Előző</span></button>
                    <span id="news-counter" style="display: none;"></span>
                    <button id="next-btn" title="Következő hír"><svg class="icon-button" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg><span>Következő</span></button>
                </div>
                <div class="central-controls">
                    <div id="timeline-container"></div>
                    <div class="control-group" id="filter-control-group">
                        <span class="control-group-label">Szűrő:</span>
                        <div id="filter-controls"></div>
                    </div>
                </div>
                <span id="night-mode-message" style="display: none;"></span>
            </div>
        </div>
        <div id="world-weather-container">
            <div class="placeholder">Időjárás adatok betöltése...</div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        
        const firebaseConfig = { apiKey: "AIzaSyDgBgiNSxjgWP_jmaoHpf0Qejo8_OO4sPg", authDomain: "robi-oldala.firebaseapp.com", databaseURL: "https://robi-oldala-default-rtdb.europe-west1.firebasedatabase.app", projectId: "robi-oldala", storageBucket: "robi-oldala.appspot.com", messagingSenderId: "300815778397", appId: "1:300815778397:web:ec609be55cc8afd193c3b4" };
        const weatherComApiKey = 'e1f10a1e78da46f5b10a1e78da96f525';
        const CORS_PROXY = "https://corsproxy.io/?";
        const BREAKING_KEYWORDS = ['rendkívüli', 'fontos bejelentés', 'most érkezett', 'élőben', 'percről percre', 'breaking', 'rakétacsapás', 'háború'];
        
        const HUNGARIAN_CITIES = [ { name: 'Budapest', lat: 47.49, lon: 19.04 }, { name: 'Debrecen', lat: 47.53, lon: 21.62 }, { name: 'Szeged', lat: 46.25, lon: 20.14 }, { name: 'Miskolc', lat: 48.10, lon: 20.79 }, { name: 'Pécs', lat: 46.07, lon: 18.23 }, { name: 'Győr', lat: 47.68, lon: 17.63 }, { name: 'Kecskemét', lat: 46.90, lon: 19.69 }, { name: 'Székesfehérvár', lat: 47.19, lon: 18.41 }, { name: 'Szombathely', lat: 47.23, lon: 16.62 }, { name: 'Szolnok', lat: 47.17, lon: 20.19 }, { name: 'Tatabánya', lat: 47.58, lon: 18.39 }, { name: 'Kaposvár', lat: 46.36, lon: 17.78 }, { name: 'Érd', lat: 47.38, lon: 18.92 }, { name: 'Veszprém', lat: 47.09, lon: 17.90 }, { name: 'Békéscsaba', lat: 46.68, lon: 21.09 }, { name: 'Zalaegerszeg', lat: 46.84, lon: 16.84 }, { name: 'Sopron', lat: 47.68, lon: 16.59 }, { name: 'Eger', lat: 47.90, lon: 20.37 }, { name: 'Nagykanizsa', lat: 46.45, lon: 16.99 }, { name: 'Dunaújváros', lat: 46.96, lon: 18.93 }, { name: 'Hódmezővásárhely', lat: 46.43, lon: 20.32 }, { name: 'Salgótarján', lat: 48.09, lon: 19.79 }, { name: 'Ózd', lat: 48.22, lon: 20.29 }, { name: 'Cegléd', lat: 47.17, lon: 19.79 }, { name: 'Baja', lat: 46.18, lon: 18.95 }, { name: 'Vác', lat: 47.77, lon: 19.13 }, { name: 'Szekszárd', lat: 46.35, lon: 18.70 }, { name: 'Pápa', lat: 47.33, lon: 17.46 }, { name: 'Gyöngyös', lat: 47.78, lon: 19.92 }, { name: 'Kazincbarcika', lat: 48.25, lon: 20.63 }, { name: 'Gödöllő', lat: 47.59, lon: 19.35 }, { name: 'Siófok', lat: 46.90, lon: 18.05 }, { name: 'Esztergom', lat: 47.78, lon: 18.74 }, { name: 'Keszthely', lat: 46.76, lon: 17.24 } ];
        const FOREIGN_CITIES = [ { name: 'London', lat: 51.50, lon: -0.12 }, { name: 'New York', lat: 40.71, lon: -74.00 }, { name: 'Tokió', lat: 35.68, lon: 139.69 }, { name: 'Sydney', lat: -33.86, lon: 151.20 }, { name: 'Párizs', lat: 48.85, lon: 2.35 }, { name: 'Berlin', lat: 52.52, lon: 13.40 }, { name: 'Róma', lat: 41.90, lon: 12.49 }, { name: 'Moszkva', lat: 55.75, lon: 37.61 }, { name: 'Peking', lat: 39.90, lon: 116.40 }, { name: 'Kairó', lat: 30.04, lon: 31.23 }, { name: 'Rio de Janeiro', lat: -22.90, lon: -43.17 }, { name: 'Los Angeles', lat: 34.05, lon: -118.24 }, { name: 'Bécs', lat: 48.20, lon: 16.37 }, { name: 'Pozsony', lat: 48.14, lon: 17.10 }, { name: 'Prága', lat: 50.07, lon: 14.43 }, { name: 'Madrid', lat: 40.41, lon: -3.70 }, { name: 'Toronto', lat: 43.65, lon: -79.38 }, { name: 'Buenos Aires', lat: -34.60, lon: -58.38 }, { name: 'Dubai', lat: 25.20, lon: 55.27 }, { name: 'Sanghaj', lat: 31.23, lon: 121.47 }, { name: 'Isztambul', lat: 41.00, lon: 28.97 }, { name: 'Bangkok', lat: 13.75, lon: 100.50 }, { name: 'Mexikóváros', lat: 19.43, lon: -99.13 }, { name: 'Zágráb', lat: 45.81, lon: 15.98 }, { name: 'Varsó', lat: 52.22, lon: 21.01 }, { name: 'Stockholm', lat: 59.32, lon: 18.06 }, { name: 'Oslo', lat: 59.91, lon: 10.75 }, { name: 'Helsinki', lat: 60.16, lon: 24.93 }, { name: 'Koppenhága', lat: 55.67, lon: 12.56 }, { name: 'Amszterdam', lat: 52.36, lon: 4.89 } ];
        const CATEGORY_KEYWORDS = { belföld: ['belföld', 'magyar', 'budapest', 'kormány', 'parlament', 'rendőrség', 'tüntetés', 'forint', 'belügy', 'oktatás'], külföld: ['külföld', 'ukrajna', 'oroszország', 'brüsszel', 'háború', 'európa', 'amerika', 'kína', 'gáza', 'izrael', 'NATO'], gazdaság: ['gazdaság', 'forint', 'euró', 'infláció', 'tőzsde', 'mnb', 'költségvetés', 'adó', 'piac'], sport: ['sport', 'foci', 'nb1', 'bajnokok ligája', 'forma-1', 'olimpia', 'kézilabda', 'vízilabda', ' FTC', 'válogatott', 'meccs'], tech: ['tech', 'tudomány', 'mobil', 'apple', 'google', 'mesterséges intelligencia', 'űrkutatás', 'innováció', 'AI', 'elon musk'], 'kékfény': ['kékfény', 'rendőrség', 'baleset', 'bűncselekmény', 'tűz', 'katasztrófa', 'ítélet', 'nyomozás'] };
        const QUOTES = [ "A legjobb módja a jövő megjóslásának, ha feltaláljuk.", "Az egyetlen korlátot a valóság megteremtésében a képzeletünk szabja.", "A siker nem végleges, a kudarc nem végzetes: a folytatáshoz való bátorság az, ami számít." ];
        const ICON_CALENDAR = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`;
        const ICON_NEWS = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`;
        const ICON_ANNOUNCEMENT = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
        const CALENDAR_DATA = { honapok: ["január", "február", "március", "április", "május", "június", "július", "augusztus", "szeptember", "október", "november", "december"], napok: ["vasárnap", "hétfő", "kedd", "szerda", "csütörtök", "péntek", "szombat"], nameDays: { "01-01": ["Fruzsina"], "01-02": ["Ábel"], "01-03": ["Benjámin", "Genovéva"], "01-04": ["Leóna", "Titusz"], "01-05": ["Simon"],"01-06": ["Boldizsár"], "01-07": ["Attila", "Ramóna"], "01-08": ["Gyöngyvér"], "01-09": ["Marcell"], "01-10": ["Melánia"],"01-11": ["Ágota"], "01-12": ["Ernő"], "01-13": ["Veronika"], "01-14": ["Bódog"], "01-15": ["Lóránd", "Lóránt"],"01-16": ["Gusztáv"], "01-17": ["Antal", "Antónia"], "01-18": ["Piroska"], "01-19": ["Márió", "Sára"], "01-20": ["Fábián", "Sebestyén"],"01-21": ["Ágnes"], "01-22": ["Artúr", "Vince"], "01-23": ["Rajmund", "Zelma"], "01-24": ["Timót"], "01-25": ["Pál"],"01-26": ["Paula", "Vanda"], "01-27": ["Angelika"], "01-28": ["Karola", "Károly"], "01-29": ["Adél"], "01-30": ["Martina"], "01-31": ["Gerda", "Marcella"],"02-01": ["Ignác"], "02-02": ["Aida", "Karolina"], "02-03": ["Balázs"], "02-04": ["Csenge", "Ráhel"], "02-05": ["Ágota", "Ingrid"],"02-06": ["Dóra", "Dorottya"], "02-07": ["Rómeó", "Tódor"], "02-08": ["Aranka"], "02-09": ["Abigél", "Alex"], "02-10": ["Elvira"],"02-11": ["Bertold", "Marietta"], "02-12": ["Lídia", "Lívia"], "02-13": ["Ella", "Linda"], "02-14": ["Bálint", "Valentin"],"02-15": ["Georgina", "Kolos"], "02-16": ["Julianna", "Lilla"], "02-17": ["Donát"], "02-18": ["Bernadett"], "02-19": ["Zsuzsanna"],"02-20": ["Aladár", "Álmos"], "02-21": ["Eleonóra"], "02-22": ["Gerzson"], "02-23": ["Alfréd"], "02-24": ["Mátyás"],"02-25": ["Géza"], "02-26": ["Edina"], "02-27": ["Ákos", "Bátor"], "02-28": ["Elemér"], "02-29": ["Szökőnap"],"03-01": ["Albin"], "03-02": ["Lujza"], "03-03": ["Kornélia"], "03-04": ["Kázmér"], "03-05": ["Adorján", "Adrián"],"03-06": ["Inez", "Leonóra"], "03-07": ["Tamás"], "03-08": ["Zoltán"], "03-09": ["Fanni", "Franciska"], "03-10": ["Ildikó"],"03-11": ["Szilárd"], "03-12": ["Gergely"], "03-13": ["Ajtony", "Krisztián"], "03-14": ["Matild"], "03-15": ["Kristóf"],"03-16": ["Henrietta"], "03-17": ["Gertrúd", "Patrik"], "03-18": ["Ede", "Sándor"], "03-19": ["Bánk", "József"], "03-20": ["Klaudia"],"03-21": ["Benedek"], "03-22": ["Beáta", "Izolda"], "03-23": ["Emőke"], "03-24": ["Gábor", "Karina"], "03-25": ["Irén", "Írisz"],"03-26": ["Emánuel"], "03-27": ["Hajnalka"], "03-28": ["Gedeon", "Johanna"], "03-29": ["Auguszta"], "03-30": ["Zalán"], "03-31": ["Árpád"],"04-01": ["Hugó"], "04-02": ["Áron"], "04-03": ["Buda", "Richárd"], "04-04": ["Izidor"], "04-05": ["Vince"], "04-06": ["Bíborka", "Vilmos"],"04-07": ["Herman"], "04-08": ["Dénes"], "04-09": ["Erhard"], "04-10": ["Zsolt"], "04-11": ["Leó", "Szaniszló"], "04-12": ["Gyula"],"04-13": ["Ida"], "04-14": ["Tibor"], "04-15": ["Anasztázia", "Tas"], "04-16": ["Csongor"], "04-17": ["Rudolf"],"04-18": ["Andrea", "Ilma"], "04-19": ["Emma"], "04-20": ["Tivadar"], "04-21": ["Konrád"], "04-22": ["Csilla", "Noémi"],"04-23": ["Béla"], "04-24": ["György"], "04-25": ["Márk"], "04-26": ["Ervin"], "04-27": ["Zita"], "04-28": ["Valéria"],"04-29": ["Péter"], "04-30": ["Katalin", "Kitti"],"05-01": ["Fülöp", "Jakab"], "05-02": ["Zsigmond"], "05-03": ["Irma", "Tímea"], "05-04": ["Flórián", "Mónika"], "05-05": ["Adrián", "Györgyi"],"05-06": ["Frida", "Ivett"], "05-07": ["Gizella"], "05-08": ["Mihály"], "05-09": ["Gergely"], "05-10": ["Ármin", "Pálma"],"05-11": ["Ferenc"], "05-12": ["Pongrác"], "05-13": ["Imola", "Szervác"], "05-14": ["Bonifác"], "05-15": ["Szonja", "Zsófia"],"05-16": ["Botond", "Mózes"], "05-17": ["Paszkál"], "05-18": ["Alexandra", "Erik"], "05-19": ["Ivó", "Milán"], "05-20": ["Bernát", "Felícia"],"05-21": ["Konstantin"], "05-22": ["Júlia", "Rita"], "05-23": ["Dezső"], "05-24": ["Eliza", "Eszter"], "05-25": ["Orbán"],"05-26": ["Evelin", "Fülöp"], "05-27": ["Hella"], "05-28": ["Csanád", "Emil"], "05-29": ["Magdolna"], "05-30": ["Janka", "Zsanett"], "05-31": ["Angéla"],"06-01": ["Tünde"], "06-02": ["Anita", "Kármen"], "06-03": ["Klotild"], "06-04": ["Bulcsú"], "06-05": ["Fatime"], "06-06": ["Cintia", "Norbert"],"06-07": ["Róbert"], "06-08": ["Medárd"], "06-09": ["Félix"], "06-10": ["Gréta", "Margit"], "06-11": ["Barnabás"], "06-12": ["Villő"],"06-13": ["Anett", "Antal"], "06-14": ["Vazul"], "06-15": ["Jolán", "Vid"], "06-16": ["Jusztin"], "06-17": ["Alida", "Laura"],"06-18": ["Arnold", "Levente"], "06-19": ["Gyárfás"], "06-20": ["Rafael"], "06-21": ["Alajos", "Leila"], "06-22": ["Paulina"],"06-23": ["Zoltán"], "06-24": ["Iván"], "06-25": ["Vilmos"], "06-26": ["János", "Pál"], "06-27": ["László"], "06-28": ["Irén", "Levente"],"06-29": ["Péter", "Pál"], "06-30": ["Pál"],"07-01": ["Annamária", "Tihamér"], "07-02": ["Ottó"], "07-03": ["Kornél", "Soma"], "07-04": ["Ulrik"], "07-05": ["Emese", "Sarolta"],"07-06": ["Csaba"], "07-07": ["Apollónia"], "07-08": ["Ellák"], "07-09": ["Lukrécia"], "07-10": ["Amália"], "07-11": ["Lili", "Nóra"],"07-12": ["Dalma", "Izabella"], "07-13": ["Jenő"], "07-14": ["Örs", "Stella"], "07-15": ["Henrik", "Roland"], "07-16": ["Valter"],"07-17": ["Elek", "Endre"], "07-18": ["Frigyes"], "07-19": ["Emília"], "07-20": ["Illés"], "07-21": ["Dániel", "Daniella"],"07-22": ["Magdolna"], "07-23": ["Lenke"], "07-24": ["Kincső", "Kinga"], "07-25": ["Jakab", "Kristóf"], "07-26": ["Anikó", "Anna"],"07-27": ["Liliána", "Olga"], "07-28": ["Szabolcs"], "07-29": ["Flóra", "Márta"], "07-30": ["Judit", "Xénia"], "07-31": ["Oszkár"],"08-01": ["Boglárka"], "08-02": ["Lehel"], "08-03": ["Hermina"], "08-04": ["Dominika", "Dominik", "Domonkos"], "08-05": ["Krisztina"],"08-06": ["Berta", "Bettina"], "08-07": ["Ibolya"], "08-08": ["László"], "08-09": ["Emőd"], "08-10": ["Lőrinc"],"08-11": ["Tiborc", "Zsuzsanna"], "08-12": ["Klára"], "08-13": ["Ipoly"], "08-14": ["Marcell"], "08-15": ["Mária"],"08-16": ["Ábrahám"], "08-17": ["Jácint"], "08-18": ["Ilona"], "08-19": ["Huba"], "08-20": ["István"],"08-21": ["Hajna", "Sámuel"], "08-22": ["Menyhért", "Mirjam"], "08-23": ["Bence"], "08-24": ["Bertalan"], "08-25": ["Lajos", "Patrícia"],"08-26": ["Izsó"], "08-27": ["Gáspár"], "08-28": ["Ágoston"], "08-29": ["Beatrix", "Erna"], "08-30": ["Rózsa"], "08-31": ["Bella", "Erika"],"09-01": ["Egon", "Egyed"], "09-02": ["Dorina", "Rebeka"], "09-03": ["Hilda"], "09-04": ["Rozália"], "09-05": ["Lőrinc", "Viktor"],"09-06": ["Zakariás"], "09-07": ["Regina"], "09-08": ["Adrienn", "Mária"], "09-09": ["Ádám"], "09-10": ["Hunor", "Nikolett"],"09-11": ["Teodóra"], "09-12": ["Mária"], "09-13": ["Kornél"], "09-14": ["Roxána", "Szeréna"], "09-15": ["Enikő", "Melitta"],"09-16": ["Edit"], "09-17": ["Zsófia"], "09-18": ["Diána"], "09-19": ["Vilhelmina"], "09-20": ["Friderika"], "09-21": ["Máté", "Mirella"],"09-22": ["Móric"], "09-23": ["Tekla"], "09-24": ["Gellért", "Mercédesz"], "09-25": ["Eufrozina", "Kende"], "09-26": ["Jusztina", "Pál"],"09-27": ["Adalbert"], "09-28": ["Vencel"], "09-29": ["Mihály"], "09-30": ["Jeromos"],"10-01": ["Malvin"], "01-02": ["Petra"], "10-03": ["Helga"], "10-04": ["Ferenc"], "10-05": ["Aurél"], "10-06": ["Brúnó", "Renáta"],"10-07": ["Amália"], "10-08": ["Koppány"], "10-09": ["Dénes"], "10-10": ["Gedeon"], "10-11": ["Brigitta"], "10-12": ["Miksa"],"10-13": ["Ede", "Kálmán"], "10-14": ["Helén"], "10-15": ["Teréz"], "10-16": ["Gál"], "10-17": ["Hedvig"], "10-18": ["Lukács"],"09-19": ["Nándor"], "10-20": ["Vendel"], "10-21": ["Orsolya"], "10-22": ["Előd"], "10-23": ["Gyöngyi"], "10-24": ["Salamon"],"10-25": ["Bianka", "Blanka"], "10-26": ["Dömötör"], "10-27": ["Szabina"], "10-28": ["Simon", "Szimonetta"], "10-29": ["Nárcisz"],"10-30": ["Alfonz"], "10-31": ["Farkas"],"11-01": ["Marianna"], "11-02": ["Achilles"], "11-03": ["Győző"], "11-04": ["Károly"], "11-05": ["Imre"], "11-06": ["Lénárd"],"11-07": ["Rezső"], "11-08": ["Zsombor"], "11-09": ["Tivadar"], "11-10": ["Réka"], "11-11": ["Márton"], "11-12": ["Jónás", "Renátó"],"11-13": ["Szilvia"], "11-14": ["Aliz"], "11-15": ["Albert", "Lipót"], "11-16": ["Ödön"], "11-17": ["Gergely", "Hortenzia"],"11-18": ["Jenő"], "11-19": ["Erzsébet", "Elizabet"], "11-20": ["Jolán"], "11-21": ["Olivér"], "11-22": ["Cecília"],"11-23": ["Kelemen", "Klementina"], "11-24": ["Emma"], "11-25": ["Katalin"], "11-26": ["Virág"], "11-27": ["Virgil"],"11-28": ["Stefánia"], "11-29": ["Taksony"], "11-30": ["Andor", "András"],"12-01": ["Elza"], "12-02": ["Melinda", "Vivien"], "12-03": ["Ferenc", "Olívia"], "12-04": ["Barbara", "Borbála"], "12-05": ["Vilma"],"12-06": ["Miklós"], "12-07": ["Ambrus"], "12-08": ["Mária"], "12-09": ["Natália"], "12-10": ["Judit"], "12-11": ["Árpád"],"12-12": ["Gabriella"], "12-13": ["Luca", "Otília"], "12-14": ["Szilárda"], "12-15": ["Valér"], "12-16": ["Aletta", "Etelka"],"12-17": ["Lázár", "Olimpia"], "12-18": ["Auguszta"], "12-19": ["Viola"], "12-20": ["Teofil"], "12-21": ["Tamás"],"12-22": ["Zénó"], "12-23": ["Viktória"], "12-24": ["Ádám", "Éva"], "12-25": ["Eugénia"], "12-26": ["István"],"12-27": ["János"], "12-28": ["Kamilla"], "12-29": ["Tamara", "Tamás"], "12-30": ["Dávid"], "12-31": ["Szilveszter"] } };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const feedsRef = ref(database, 'feeds');
        const announcementsRef = ref(database, 'announcements');

        HUNGARIAN_CITIES.sort((a, b) => a.name.localeCompare(b.name, 'hu'));
        FOREIGN_CITIES.sort((a, b) => a.name.localeCompare(b.name, 'hu'));

        const tracks = { a: document.getElementById('ticker-a'), b: document.getElementById('ticker-b') };
        const tickerWrap = document.getElementById('ticker-wrap');
        const breakingIndicator = document.getElementById('breaking-indicator');
        const filterControls = document.getElementById('filter-controls');
        const bodyEl = document.body;
        const filterControlGroup = document.getElementById('filter-control-group');
        const nightModeMessage = document.getElementById('night-mode-message');
        const nightShiftContainer = document.getElementById('night-shift-container');
        const worldWeatherContainer = document.getElementById('world-weather-container');
        const tickerLogo = document.querySelector('.ticker-logo');
        const brandNameEl = document.querySelector('.brand-name');
        const nameDayEl = document.getElementById('nameday');
        const labelContent = document.querySelector('.label-content');
        const refreshOverlay = document.getElementById('refresh-overlay');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const newsCounter = document.getElementById('news-counter');
        const timelineContainer = document.getElementById('timeline-container');


        let activeTrackKey = 'a', rssFeeds = {}, customAnnouncements = [], updateTimeout = null, debounceTimeout = null;
        let activeFilter = 'all';
        let currentMode = new Date().getHours() < 6 ? 'summary' : 'normal';
        let newsFetchRetryTimeout = null;
        let masterNewsList = [];
        let chunkLoadTimeout = null;
        const CHUNK_SIZE = 40;

        let flipTimeoutId = null, currentItemIndex = 0, flipStartTime = 0, flipRemainingTime = 0;
        const FLIP_INTERVAL_REGULAR = 15000;
        const FLIP_INTERVAL_INFO = 5000;
        const FLIP_INTERVAL_ANNOUNCEMENT = 15000;

        let weatherDisplayInterval = null, weatherFetchInterval = null;
        let domesticWeatherCache = [], foreignWeatherDataCache = [];
        let domesticWeatherIndex = 0, foreignWeatherIndex = 0;
        let isDisplayingDomestic = true;
        const WEATHER_DISPLAY_INTERVAL_DURATION = 8000;
        
        let logoGlitchTimeout = null;
        let textGlitchTimeout = null;
        let lastUpdateMinute = -1;
        let lastAnnouncementHour = -1;
        
        let analogClockInterval = null;
        let refreshAnimationTriggeredForMinute = -1;
        let fetchStartTime = 0;
        let loadingTimeout = null;
        let isInfoMessageActive = false;

        const stripHtml = (html) => { let doc = new DOMParser().parseFromString(html, 'text/html'); return doc.body.textContent || ""; };
        
        const getSmartDescription = (text, maxLength = 220) => {
            if (!text || text.length <= maxLength) return text;
            let truncated = text.substring(0, maxLength);
            let lastPunctuation = Math.max(truncated.lastIndexOf('.'), truncated.lastIndexOf('!'), truncated.lastIndexOf('?'));
            if (lastPunctuation > maxLength / 2) { return truncated.substring(0, lastPunctuation + 1); }
            let lastSpace = truncated.lastIndexOf(' ');
            return truncated.substring(0, lastSpace > 0 ? lastSpace : maxLength) + '...';
        };

        const extractImageUrl = (item, fullDescriptionHtml) => {
            const mediaContent = item.querySelector('media\\:content, content');
            if (mediaContent && mediaContent.getAttribute('medium') === 'image' && mediaContent.getAttribute('url')) { return mediaContent.getAttribute('url'); }
            if (mediaContent && /\.(jpg|jpeg|png|webp)$/i.test(mediaContent.getAttribute('url'))) { return mediaContent.getAttribute('url'); }
            const enclosure = item.querySelector('enclosure');
            if (enclosure && enclosure.getAttribute('type')?.startsWith('image') && enclosure.getAttribute('url')) { return enclosure.getAttribute('url'); }
            try {
                const doc = new DOMParser().parseFromString(fullDescriptionHtml, 'text/html');
                const img = doc.querySelector('img');
                if (img && img.src) { return img.src; }
            } catch (e) { /* Parsing might fail */ }
            return null;
        };
        
        const getWeatherIcon = (code) => {
            const icons = {
                'default': `<svg viewBox="0 0 64 64"><circle cx="32" cy="32" r="32" fill="#42a5f5"/><path fill="#fff" d="M47.7,27.9c-0.5-5.2-4.9-9.3-10.2-9.3c-4.6,0-8.6,3.1-9.9,7.4c-3.9,0.4-7,3.8-7,7.9c0,4.4,3.6,8,8,8h19.5c3.7,0,6.7-3,6.7-6.7C54.4,31.2,51.5,28.2,47.7,27.9z"/><path fill="rgba(0,0,0,0.2)" d="M47.3,30.3l-24-24L12.1,17.5l24,24L47.3,30.3z"/></svg>`,
                'sunny': `<svg viewBox="0 0 64 64"><g><circle cx="32" cy="32" r="13" fill="#FFC107"/><path fill="#FFC107" d="M32 15.3c-1.1 0-2-0.9-2-2v-5c0-1.1.9-2 2-2s2 .9 2 2v5c0 1.1-.9 2-2 2z"/><path fill="#FFC107" d="M32 55.7c-1.1 0-2-0.9-2-2v-5c0-1.1.9-2 2-2s2 .9 2 2v5c0 1.1-.9 2-2 2z"/><path fill="#FFC107" d="M15.3 34H10c-1.1 0-2-0.9-2-2s.9-2 2-2h5.3c1.1 0 2 .9 2 2s-.9 2-2 2z"/><path fill="#FFC107" d="M54 34h-5.3c-1.1 0-2-0.9-2-2s.9-2 2-2H54c1.1 0 2 .9 2 2s-.9 2-2 2z"/><path fill="#FFC107" d="M19.4 20.8c-.5 0-1-.2-1.4-.6l-3.8-3.8c-.8-.8-.8-2 0-2.8.8-.8 2-.8 2.8 0l3.8 3.8c.8.8.8 2 0 2.8-.4.4-.9.6-1.4.6z"/><path fill="#FFC107" d="M44.6 46c-.5 0-1-.2-1.4-.6l-3.8-3.8c-.8-.8-.8-2 0-2.8.8-.8 2-.8 2.8 0l3.8 3.8c.8.8.8 2 0 2.8-.4.4-.9.6-1.4.6z"/><path fill="#FFC107" d="M13.8 51.6c-.5 0-1-.2-1.4-.6-.8-.8-.8-2 0-2.8l3.8-3.8c.8-.8 2-.8 2.8 0 .8.8.8 2 0 2.8l-3.8 3.8c-.4.4-.9.6-1.4.6z"/><path fill="#FFC107" d="M49.2 25.6c-.5 0-1-.2-1.4-.6l-3.8-3.8c-.8-.8-.8-2 0-2.8.8-.8 2-.8 2.8 0l3.8 3.8c.8.8.8 2 0 2.8-.4.4-.9.6-1.4.6z"/></g></svg>`,
                'night-clear': `<svg viewBox="0 0 64 64"><path fill="#FFC107" d="M42.3,49.8C28.2,49.8,17,38.6,17,24.5c0-6.5,2.4-12.4,6.4-16.9c0.8-0.8,2.1-0.9,2.9-0.1c0.8,0.8,0.9,2.1,0.1,2.9 c-3.2,3.6-5.1,8.3-5.1,13.5c0,11.2,9.1,20.3,20.3,20.3c5.8,0,11.1-2.4,14.8-6.4c0.8-0.8,2.1-0.7,2.9,0.1c0.8,0.8,0.7,2.1-0.1,2.9 C54.2,46.9,48.5,49.8,42.3,49.8z"/></svg>`,
                'partly-cloudy-day': `<svg viewBox="0 0 64 64"><path fill="rgba(0,0,0,0.2)" d="M46.7,33.1L20.5,7L9.3,18.2L35.5,44.3L46.7,33.1z"/><path fill="#fff" d="M46.7,27.9c-0.5-5.2-4.9-9.3-10.2-9.3c-2.4,0-4.6,0.8-6.4,2.2c-0.6-5-4.8-8.8-9.9-8.8c-5.5,0-10,4.5-10,10c0,0.9,0.1,1.8,0.4,2.7c-3,1.2-5,4.2-5,7.7c0,4.6,3.7,8.3,8.3,8.3h32.7c3.7,0,6.7-3,6.7-6.7C53.4,31.2,50.4,28.2,46.7,27.9z"/><circle cx="21.5" cy="22" r="8.5" fill="#FFC107"/></svg>`,
                'partly-cloudy-night': `<svg viewBox="0 0 64 64"><path fill="rgba(0,0,0,0.2)" d="M48.2,34.1L22,7.9L10.8,19.1l26.2,26.2L48.2,34.1z"/><path fill="#fff" d="M48.2,30.3c-0.5-5.2-4.9-9.3-10.2-9.3c-3.5,0-6.6,1.8-8.5,4.5c-0.4-4.8-4.4-8.5-9.3-8.5c-5.2,0-9.4,4.2-9.4,9.4c0,0.9,0.1,1.7,0.4,2.5c-2.8,1.1-4.7,3.9-4.7,7.2c0,4.3,3.5,7.8,7.8,7.8h30.8c3.5,0,6.3-2.8,6.3-6.3C54.5,33.4,51.8,30.6,48.2,30.3z"/><path fill="#FFC107" d="M26.4 35.8c-5.1 0-9.2-4.1-9.2-9.2 0-3.4 1.9-6.5 4.7-8.1.8-.5 1-1.6.5-2.4s-1.6-1-2.4-.5c-3.7 2.1-6.2 6.1-6.2 10.9 0 6.9 5.6 12.5 12.5 12.5 5.3 0 9.9-3.3 11.8-8 .5-1.1-.1-2.4-1.2-2.8s-2.4.1-2.8 1.2c-1.4 3.4-4.7 5.8-8.5 5.8z"/></svg>`,
                'cloudy': `<svg viewBox="0 0 64 64"><path fill="#fff" d="M47.7,27.9c-0.5-5.2-4.9-9.3-10.2-9.3c-4.6,0-8.6,3.1-9.9,7.4c-3.9,0.4-7,3.8-7,7.9c0,4.4,3.6,8,8,8h19.5c3.7,0,6.7-3,6.7-6.7C54.4,31.2,51.5,28.2,47.7,27.9z"/><path fill="rgba(0,0,0,0.2)" d="M47.3,30.3l-24-24L12.1,17.5l24,24L47.3,30.3z"/></svg>`,
                'rain': `<svg viewBox="0 0 64 64"><path fill="rgba(0,0,0,0.2)" d="M47.3,30.3l-24-24L12.1,17.5l24,24L47.3,30.3z"/><path fill="#fff" d="M47.7,27.9c-0.5-5.2-4.9-9.3-10.2-9.3c-4.6,0-8.6,3.1-9.9,7.4c-3.9,0.4-7,3.8-7,7.9c0,4.4,3.6,8,8,8h19.5c3.7,0,6.7-3,6.7-6.7C54.4,31.2,51.5,28.2,47.7,27.9z"/><g fill="#42a5f5"><circle cx="24.3" cy="51.8" r="3"/><circle cx="32.3" cy="51.8" r="3"/><circle cx="40.3" cy="51.8" r="3"/></g></svg>`,
                'thunderstorm': `<svg viewBox="0 0 64 64"><path fill="rgba(0,0,0,0.2)" d="M47.3,30.3l-24-24L12.1,17.5l24,24L47.3,30.3z"/><path fill="#fff" d="M47.7,27.9c-0.5-5.2-4.9-9.3-10.2-9.3c-4.6,0-8.6,3.1-9.9,7.4c-3.9,0.4-7,3.8-7,7.9c0,4.4,3.6,8,8,8h19.5c3.7,0,6.7-3,6.7-6.7C54.4,31.2,51.5,28.2,47.7,27.9z"/><path fill="#FFC107" d="M36.1,43.2l-7.3,7.3c-0.4,0.4-1,0.4-1.4,0l0,0c-0.4-0.4-0.4-1,0-1.4l7.3-7.3c0.4-0.4,1-0.4,1.4,0l0,0C36.5,42.2,36.5,42.8,36.1,43.2z M32,46.1l-4.2,4.2c-0.4,0.4-1,0.4-1.4,0l0,0c-0.4-0.4-0.4-1,0-1.4l4.2-4.2c0.4-0.4,1-0.4,1.4,0l0,0C32.4,45.1,32.4,45.7,32,46.1z M34.8,40.4L28,47.2c-0.4,0.4-1,0.4-1.4,0l0,0c-0.4-0.4-0.4-1,0-1.4l6.8-6.8c0.4-0.4,1-0.4,1.4,0l0,0C35.2,39.4,35.2,40,34.8,40.4z"/></svg>`,
                'snow': `<svg viewBox="0 0 64 64"><path fill="rgba(0,0,0,0.2)" d="M47.3,30.3l-24-24L12.1,17.5l24,24L47.3,30.3z"/><path fill="#fff" d="M47.7,27.9c-0.5-5.2-4.9-9.3-10.2-9.3c-4.6,0-8.6,3.1-9.9,7.4c-3.9,0.4-7,3.8-7,7.9c0,4.4,3.6,8,8,8h19.5c3.7,0,6.7-3,6.7-6.7C54.4,31.2,51.5,28.2,47.7,27.9z"/><g fill="#fff"><path d="M24,53.5h-1.8v-5.4H24V53.5z M25.8,50.8h-5.4v-1.8h5.4V50.8z"/><path d="M32.8,53.5h-1.8v-5.4h1.8V53.5z M34.5,50.8h-5.4v-1.8h5.4V50.8z"/><path d="M41.5,53.5h-1.8v-5.4h1.8V53.5z M43.2,50.8h-5.4v-1.8h5.4V50.8z"/><path d="M22.2,48.1l1.3,1.3l-3.8,3.8l-1.3-1.3L22.2,48.1z M22.2,51.9l-3.8-3.8l1.3-1.3l3.8,3.8L22.2,51.9z"/><path d="M30.9,48.1l1.3,1.3l-3.8,3.8l-1.3-1.3L30.9,48.1z M30.9,51.9l-3.8-3.8l1.3-1.3l3.8,3.8L30.9,51.9z"/><path d="M39.7,48.1l1.3,1.3l-3.8,3.8l-1.3-1.3L39.7,48.1z M39.7,51.9l-3.8-3.8l1.3-1.3l3.8,3.8L39.7,51.9z"/></g></svg>`,
                'fog': `<svg viewBox="0 0 64 64"><path fill="#fff" d="M19,34h26c1.1,0,2-0.9,2-2s-0.9-2-2-2H19c-1.1,0-2,0.9-2,2S17.9,34,19,34z M13,26h38c1.1,0,2-0.9,2-2s-0.9-2-2-2H13c-1.1,0-2,0.9-2,2S11.9,26,13,26z M26,42h12c1.1,0,2-0.9,2-2s-0.9-2-2-2H26c-1.1,0-2,0.9-2,2S24.9,42,26,42z"/></svg>`
            };
            const map = { 32: 'sunny', 36: 'sunny', 34: 'sunny', 33: 'night-clear', 31: 'night-clear', 30: 'partly-cloudy-day', 44: 'partly-cloudy-day', 28: 'partly-cloudy-day', 29: 'partly-cloudy-night', 27: 'partly-cloudy-night', 26: 'cloudy', 11: 'rain', 12: 'rain', 40: 'rain', 9: 'rain', 13: 'snow', 14: 'snow', 15: 'snow', 16: 'snow', 41: 'snow', 43: 'snow', 46: 'snow', 3: 'thunderstorm', 4: 'thunderstorm', 37: 'thunderstorm', 38: 'thunderstorm', 47: 'thunderstorm', 20: 'fog', 19: 'fog', 21: 'fog', 22: 'fog' };
            return icons[map[code] || 'default'];
        }
        
        const getWeatherBackgroundClass = (code) => {
             const map = { 32: 'sunny', 36: 'sunny', 34: 'sunny', 33: 'night-clear', 31: 'night-clear', 30: 'sunny', 44: 'sunny', 28: 'sunny', 29: 'night-clear', 27: 'night-clear', 26: 'cloudy', 11: 'rain', 12: 'rain', 40: 'rain', 9: 'rain', 13: 'snow', 14: 'snow', 15: 'snow', 16: 'snow', 41: 'snow', 43: 'snow', 46: 'snow', 3: 'thunderstorm', 4: 'thunderstorm', 37: 'thunderstorm', 38: 'thunderstorm', 47: 'thunderstorm', 20: 'fog', 19: 'fog', 21: 'fog', 22: 'fog' };
             return `weather-bg-${map[code] || 'default'}`;
        }

        async function fetchAllWeatherData() {
            const fetchList = async (list) => {
                const promises = list.map(async (city) => {
                    try {
                        const url = `https://api.weather.com/v3/wx/observations/current?geocode=${city.lat},${city.lon}&format=json&units=m&language=hu-HU&apiKey=${weatherComApiKey}`;
                        const response = await fetch(CORS_PROXY + url);
                        if (!response.ok) return null;
                        const data = await response.json();
                        return { name: city.name, temp: data.temperature, icon: data.iconCode, desc: data.wxPhraseLong, localTime: data.validTimeLocal, humidity: data.relativeHumidity, windSpeed: data.windSpeed, lat: city.lat, lon: city.lon };
                    } catch (error) { console.error(`Időjárás API hiba (${city.name}):`, error); return null; }
                });
                return (await Promise.all(promises)).filter(r => r !== null);
            };
            [domesticWeatherCache, foreignWeatherDataCache] = await Promise.all([ fetchList(HUNGARIAN_CITIES), fetchList(FOREIGN_CITIES) ]);
        }
        
        function displayWeather() {
            let currentCity;

            if (isDisplayingDomestic) {
                if (domesticWeatherCache.length === 0) return;
                currentCity = domesticWeatherCache[domesticWeatherIndex];
                domesticWeatherIndex++;
                if (domesticWeatherIndex >= domesticWeatherCache.length) {
                    domesticWeatherIndex = 0;
                    isDisplayingDomestic = false;
                    setTimeout(fetchAllWeatherData, 2000);
                }
            } else {
                if (foreignWeatherDataCache.length === 0) return;
                currentCity = foreignWeatherDataCache[foreignWeatherIndex];
                foreignWeatherIndex++;
                if (foreignWeatherIndex >= foreignWeatherDataCache.length) {
                    foreignWeatherIndex = 0;
                    isDisplayingDomestic = true;
                }
            }
            if (!currentCity) return;
            
            const localTime = new Date(currentCity.localTime);
            const localTimeStr = localTime.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
            const sunTimes = SunCalc.getTimes(localTime, currentCity.lat, currentCity.lon);
            const sunriseStr = sunTimes.sunrise.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
            const sunsetStr = sunTimes.sunset.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
            
            const backgroundClass = getWeatherBackgroundClass(currentCity.icon);
            worldWeatherContainer.className = '';
            worldWeatherContainer.classList.add(backgroundClass);

            const widgetHtml = `
                <div class="weather-widget">
                    <div class="weather-header">
                        <div class="weather-location" title="${currentCity.name}">${currentCity.name}</div>
                        <div class="weather-time">
                           <span>${localTimeStr}</span>
                        </div>
                    </div>
                    <div class="weather-main-content">
                        <div class="weather-main-icon">${getWeatherIcon(currentCity.icon)}</div>
                        <div class="weather-temp">${currentCity.temp}°</div>
                    </div>
                    <div class="weather-description">${currentCity.desc}</div>
                    <div class="weather-details">
                        <span class="weather-detail-item" title="Páratartalom">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                            ${currentCity.humidity}%
                        </span>
                         <span class="weather-detail-item" title="Napkelte">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8 6 12 2 16 6"/></svg>
                            ${sunriseStr}
                        </span>
                        <span class="weather-detail-item" title="Szélsebesség">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                             ${currentCity.windSpeed} km/h
                        </span>
                        <span class="weather-detail-item" title="Napnyugta">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="16 5 12 9 8 5"/></svg>
                            ${sunsetStr}
                        </span>
                    </div>
                </div>`;
            
            worldWeatherContainer.innerHTML = widgetHtml;
        }

        function updateDynamicTheme() {
            const now = new Date(); 
            const lat = 47.95; const lon = 21.71; // Nyíregyháza
            const times = SunCalc.getTimes(now, lat, lon);
            const themeClasses = ['theme-night', 'theme-predawn', 'theme-dawn', 'theme-sunrise', 'theme-morning', 'theme-day', 'theme-afternoon', 'theme-sunset', 'theme-dusk', 'theme-civil-dusk'];
            let currentThemeClass = 'theme-night';

            if (now > times.dusk) { currentThemeClass = 'theme-night'; }
            else if (now > times.sunset) { currentThemeClass = 'theme-civil-dusk'; } 
            else if (now > times.sunsetStart) { currentThemeClass = 'theme-dusk'; } 
            else if (now > times.goldenHour) { currentThemeClass = 'theme-sunset'; } 
            else if (now > times.solarNoon) { currentThemeClass = 'theme-afternoon'; }
            else if (now > times.sunriseEnd) { currentThemeClass = 'theme-day'; }
            else if (now > times.sunrise) { currentThemeClass = 'theme-morning'; }
            else if (now > times.dawn) { currentThemeClass = 'theme-sunrise'; } 
            else if (now > times.nauticalDawn) { currentThemeClass = 'theme-dawn'; }
            else if (now > times.nightEnd) { currentThemeClass = 'theme-predawn'; }
            
            if (!bodyEl.classList.contains(currentThemeClass)) { bodyEl.classList.remove(...themeClasses); bodyEl.classList.add(currentThemeClass); }
        }
        
        function updateAnalogClock() {
            const now = new Date();
            const seconds = now.getSeconds();
            const minutes = now.getMinutes();
            const hours = now.getHours();

            const secondDeg = (seconds / 60) * 360;
            const minuteDeg = (minutes / 60) * 360; 
            const hourDeg = (hours / 12) * 360 + (minutes / 60) * 30;

            document.getElementById('second-hand').style.transform = `rotate(${secondDeg}deg)`;
            if (seconds === 0) { 
                 document.getElementById('minute-hand').style.transform = `rotate(${minuteDeg}deg)`;
            }
            document.getElementById('hour-hand').style.transform = `rotate(${hourDeg}deg)`;
            document.getElementById('digital-clock-overlay').textContent = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        }

        function showRefreshState(show) {
            if (show) {
                labelContent.style.visibility = 'hidden';
                labelContent.style.opacity = '0';
                refreshOverlay.classList.add('visible');
                if (!analogClockInterval) {
                    const now = new Date();
                    const minuteDeg = (now.getMinutes() / 60) * 360;
                    document.getElementById('minute-hand').style.transition = 'none'; 
                    document.getElementById('minute-hand').style.transform = `rotate(${minuteDeg}deg)`;
                    requestAnimationFrame(() => {
                         document.getElementById('minute-hand').style.transition = 'transform 0.2s cubic-bezier(0.4, 1.8, 0.5, 0.75)';
                    });

                    updateAnalogClock();
                    analogClockInterval = setInterval(updateAnalogClock, 1000);
                }
            } else {
                labelContent.style.visibility = 'visible';
                labelContent.style.opacity = '1';
                refreshOverlay.classList.remove('visible');
                if (analogClockInterval) {
                    clearInterval(analogClockInterval);
                    analogClockInterval = null;
                }
            }
        }
        
        function displayInfoMessage() {
            if (isInfoMessageActive) return;
            isInfoMessageActive = true;
            pauseFlipCycle();
            
            showRefreshState(true);
            
            const infoHtml = `<div class="ticker-item announcement-item visible">
                <div class="label-top-row">
                    <svg class="ticker-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke-width="5"><circle cx="50" cy="50" r="45" /><ellipse cx="50" cy="50" rx="45" ry="18" /><path d="M50,5 C 30,30 30,70 50,95" /><path d="M50,5 C 70,30 70,70 50,95" /></svg>
                    <div class="brand-container"><span class="brand-name">TKP NEWS</span></div>
                </div>
                <p>Napközben (06-00h) a legfrissebb híreket, éjjel (00-06h) pedig az előző nap eseményeit követheted nyomon.</p>
            </div>`;

            const activeContent = tracks[activeTrackKey].querySelector('.ticker-content');
            activeContent.innerHTML = infoHtml;
        }

        function updateClock() {
            const now = new Date(); 
            const year = now.getFullYear(), month = String(now.getMonth() + 1).padStart(2, '0'), day = String(now.getDate()).padStart(2, '0'), dayOfWeek = CALENDAR_DATA.napok[now.getDay()], hours = String(now.getHours()).padStart(2, '0'), minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').innerHTML = `${year}.${month}.${day}. ${dayOfWeek} ${hours}<span class="clock-colon">:</span>${minutes}`;
            
            const newMode = now.getHours() < 6 ? 'summary' : 'normal';
            if (newMode !== currentMode) { 
                currentMode = newMode;
                isInfoMessageActive = false;
                sessionStorage.removeItem('newsCache');
                triggerUpdate();
                return; 
            }
            
            const seconds = now.getSeconds();

            if (currentMode === 'normal') {
                if (((minutes === 29 || minutes === 59) && seconds === 30)) {
                    displayInfoMessage();
                }

                if (minutes === 59 && seconds === 55) {
                    showRefreshState(true);
                }
            }
            
            if (minutes % 15 === 0 && minutes !== lastUpdateMinute) {
                lastUpdateMinute = minutes;
                 if (document.visibilityState === 'visible') {
                    console.log("Automatikus frissítés (negyedóránként)...");
                    sessionStorage.removeItem('newsCache');
                    triggerUpdate();
                } else {
                    showRefreshState(false);
                    refreshAnimationTriggeredForMinute = -1;
                    isInfoMessageActive = false;
                }
            }
        }
        
        function updateCounter() {
            const items = tracks[activeTrackKey].querySelectorAll('.ticker-item');
            if (items.length > 0) {
                newsCounter.textContent = `${currentItemIndex + 1} / ${items.length}`;
                newsCounter.style.display = 'block';
            } else {
                newsCounter.style.display = 'none';
            }
        }

        function setFilter(target) { if (target.tagName !== 'BUTTON' || isInfoMessageActive) return; activeFilter = target.dataset.filter; const currentActive = filterControls.querySelector('.active'); if(currentActive) currentActive.classList.remove('active'); target.classList.add('active'); triggerUpdate(); }
        function getFaviconUrl(newsUrl) { try { const url = new URL(newsUrl); return `https://www.google.com/s2/favicons?domain=${url.hostname}&sz=32`; } catch { return ''; } }
        function tagNewsItems(newsItems) { return newsItems.map(item => { const title = item.title.toLowerCase(); item.categories = []; for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) { if (keywords.some(keyword => title.includes(keyword))) item.categories.push(category); } return item; }); }
        function updateFilterButtons(newsItems) { const availableCategories = new Set(newsItems.flatMap(item => item.categories || [])); filterControls.innerHTML = ''; const allBtn = document.createElement('button'); allBtn.dataset.filter = 'all'; allBtn.textContent = 'Összes'; filterControls.appendChild(allBtn); availableCategories.forEach(cat => { const btn = document.createElement('button'); btn.dataset.filter = cat; btn.textContent = cat; filterControls.appendChild(btn); }); let activeBtn = filterControls.querySelector(`[data-filter="${activeFilter}"]`) || filterControls.querySelector('[data-filter="all"]'); activeFilter = activeBtn.dataset.filter; activeBtn.classList.add('active'); }
        function filterNews(newsItems, category) { if (category === 'all') return newsItems; return newsItems.filter(item => item.categories && item.categories.includes(category)); }
        const getSourceName = (url) => { if (url.includes('index.hu')) return 'Index'; if (url.includes('telex.hu')) return 'Telex'; if (url.includes('hvg.hu')) return 'HVG'; if (url.includes('24.hu')) return '24.hu'; if (url.includes('ma.hu')) return 'ma.hu'; try { return new URL(url).hostname.replace('www.', '').split('.')[0].toUpperCase(); } catch { return 'Ismeretlen'; } };
        const formatTime = (dateObj) => dateObj.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });

        function pauseFlipCycle() { if (flipTimeoutId) { clearTimeout(flipTimeoutId); flipTimeoutId = null; const elapsed = Date.now() - flipStartTime; flipRemainingTime -= elapsed; } }
        function resumeFlipCycle() { if (flipRemainingTime > 0 && !flipTimeoutId && !isInfoMessageActive && tracks[activeTrackKey].querySelectorAll('.ticker-item').length > 1) { flipStartTime = Date.now(); flipTimeoutId = setTimeout(cycleItems, flipRemainingTime); } }
        
        function showItemAtIndex(index, isManual = false) {
            if (isInfoMessageActive) return;
            pauseFlipCycle();
            const items = tracks[activeTrackKey].querySelectorAll('.ticker-item');
            if(items.length === 0) return;

            // Robusztusabb megoldás: Először minden elemet elrejtünk, hogy elkerüljük az átfedéseket
            items.forEach(item => item.classList.remove('visible'));
            
            currentItemIndex = (index + items.length) % items.length;
            const currentItem = items[currentItemIndex];
            
            if(currentItem) {
                requestAnimationFrame(() => { 
                    currentItem.classList.add('visible');
                    updateCounter();
                    if (currentMode === 'summary') {
                        updateTimeline();
                    }
                });
            }

            let duration = FLIP_INTERVAL_REGULAR;
             if (currentItem?.classList.contains('announcement-item')) {
                duration = FLIP_INTERVAL_ANNOUNCEMENT;
            } else if (currentItem?.classList.contains('news-intro-item') || currentItem?.classList.contains('calendar-item') || currentItem?.classList.contains('quote-item')) {
                duration = FLIP_INTERVAL_INFO;
            }
            
            flipRemainingTime = duration;
            resumeFlipCycle();
        }

        function cycleItems() { 
            if (isInfoMessageActive) return;
            showItemAtIndex(currentItemIndex + 1); 
        }
        
        function startFlipCycle() {
            if (flipTimeoutId) clearTimeout(flipTimeoutId);
            const items = tracks[activeTrackKey].querySelectorAll('.ticker-item');
            currentItemIndex = 0;
            if (items.length > 0) {
                items.forEach((item, index) => item.classList.toggle('visible', index === 0));
                updateCounter();
                const firstItem = items[0];
                let duration = FLIP_INTERVAL_REGULAR;
                if (firstItem?.classList.contains('announcement-item')) {
                    duration = FLIP_INTERVAL_ANNOUNCEMENT;
                } else if (firstItem?.classList.contains('news-intro-item') || firstItem?.classList.contains('calendar-item') || firstItem?.classList.contains('quote-item')) {
                    duration = FLIP_INTERVAL_INFO;
                }
                flipRemainingTime = duration;
                resumeFlipCycle();
            } else {
                updateCounter();
                flipRemainingTime = 0;
            }
        }
        
        function triggerLogoGlitch() { if (document.visibilityState !== 'visible') return; tickerLogo.classList.add('glitch-active'); setTimeout(() => { tickerLogo.classList.remove('glitch-active'); }, 250); logoGlitchTimeout = setTimeout(triggerLogoGlitch, Math.random() * 5000 + 4000); }
        function triggerTextGlitch() { if (document.visibilityState !== 'visible') return; brandNameEl.classList.add('glitch-text-active'); setTimeout(() => { brandNameEl.classList.remove('glitch-text-active'); }, 300); textGlitchTimeout = setTimeout(triggerTextGlitch, Math.random() * 13000 + 7000); }
        function stopGlitchEffects() { clearTimeout(logoGlitchTimeout); clearTimeout(textGlitchTimeout); logoGlitchTimeout = null; textGlitchTimeout = null; }
        function startGlitchEffects() { stopGlitchEffects(); triggerLogoGlitch(); triggerTextGlitch(); }

        async function fetchAndDisplayContent() {
            // Javítás: Csak akkor fusson le, ha már betöltődtek a feed-ek, elkerülve a korai hibaüzenetet.
            if (Object.keys(rssFeeds).length === 0) {
                console.log("Várakozás az RSS feedek listájára...");
                return;
            }

            isInfoMessageActive = false;
            fetchStartTime = Date.now();
            clearTimeout(loadingTimeout);
            showRefreshState(true);

            loadingTimeout = setTimeout(() => {
                showRefreshState(false);
                const standbyTrackKey = activeTrackKey === 'a' ? 'b' : 'a';
                const standbyContent = tracks[standbyTrackKey].querySelector('.ticker-content');
                standbyContent.innerHTML = `<div class="ticker-item visible" style="text-align: center; align-items: center;">A hírek betöltése a vártnál tovább tart. Kérjük, várjon...</div>`;
                tracks[standbyTrackKey].classList.add('visible');
                tracks[activeTrackKey].classList.remove('visible');
                console.error("News fetch timed out.");
            }, 25000);
            
            clearTimeout(newsFetchRetryTimeout);
            clearTimeout(chunkLoadTimeout);
            pauseFlipCycle();
            timelineContainer.innerHTML = '';
            
            const CACHE_KEY = 'newsCache';
            const CACHE_EXPIRATION_MS = 10 * 60 * 1000;
            let allNewsItems;
            
            try {
                const cachedData = JSON.parse(sessionStorage.getItem(CACHE_KEY));
                if (cachedData && (Date.now() - cachedData.timestamp < CACHE_EXPIRATION_MS)) {
                    allNewsItems = cachedData.news;
                    console.log("Hírek betöltve a gyorsítótárból.");
                }
            } catch (e) { console.error("Gyorsítótár olvasási hiba:", e); }

            if (!allNewsItems) {
                console.log("Hírek letöltése a hálózatról...");
                const newsPromises = Object.entries(rssFeeds).map(async ([key, url]) => {
                    try {
                        const res = await fetch(CORS_PROXY + url, { signal: AbortSignal.timeout(15000) });
                        if (!res.ok) return { success: false, url, reason: `HTTP error! status: ${res.status}` };
                        
                        const str = url.includes('ma.hu') 
                            ? new TextDecoder('iso-8859-2').decode(await res.arrayBuffer())
                            : await res.text();
                        
                        const data = new window.DOMParser().parseFromString(str, "text/xml");
                        if (data.querySelector("parsererror")) return { success: false, url, reason: "XML parsing error" };
                        
                        return { success: true, data: [...data.querySelectorAll("item")].map(item => { const fullDescriptionHtml = item.querySelector("description")?.textContent || ''; return { title: item.querySelector("title")?.textContent || '', link: item.querySelector("link")?.textContent || '#', pubDate: item.querySelector("pubDate")?.textContent || null, description: stripHtml(fullDescriptionHtml), source: getSourceName(url), imageUrl: extractImageUrl(item, fullDescriptionHtml) }; }) };
                    } catch (error) {
                        return { success: false, url, reason: error.name === 'TimeoutError' ? 'Request timed out' : 'Fetch error' };
                    }
                });
                
                const fetchResults = await Promise.allSettled(newsPromises);

                allNewsItems = tagNewsItems(
                    fetchResults
                        .filter(result => result.status === 'fulfilled' && result.value.success)
                        .flatMap(result => result.value.data)
                );

                fetchResults.forEach(result => {
                    if (result.status === 'rejected' || (result.status === 'fulfilled' && !result.value.success)) {
                        console.warn(`Hiba a forrás letöltésekor: ${result.value?.url || 'Ismeretlen'} - Ok: ${result.reason || result.value?.reason}`);
                    }
                });

                if (allNewsItems.length > 0) {
                    sessionStorage.setItem(CACHE_KEY, JSON.stringify({ news: allNewsItems, timestamp: Date.now() }));
                }
            }
            
            clearTimeout(loadingTimeout); 
            
            if (!allNewsItems || allNewsItems.length === 0) {
                console.warn("Nincsenek megjeleníthető hírek, újrapróbálkozás 15 másodperc múlva...");
                showRefreshState(false);
                const standbyTrackKey = activeTrackKey === 'a' ? 'b' : 'a';
                const standbyContent = tracks[standbyTrackKey].querySelector('.ticker-content');
                standbyContent.innerHTML = `<div class="ticker-item visible" style="text-align: center; align-items: center;">Hírek betöltése sikertelen. Újrapróbálkozás...</div>`;
                tracks[standbyTrackKey].classList.add('visible');
                tracks[activeTrackKey].classList.remove('visible');
                activeTrackKey = standbyTrackKey;
                newsFetchRetryTimeout = setTimeout(fetchAndDisplayContent, 15000);
                return;
            }

            const today = new Date(); const nameDayKey = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const names = CALENDAR_DATA.nameDays[nameDayKey] || [];
            nameDayEl.textContent = names.length > 0 ? `${names.join(' és ')} névnapja` : '';
            nameDayEl.style.display = 'block';

            if (currentMode === 'summary') {
                nightShiftContainer.style.display = 'flex';
                bodyEl.classList.add('night-mode-active');
                filterControlGroup.style.display = 'none';
                nightModeMessage.textContent = "Előző nap hírei. Friss hírek: 6:00-tól.";
                nightModeMessage.style.display = 'block';
            } else {
                nightShiftContainer.style.display = 'none';
                bodyEl.classList.remove('night-mode-active');
                filterControlGroup.style.display = 'flex';
                nightModeMessage.style.display = 'none';
            }
            updateDynamicTheme();

            if (currentMode === 'normal') updateFilterButtons(allNewsItems);
            
            let contentItems = [], newsToDisplay = [];
            
            if (currentMode === 'summary') {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStart = new Date(yesterday.setHours(0, 0, 0, 0));
                const yesterdayEnd = new Date(yesterday.setHours(23, 59, 59, 999));
                masterNewsList = filterNews(allNewsItems, 'all').filter(item => item.pubDate && new Date(item.pubDate) >= yesterdayStart && new Date(item.pubDate) <= yesterdayEnd).sort((a, b) => new Date(a.pubDate) - new Date(b.pubDate));
                
                const processedList = [];
                let lastHour = -1;
                masterNewsList.forEach(item => {
                    const itemHour = new Date(item.pubDate).getHours();
                    if(itemHour !== lastHour && itemHour % 3 === 0) {
                        processedList.push({ isAnnouncement: true });
                        lastHour = itemHour;
                    } else if (itemHour !== lastHour) {
                        lastHour = itemHour;
                    }
                    processedList.push(item);
                });
                masterNewsList = processedList;
                
                newsToDisplay = masterNewsList.slice(0, CHUNK_SIZE);
                
                if (newsToDisplay.length > 0) contentItems.push(`<div class="ticker-item news-intro-item">${ICON_NEWS} A tegnapi nap (${new Date(yesterdayStart).toLocaleDateString('hu-HU')}) hírei időrendben:</div>`);
                breakingIndicator.classList.remove('active');
                generateTimeline();

            } else {
                 const filteredByCategory = filterNews(allNewsItems, activeFilter);

                if (activeFilter === 'all') {
                    const timeLimit = new Date();
                    timeLimit.setHours(timeLimit.getHours() - 2);
                    newsToDisplay = filteredByCategory
                        .filter(item => item.pubDate && new Date(item.pubDate) >= timeLimit)
                        .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                } else {
                    const timeLimit = new Date();
                    timeLimit.setHours(0, 0, 0, 0);
                    newsToDisplay = filteredByCategory
                        .filter(item => item.pubDate && new Date(item.pubDate) >= timeLimit)
                        .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                }
                
                breakingIndicator.classList.toggle(allNewsItems.slice(0, 10).some(item => BREAKING_KEYWORDS.some(k => item.title.toLowerCase().includes(k))), true);
                
                let preliminaryItems = [];
                if(activeFilter === 'all') {
                    preliminaryItems.push(`<div class="ticker-item calendar-item">${ICON_CALENDAR} Ma ${today.getFullYear()}. ${CALENDAR_DATA.honapok[today.getMonth()]} ${today.getDate()}. ${CALENDAR_DATA.napok[today.getDay()]} van.</div>`);
                    if (customAnnouncements.length > 0) { customAnnouncements.forEach(ann => { preliminaryItems.push(`<div class="ticker-item custom-announcement" style="color: ${ann.color || 'var(--accent-main)'};">${ICON_ANNOUNCEMENT} ${ann.text}</div>`); }); }
                    preliminaryItems.push(`<div class="ticker-item quote-item">Nap idézete: "${QUOTES[new Date().getDate() % QUOTES.length]}"</div>`);
                }
                if (newsToDisplay.length > 0) { preliminaryItems.push(`<div class="ticker-item news-intro-item">${ICON_NEWS}${activeFilter === 'all' ? ' A legfrissebb hírek:' : ` Napi hírek: '${activeFilter}'` }</div>`); }
                masterNewsList = [...preliminaryItems, ...newsToDisplay];
                newsToDisplay = masterNewsList;
            }
            
            const announcementHTML = `<div class="ticker-item announcement-item"><div class="label-top-row"><svg class="ticker-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke-width="5"><circle cx="50" cy="50" r="45" /><ellipse cx="50" cy="50" rx="45" ry="18" /><path d="M50,5 C 30,30 30,70 50,95" /><path d="M50,5 C 70,30 70,70 50,95" /></svg><div class="brand-container"><span class="brand-name">TKP NEWS</span></div></div><p>Tudtad? Hírszalagunkon reggel 6 és éjfél között a legfrissebb híreket, míg éjfél és reggel 6 között az előző nap teljes összefoglalóját követheted nyomon.</p></div>`;

            newsToDisplay.forEach(item => {
                if(typeof item === 'string') {
                    contentItems.push(item);
                    return;
                }
                if (item.isAnnouncement) {
                    contentItems.push(announcementHTML);
                    return;
                }
                const time = item.pubDate ? formatTime(new Date(item.pubDate)) : '';
                const faviconImg = item.link ? `<img src="${getFaviconUrl(item.link)}" class="favicon-img" alt="">` : '';
                const isBreaking = BREAKING_KEYWORDS.some(k => item.title.toLowerCase().includes(k));
                
                let imageHtml = '';
                let itemClass = `ticker-item ${isBreaking ? 'breaking-highlight' : ''}`;
                if (item.imageUrl) {
                    imageHtml = `<div class="ticker-item-image-container"><img src="${CORS_PROXY}${item.imageUrl}" class="ticker-item-image" alt="" loading="lazy"></div>`;
                    itemClass += ' has-image';
                }

                const contentHtml = `
                    <div class="ticker-item-content-wrapper">
                        <div class="ticker-item-header">
                            <span class="meta">${faviconImg}[<span class="source">${item.source}</span> | ${time}]</span>
                        </div>
                        <a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a>
                        <span class="ticker-item-description">${getSmartDescription(item.description)}</span>
                    </div>`;

                contentItems.push(`<div class="${itemClass}">${imageHtml}${contentHtml}</div>`);
            });
            
            const standbyTrackKey = activeTrackKey === 'a' ? 'b' : 'a';
            const standbyContent = tracks[standbyTrackKey].querySelector('.ticker-content');
            standbyContent.innerHTML = contentItems.join('');
            
            const fetchDuration = Date.now() - fetchStartTime;
            const minDisplayTime = 5000;
            const remainingTime = Math.max(0, minDisplayTime - fetchDuration);

            setTimeout(() => {
                showRefreshState(false);
                requestAnimationFrame(() => {
                    tracks[standbyTrackKey].classList.add('visible');
                    tracks[activeTrackKey].classList.remove('visible');
                    activeTrackKey = standbyTrackKey;
                    startFlipCycle();
                    if(currentMode === 'summary' && masterNewsList.length > CHUNK_SIZE) {
                        loadNextChunk(1);
                    }
                });
            }, remainingTime);
        };

        function loadNextChunk(chunkIndex) {
            const startIndex = chunkIndex * CHUNK_SIZE;
            if (startIndex >= masterNewsList.length) {
                console.log("Minden hír betöltve.");
                return;
            }

            chunkLoadTimeout = setTimeout(() => {
                const nextChunk = masterNewsList.slice(startIndex, startIndex + CHUNK_SIZE);
                let newItemsHtml = '';

                const announcementHTML = `<div class="ticker-item announcement-item"><div class="label-top-row"><svg class="ticker-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke-width="5"><circle cx="50" cy="50" r="45" /><ellipse cx="50" cy="50" rx="45" ry="18" /><path d="M50,5 C 30,30 30,70 50,95" /><path d="M50,5 C 70,30 70,70 50,95" /></svg><div class="brand-container"><span class="brand-name">TKP NEWS</span></div></div><p>Tudtad? Hírszalagunkon reggel 6 és éjfél között a legfrissebb híreket, míg éjfél és reggel 6 között az előző nap teljes összefoglalóját követheted nyomon.</p></div>`;

                nextChunk.forEach(item => {
                    if (item.isAnnouncement) {
                        newItemsHtml += announcementHTML;
                        return;
                    }
                    const time = item.pubDate ? formatTime(new Date(item.pubDate)) : '';
                    const faviconImg = item.link ? `<img src="${getFaviconUrl(item.link)}" class="favicon-img" alt="">` : '';
                    const isBreaking = BREAKING_KEYWORDS.some(k => item.title.toLowerCase().includes(k));
                    
                    let imageHtml = '';
                    let itemClass = `ticker-item ${isBreaking ? 'breaking-highlight' : ''}`;
                    if (item.imageUrl) {
                        imageHtml = `<div class="ticker-item-image-container"><img src="${CORS_PROXY}${item.imageUrl}" class="ticker-item-image" alt="" loading="lazy"></div>`;
                        itemClass += ' has-image';
                    }

                    const contentHtml = `<div class="ticker-item-content-wrapper"><div class="ticker-item-header"><span class="meta">${faviconImg}[<span class="source">${item.source}</span> | ${time}]</span></div><a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a><span class="ticker-item-description">${getSmartDescription(item.description)}</span></div>`;
                    newItemsHtml += `<div class="${itemClass}">${imageHtml}${contentHtml}</div>`;
                });

                const activeContent = tracks[activeTrackKey].querySelector('.ticker-content');
                activeContent.insertAdjacentHTML('beforeend', newItemsHtml);
                
                updateCounter();
                console.log(`${activeContent.querySelectorAll('.ticker-item').length} / ${masterNewsList.length} hír betöltve.`);
                
                if (startIndex + CHUNK_SIZE < masterNewsList.length) {
                    loadNextChunk(chunkIndex + 1);
                } else {
                     console.log("Minden hír betöltve.");
                }
            }, 2000);
        }
        
        function generateTimeline() {
            if (!masterNewsList.some(item => !item.isAnnouncement)) return;
            const hours = [...new Set(masterNewsList.filter(item => !item.isAnnouncement).map(item => new Date(item.pubDate).getHours()))].sort((a, b) => a - b);
            timelineContainer.innerHTML = hours.map(hour => `<button data-hour="${hour}">${String(hour).padStart(2, '0')}</button>`).join('');
        }

        function updateTimeline() {
            if (currentMode !== 'summary' || masterNewsList.length === 0) return;
            
            let newsItem = null;
            let currentNewsIndex = -1;
            
            const domItems = tracks[activeTrackKey].querySelectorAll('.ticker-item');
            if (!domItems[currentItemIndex]) return;

            // Find the actual news item at or before the current index
            for(let i = currentItemIndex; i >= 0; i--) {
                const item = masterNewsList[i];
                if(item && !item.isAnnouncement) {
                    newsItem = item;
                    currentNewsIndex = i;
                    break;
                }
            }
            if(!newsItem) return;

            const currentHour = new Date(newsItem.pubDate).getHours();
            const currentActive = timelineContainer.querySelector('.active-hour');
            if (currentActive && currentActive.dataset.hour !== String(currentHour)) {
                currentActive.classList.remove('active-hour');
            }
            
            const newActive = timelineContainer.querySelector(`[data-hour="${currentHour}"]`);
            if (newActive && !newActive.classList.contains('active-hour')) {
                newActive.classList.add('active-hour');
            }
        }


        const triggerUpdate = () => { clearTimeout(debounceTimeout); debounceTimeout = setTimeout(() => { if (document.visibilityState === 'visible') fetchAndDisplayContent(); }, 500); };
        
        function stopAllTimers() { clearTimeout(updateTimeout); clearTimeout(debounceTimeout); clearTimeout(newsFetchRetryTimeout); clearTimeout(chunkLoadTimeout); clearTimeout(loadingTimeout); pauseFlipCycle(); if(weatherDisplayInterval) clearInterval(weatherDisplayInterval); if(weatherFetchInterval) clearInterval(weatherFetchInterval); weatherDisplayInterval = null; weatherFetchInterval = null; stopGlitchEffects(); };
        
        async function startAllTimers() { 
            triggerUpdate();
            if (!weatherFetchInterval) { 
                await fetchAllWeatherData();
                if (document.visibilityState === 'visible') displayWeather();
                weatherFetchInterval = setInterval(fetchAllWeatherData, 15 * 60 * 1000);
            }
            if (!weatherDisplayInterval) {
                 weatherDisplayInterval = setInterval(displayWeather, WEATHER_DISPLAY_INTERVAL_DURATION);
            }
            startGlitchEffects();
        };

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => { document.body.classList.add('loaded'); }, 200);
            
            updateClock(); 
            setInterval(updateClock, 1000);
            updateDynamicTheme(); 
            setInterval(updateDynamicTheme, 5 * 60 * 1000);
            
            if (document.visibilityState === 'visible') { startAllTimers(); }

            tickerWrap.addEventListener('mouseenter', pauseFlipCycle);
            tickerWrap.addEventListener('mouseleave', resumeFlipCycle);
            prevBtn.addEventListener('click', () => showItemAtIndex(currentItemIndex - 1, true));
            nextBtn.addEventListener('click', () => showItemAtIndex(currentItemIndex + 1, true));
            
            timelineContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const hour = parseInt(e.target.dataset.hour, 10);
                    const firstItemIndexInMaster = masterNewsList.findIndex(item => !item.isAnnouncement && new Date(item.pubDate).getHours() === hour);
                    
                    if (firstItemIndexInMaster !== -1) {
                        const itemsInDom = tracks[activeTrackKey].querySelectorAll('.ticker-item').length;
                        if (firstItemIndexInMaster < itemsInDom) {
                             showItemAtIndex(firstItemIndexInMaster, true);
                        } else {
                            console.warn("Az óra még nincs betöltve a DOM-ba. A funkció a következő szakaszos betöltés után lesz elérhető.");
                        }
                    }
                }
            });

            document.addEventListener('visibilitychange', () => { 
                if (document.visibilityState === 'visible') {
                    resumeFlipCycle();
                    startAllTimers();
                } else {
                    stopAllTimers();
                }
            });
        });

        filterControls.addEventListener('click', (e) => setFilter(e.target));
        onValue(announcementsRef, (snapshot) => { customAnnouncements = snapshot.val() ? Object.values(snapshot.val()) : []; sessionStorage.removeItem('newsCache'); triggerUpdate(); });
        onValue(feedsRef, (snapshot) => { rssFeeds = snapshot.val() || {}; sessionStorage.removeItem('newsCache'); triggerUpdate(); });

    </script>
</body>
</html>
