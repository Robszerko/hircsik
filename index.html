<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dinamikus Napszak Hírszalag - Ultimate PWS V12 (Breaking Mode)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Oswald:wght@400;500&family=Playfair+Display:ital,wght@1,400&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js" type="module"></script>
    <script src="https://unpkg.com/suncalc@1.8.0/suncalc.js"></script>

    <style>
        :root {
            --accent-main: #00838F;
            --accent-gold: #B8860B;
            --font-display: 'Oswald', sans-serif;
            --font-body: 'Roboto', sans-serif;
            --font-quote: 'Playfair Display', serif;
            --font-mono: 'Roboto Mono', monospace;
            
            --bg-main-gradient: linear-gradient(145deg, #020111, #191621);
            --text-primary: #f0f2f5;
            --text-secondary: #a8b3c2;
            --border-color: #3A3B3C;
            --item-bg-color: rgba(28, 28, 30, 0.85);
            --item-border-color: rgba(255, 255, 255, 0.2);

            --stars1: radial-gradient(1px 1px at 20px 30px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 40px 70px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 50px 160px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 90px 40px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 130px 80px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 160px 120px, white, rgba(255,255,255,0));
            --stars2: radial-gradient(1.5px 1.5px at 10px 90px, white, rgba(255,255,255,0)), radial-gradient(1.5px 1.5px at 70px 20px, white, rgba(255,255,255,0)), radial-gradient(1.5px 1.5px at 120px 140px, white, rgba(255,255,255,0));
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #111; font-family: var(--font-body); }
        
        .news-ticker-container {
            background: var(--bg-main-gradient); display: flex;
            border-radius: 6px; margin: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            overflow: hidden; border: 1px solid var(--border-color);
            transition: background 2s ease-in-out, border-color 2s ease-in-out;
            position: relative; 
            height: 160px; 
        }

        @media (max-width: 950px) {
            .news-ticker-container { height: auto; flex-direction: column; }
        }

        .ticker-body { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; }

        body[data-theme-key="night"] .news-ticker-container, body[data-theme-key="predawn"] .news-ticker-container, body[data-theme-key="dusk"] .news-ticker-container, body[data-theme-key="evening"] .news-ticker-container {
            background: var(--stars1), var(--stars2), var(--bg-main-gradient);
            background-repeat: repeat, repeat, no-repeat;
            background-size: 500px 500px, 800px 800px, 100% 100%;
        }

        .ticker-main-row { display: flex; align-items: stretch; flex-grow: 1; min-height: 125px; }
        .ticker-label {
            background: linear-gradient(160deg, #3a4f64, #2c3e50);
            color: #ECF0F1;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display);
            border-right: 1px solid #444;
            min-width: 210px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        #intro-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; z-index: 10; transform: scaleX(1); transition: transform 0.8s cubic-bezier(0.86, 0, 0.07, 1) 1.2s; }
        .color-bar { flex-grow: 1; }
        body.loaded #intro-overlay { transform: scaleX(0); transform-origin: left; }
        
        .label-content { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            width: 100%; height: 100%;
            padding: 0 15px;
            opacity: 0; 
            position: absolute;
            transition: opacity 0.6s ease-in-out, visibility 0s;
        }
        body.intro-finished .label-content {
            animation: content-glitch-in 1.2s cubic-bezier(0.7, 0, 0.3, 1) both;
        }

        .ticker-label::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(200,200,200,0.15) 0%, rgba(200,200,200,0.1) 10%, transparent 30%), repeating-linear-gradient(transparent 0, rgba(0,0,0,0.1) 1px, transparent 2px);
            opacity: 0; z-index: 9; pointer-events: none; animation: static-move 0.15s steps(2) infinite;
        }

        body.intro-finished .ticker-label::before {
            animation: static-move 0.15s steps(2) infinite, static-fade-in-out 1.2s cubic-bezier(0.7, 0, 0.3, 1) 2s both;
        }
        
        #label-image-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.6s ease-in-out, visibility 0s 0.6s;
        }

        #label-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #2c3e50;
        }

        .ticker-label.image-mode-active .label-content {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.6s ease-in-out, visibility 0s 0.6s;
        }
        
        .ticker-label.image-mode-active #label-image-container {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.6s ease-in-out 0.2s, visibility 0s 0.2s;
        }

        .label-top-row { display: flex; align-items: center; gap: 8px;  position: relative; }
        .ticker-logo { width: 28px; height: 28px; flex-shrink: 0; transition: width 0.4s ease, height 0.4s ease; }
        #eyelid, #eyelid-2 { transform-origin: center; transition: transform 0.1s ease-in-out; }

        .brand-name.glitch-text-active { animation: glitch-text 0.3s linear; }
        body.night-mode-active .ticker-logo { width: 24px; height: 24px; }
        .brand-container { display: flex; flex-direction: column; align-items: center; line-height: 1.1; }
        .brand-name { font-size: 1.5rem; letter-spacing: 1px; font-weight: 400; color: #ECF0F1; }
        
        #clock {
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            color: #BDC3C7;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            letter-spacing: 0.5px;
            margin-top: 6px;
            padding: 1px 0;
            background-color: transparent;
            white-space: nowrap;
            transition: color 2s ease-in-out;
        }
        #clock .clock-colon { animation: blink 1.2s step-end infinite; }
        
        #nameday {
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--accent-gold);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            background-color: transparent;
            padding: 0;
            margin-top: 4px;
            white-space: normal;
            text-align: center;
            max-width: 90%;
        }

        #manual-refresh-trigger {
            font-weight: 500;
            color: var(--accent-gold);
            background-color: rgba(0,0,0,0.25);
            border-radius: 4px;
            font-family: var(--font-body);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 2px 8px;
            margin-top: 5px;
            display: none;
        }
        
        .dot { opacity: 0; animation: loading-dots 1.4s infinite; display: inline-block; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes loading-dots { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }

        .ticker-wrap { flex-grow: 1; overflow: hidden; position: relative; min-width: 0; }
        
        #block-title-layer, #breaking-title-layer { display: none !important; }
        
        #countdown-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-main-gradient);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0s 0.5s, background 2s ease-in-out;
        }
        #countdown-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease, visibility 0s, background 2s ease-in-out;
        }
        #countdown-clock {
            font-family: 'Roboto Mono', monospace;
            font-size: 5rem; 
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3), 0 2px 5px rgba(0,0,0,0.5);
            letter-spacing: 0.05em;
            transition: color 2s ease-in-out;
        }
        #countdown-message {
            font-family: var(--font-quote);
            font-style: italic;
            font-size: 1.2rem;
            color: var(--accent-gold);
            margin-top: 10px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        .ticker-track { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; 
            visibility: hidden;
            transition: opacity 0.8s ease-in-out, visibility 0s 0.8s;
            will-change: opacity, transform; 
            transform: translateY(10px); 
            z-index: 1;
        }
        .ticker-wrap.countdown-active .ticker-track { visibility: hidden; opacity: 0; }

        .ticker-track.visible { 
            opacity: 1; 
            visibility: visible;
            transform: translateY(0); 
            transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out, visibility 0s;
            z-index: 2;
        }
        
        .ticker-content { 
            position: relative; 
            width: 100%; 
            height: 100%;
            display: grid;
            place-items: center;
        }

        a.ticker-item, div.ticker-item {
            grid-area: 1 / 1;
            display: flex;
            font-size: 0.95rem; font-weight: 500;
            padding: 12px 20px;
            border-radius: 8px;
            width: 95%; 
            max-height: 95%;
            background: var(--item-bg-color);
            border: 1px solid var(--item-border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease-in-out, background-color 2s ease-in-out, border-color 2s ease-in-out;
            text-decoration: none;
            backface-visibility: hidden;
            transform: translateZ(0);
            position: relative;
        }
        
        .item-watermark {
            position: absolute;
            top: 10px;
            right: 15px;
            font-family: var(--font-display);
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0.6;
            pointer-events: none;
            z-index: 5;
            transition: color 2s ease-in-out, opacity 2s ease-in-out;
            text-transform: capitalize;
        }

        /* ÚJ: MOST ÉRKEZETT vízjel stílus */
        .watermark-breaking {
            top: 6px;
            right: 8px;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 0, 0, 0.5);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            background-color: #D32F2F;
            opacity: 1;
            color: #fff;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            animation: blink 0.8s infinite alternate;
        }

        .watermark-punched {
            top: 6px;
            right: 8px;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
            background-color: rgba(0,0,0,0.15);
            opacity: 0.85;
            color: #f0f2f5;
            text-shadow: 0 1px 2px rgba(0,0,0,0.7);
        }
        
        .item-breaking-indicator {
            position: absolute;
            top: 6px;
            right: 8px;
            padding: 3px 8px;
            font-family: var(--font-display);
            font-size: 0.7rem;
            color: #FFFFFF;
            background-color: #D32F2F;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            pointer-events: none;
            animation: blink 1.2s step-end infinite;
            display: none;
        }

        .ticker-item.visible, a.ticker-item.visible { opacity: 1; visibility: visible; }
        
        .ticker-item-content-wrapper { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; height: 100%; justify-content: center; }
        
        .ticker-item-header { display: flex; align-items: center; margin-bottom: 5px; width: 100%; }
        .ticker-item .meta { color: var(--text-secondary); margin-right: 0.5rem; font-weight: 400; display: flex; align-items: center; white-space: nowrap; transition: color 2s ease-in-out; text-shadow: none; }
        .favicon-img { width: 16px; height: 16px; margin-right: 6px; border-radius: 3px; }
        .ticker-item .source { font-weight: 700; color: var(--accent-gold); }
        .ticker-item-title { color: var(--text-primary); font-weight: 700; transition: color 2s ease-in-out; width: 100%; text-shadow: none; line-height: 1.3; }
        a.ticker-item:hover .ticker-item-title { color: var(--accent-main); }
        .ticker-item-description { font-size: 0.9rem; font-weight: 400; color: var(--text-secondary); display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; transition: color 2s ease-in-out; text-shadow: none; line-height: 1.5; }
        
        .ticker-item.breaking-highlight { animation: pulse-bg 2s infinite; }
        .ticker-item svg { width: 16px; height: 16px; margin-right: 10px; flex-shrink: 0; stroke-width: 2; }
        
        .announcement-item { flex-direction: column; align-items: center; justify-content: center; gap: 8px; }
        .announcement-item .brand-name { font-size: 1.2rem; color: var(--text-primary); }
        .announcement-item .ticker-logo { width: 24px; height: 24px; }
        .announcement-item p { font-size: 0.9rem; text-align: center; color: var(--text-secondary); max-width: 80%; text-shadow: none; }

        .calendar-item-v2 { display: flex; gap: 25px; align-items: center; background: transparent; border: none; box-shadow: none; padding: 10px 25px; }
        .calendar-item-v2 .ci-left { text-align: center; }
        .calendar-item-v2 .ci-day { font-family: var(--font-display); font-size: 4rem; font-weight: 500; line-height: 1; background: linear-gradient(145deg, var(--accent-gold), #ffb700); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; text-shadow: none; }
        .calendar-item-v2 .ci-month-year { font-size: 0.8rem; color: var(--text-secondary); }
        .calendar-item-v2 .ci-right { display: flex; flex-direction: column; gap: 6px; flex-grow: 1; border-left: 1px solid var(--border-color); padding-left: 25px; }
        .calendar-item-v2 .ci-dayname { font-family: var(--font-display); font-size: 1.5rem; color: var(--text-primary); text-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        .calendar-item-v2 .ci-nameday { font-size: 1rem; color: var(--accent-gold); font-weight: 700; }
        .calendar-item-v2 .ci-sun-info { display: flex; gap: 15px; font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px; }
        .calendar-item-v2 .ci-sun-info span { display: flex; align-items: center; gap: 5px; }
        .calendar-item-v2 .ci-sun-info svg { width: 16px; height: 16px; stroke: var(--accent-gold); }

        .quote-item-v2 { flex-direction: column; justify-content: center; align-items: center; text-align: center; background: transparent; border: none; box-shadow: none; gap: 12px; }
        .quote-item-v2 blockquote { font-family: var(--font-quote); font-style: italic; font-size: 1.1rem; color: var(--text-primary); text-shadow: 1px 1px 3px rgba(0,0,0,0.4); max-width: 90%; line-height: 1.6; }
        .quote-item-v2 .quote-divider { display: flex; align-items: center; width: 80%; gap: 10px; }
        .quote-item-v2 .quote-divider::before, .quote-item-v2 .quote-divider::after { content: ''; flex-grow: 1; height: 1px; background-color: var(--border-color); }
        .quote-item-v2 cite { font-family: var(--font-body); font-style: normal; font-size: 0.9rem; font-weight: 500; color: var(--accent-gold); }

        .goodbye-item { flex-direction: column; justify-content: center; align-items: center; text-align: center; background: transparent; border: none; box-shadow: none; }
        .goodbye-item .goodbye-logo-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .goodbye-item h2 { font-family: var(--font-display); font-size: 1.5rem; color: var(--text-primary); }
        .goodbye-item p { color: var(--text-secondary); max-width: 85%; font-size: 0.95rem; }
        .goodbye-item h2, .goodbye-item p { text-shadow: none; }
        
        #progress-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background-color: rgba(0,0,0,0.2); z-index: 6; }
        #progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-gold), var(--accent-main)); border-radius: 0 2px 2px 0; }
        #progress-bar.animate { animation-name: fill-progress; animation-timing-function: linear; animation-fill-mode: forwards; }
        
        /* === STABILIZÁLT LAYOUT ÉS MŰSORAJÁNLÓ (COMPACT) === */
        
        #world-weather-container { 
            flex-shrink: 0; 
            width: 210px; 
            border-left: 1px solid var(--border-color); 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            background: linear-gradient(145deg, #1e2025, #2c3038);
            transition: border-color 2s ease-in-out, width 1s ease-in-out; 
            position: relative; 
            overflow: hidden;
            height: 100%; 
            min-height: 125px;
            max-height: 160px;
        }
        
        #world-weather-container.schedule-expanded { width: 450px; }
        
        #schedule-widget { 
            display: grid; place-items: center; width: 100%; height: 100%; 
            background-color: rgba(10, 20, 30, 0.5); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); 
            border-left: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 5px 10px; /* Tömörítve */
            overflow: hidden; 
            box-sizing: border-box;
        }

        .schedule-card { grid-area: 1 / 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0s 0.5s; }
        .schedule-card.visible { opacity: 1; visibility: visible; transition: opacity 0.5s ease-in-out, visibility 0s; }
        #schedule-intro .schedule-header { font-size: 1.8rem; animation: pulse-glow 2s ease-in-out infinite; }
        
        @keyframes pulse-glow { 0%, 100% { opacity: 0.9; transform: scale(1); text-shadow: 0 0 5px rgba(255,255,255,0.5); } 50% { opacity: 1; transform: scale(1.03); text-shadow: 0 0 8px #fff, 0 0 15px var(--accent-gold); } }
        
        /* Kisebb header */
        .schedule-header { font-family: var(--font-display); font-size: 0.9rem; font-weight: 500; text-transform: uppercase; letter-spacing: 1.5px; color: #FFFFFF; text-shadow: 0 1px 4px rgba(0,0,0,0.8); display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .schedule-header svg { width: 16px; height: 16px; fill: var(--accent-gold); filter: drop-shadow(0 0 3px var(--accent-gold)); }
        
        /* Tömörített lista */
        .schedule-list { display: flex; flex-direction: column; gap: 2px; width: 100%; }
        
        /* Tömörített elemek */
        .schedule-item-v2 { display: flex; align-items: center; gap: 6px; width: 100%; padding: 2px 4px; border-radius: 4px; border: 1px solid transparent; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; min-height: 32px; }
        .schedule-item-v2.highlight-gold { border-color: var(--accent-gold); transform: scale(1.01); box-shadow: 0 0 10px rgba(184, 134, 11, 0.5); }
        
        .schedule-time { font-family: var(--font-mono); font-weight: 700; font-size: 0.8rem; color: #f0f2f5; flex-shrink: 0; }
        
        .schedule-info { display: flex; flex-direction: column; overflow: hidden; flex-grow: 1; border-left: 2px solid var(--accent-gold); padding-left: 6px; justify-content: center; }
        .schedule-title-main { font-size: 0.85rem; font-weight: 500; color: #f0f2f5; text-shadow: 0 1px 2px rgba(0,0,0,0.7); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.1; }
        .schedule-desc { font-size: 0.65rem; color: #aaa; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; line-height: 1.0; }

        #schedule-credits .credits-main-text { font-family: var(--font-body); font-size: 1rem; font-weight: 500; text-align: center; color: #FFFFFF; text-shadow: 0 1px 5px rgba(0, 0, 0, 0.8); line-height: 1.6; margin-bottom: 20px; }
        #schedule-credits .credits-brand { display: inline-flex; align-items: center; gap: 6px; font-family: var(--font-display); font-weight: 500; font-size: 1.1rem; color: var(--accent-gold); vertical-align: middle; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7); }
        #schedule-credits .credits-brand .ticker-logo { width: 20px; height: 20px; }
        #schedule-credits .credits-brand .ticker-logo use { stroke: var(--accent-gold) !important; fill: var(--accent-gold) !important; }
        #schedule-credits .credits-footer { font-size: 0.75rem; color: #FFFFFF; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8); opacity: 0.8; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        
        #world-weather-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.3); z-index: 1; transition: background-color 2s ease-in-out; }
        .weather-widget { padding: 2px 4px; animation: widget-fade-in 0.8s ease-in-out; display: flex; flex-direction: column; text-align: center; position: relative; z-index: 2; width: 100%; height: 100%; justify-content: flex-start; overflow: hidden; }
        
        /* PWS Grid frissített stílusok */
        .weather-header { text-align: center; margin-bottom: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; flex-shrink: 0; }
        .weather-location { font-size: 0.9rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; color: var(--accent-gold) !important; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .weather-time { font-size: 0.65rem; font-weight: 500; opacity: 0.9; color: #ddd; }
        .pws-main-data { display: flex; align-items: center; justify-content: center; gap: 8px; margin: 1px 0; flex-shrink: 0; }
        .pws-temp { font-family: var(--font-display); font-size: 1.6rem; line-height: 1; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .pws-unit { font-size: 0.85rem; vertical-align: top; color: var(--text-secondary); margin-left: 2px; }
        
        /* A Grid kitölti a maradék helyet */
        .pws-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 0.7rem; width: 100%; padding: 0; margin-top: 1px; flex-grow: 1; }
        
        /* Az elemek központosítva és kitöltve */
        .pws-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); padding: 2px 3px; border-radius: 3px; overflow: hidden; }
        
        .pws-label { font-size: 0.5rem; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; line-height: 1; width: 100%; text-align: center; border-bottom: none; padding-bottom: 0; }
        .pws-value { font-weight: 700; font-family: var(--font-mono); font-size: 0.7rem; width: 100%; text-align: center; color: #eee; margin: 1px 0; }
        .pws-sub-value { font-size: 0.55rem; color: #ccc; text-align: center; width: 100%; }
        
        /* STATUS DOT */
        .status-dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; flex-shrink: 0; box-shadow: 0 0 4px currentColor; }
        .status-dot.green { background-color: #00e676; color: #00e676; }
        .status-dot.red { background-color: #ff1744; color: #ff1744; }

        @keyframes fill-progress { from { width: 0%; } to { width: 100%; } }
        @keyframes strobe-in { 0%, 25%, 50%, 75% { opacity: 0; transform: scale(1.05); } 12%, 37%, 62%, 87%, 100% { opacity: 1; transform: scale(1); } }
        .strobe-in { animation: strobe-in 2s ease-in-out forwards; }
        @keyframes glitch-text { 0%, 100% { text-shadow: 1px 1px 0 #00FFFF, -1px -1px 0 #FF00FF; opacity: 1; } 5% { opacity: 0.8; } 10% { opacity: 1; } 15% { opacity: 0.6; } 20% { opacity: 1; text-shadow: -1px -1px 0 #00FFFF, 1px 1px 0 #FF00FF; } 25% { opacity: 0.9; } 30% { opacity: 1; } 50% { text-shadow: 1px -1px 0 #00FFFF, -1px 1px 0 #FF00FF; } 75% { text-shadow: -1px 1px 0 #00FFFF, 1px -1px 0 #FF00FF; } }
        @keyframes static-move { 0% { background-position: 0 0; } 100% { background-position: 4px 6px; } }
        @keyframes static-fade-in-out { 0% { opacity: 0; } 10% { opacity: 0.8; } 85% { opacity: 0.6; } 100% { opacity: 0; } }
        @keyframes content-glitch-in { 0% { opacity: 0; transform: translateY(20px) scale(1.02); text-shadow: -2px -2px 0 red, 2px 2px 0 cyan; } 15% { opacity: 0.4; transform: translateY(18px) scale(1) skew(-3deg); text-shadow: 2px 2px 0 red, -2px -2px 0 cyan; } 30% { opacity: 0.1; transform: translateY(20px) scale(1.01) skew(3deg); } 45% { opacity: 0.7; transform: translateY(10px) scale(1) skew(0deg); text-shadow: 1px 1px 0 red, -1px -1px 0 cyan; } 60% { opacity: 0.5; transform: translateY(15px); } 85% { opacity: 0.9; transform: translateY(5px); text-shadow: none; } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pulse-bg { 0% { box-shadow: inset 0 0 0 0 rgba(211, 47, 47, 0.4), 0 0 8px 2px rgba(211, 47, 47, 0.2); } 50% { box-shadow: inset 0 0 10px 2px rgba(211, 47, 47, 0.1), 0 0 16px 6px rgba(211, 47, 47, 0.4); } 100% { box-shadow: inset 0 0 0 0 rgba(211, 47, 47, 0.4), 0 0 8px 2px rgba(211, 47, 47, 0.2); } }
        @keyframes widget-fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #intro-animation-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 9; opacity: 0; pointer-events: none; }
        #intro-logo-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; }
        .intro-eye { width: 32px; height: 32px; opacity: 0; }
        #intro-logo-wrapper .brand-name { opacity: 0; transform: scale(1.1); }
        .intro-eye .eyelid { transform-origin: center; transform: scaleY(1); }
        @keyframes intro-fade-in { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes intro-blink { 50% { transform: scaleY(0.1); } }
        @keyframes intro-split-left { from { transform: translateX(25px); } to { transform: translateX(0); } }
        @keyframes intro-split-right { from { transform: translateX(-25px); } to { transform: translateX(0); } }
        @keyframes intro-text-reveal { from { opacity: 0; letter-spacing: 5px; } to { opacity: 1; letter-spacing: 1px; } }
        @keyframes intro-move-up { to { transform: translateY(-30px) scale(0.85); opacity: 0; } }
        .intro-animation-active #intro-animation-container { opacity: 1; }
        .intro-animation-active .intro-eye { animation: intro-fade-in 0.5s ease-out forwards; }
        .intro-animation-active .intro-eye .eyelid { animation: intro-blink 0.2s linear 0.7s 2 alternate; }
        .intro-animation-active #intro-eye-left { animation-name: intro-fade-in, intro-split-left; animation-duration: 0.5s, 0.8s; animation-delay: 0s, 1.5s; animation-fill-mode: forwards, forwards; }
        .intro-animation-active #intro-eye-right { animation-name: intro-fade-in, intro-split-right; animation-duration: 0.5s, 0.8s; animation-delay: 0s, 1.5s; animation-fill-mode: forwards, forwards; }
        .intro-animation-active #intro-brand-name { animation: intro-text-reveal 0.5s ease-out 2.3s forwards; }
        .intro-animation-active #intro-logo-wrapper .intro-eye .eyelid { animation: intro-blink 0.2s linear 0.7s 2, intro-blink 0.2s linear 2.8s 2; }
        .intro-animation-active #intro-logo-wrapper { animation: intro-move-up 0.8s ease-in 4s forwards; }

        .ticker-controls { min-height: 30px; height: auto; background-color: rgba(0,0,0,0.25); border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: flex-start; flex-wrap: nowrap; padding: 5px 15px; gap: 15px; transition: border-color 2s ease-in-out, background-color 2s ease-in-out; }
        .control-group { display: flex; align-items: center; gap: 5px; }
        .central-controls { flex-grow: 1; min-width: 0; display: flex; justify-content: center; }
        #filter-controls, #timeline-container { display: flex; gap: 5px; overflow-x: auto; scrollbar-width: none; padding-bottom: 2px; }
        #filter-controls::-webkit-scrollbar, #timeline-container::-webkit-scrollbar { display: none; }
        
        .control-group-label { font-size: 0.8rem; font-weight: 700; color: #f0f2f5; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); white-space: nowrap; }
        .ticker-controls button { background-color: transparent; border: 1px solid #f0f2f5; color: #f0f2f5; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); border-radius: 4px; padding: 2px 8px; font-family: var(--font-body); font-size: 0.8rem; cursor: pointer; transition: all 0.2s; text-transform: capitalize; display: flex; align-items: center; gap: 5px; }
        .ticker-controls button:hover { background-color: #f0f2f5; color: #111; text-shadow: none; }
        .ticker-controls button.active { background-color: var(--accent-main); color: white; border-color: var(--accent-main); text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
        .icon-button svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2.5; }
        #night-mode-message { font-size: 0.8rem; font-weight: 500; color: #f0f2f5; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); transition: opacity 0.5s; white-space: nowrap; margin-left: auto; }
        #next-block-indicator { font-size: 0.8rem; font-weight: 700; color: #FFFFFF; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); background-color: var(--accent-gold); transition: all 0.5s ease-in-out; white-space: nowrap; margin-left: auto; padding: 3px 10px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .nav-controls { display: flex; align-items: center; gap: 10px; }
        #news-counter { font-size: 0.8rem; font-weight: 700; font-family: var(--font-display); letter-spacing: 0.5px; color: #f0f2f5; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); padding: 2px 8px; border: 1px solid transparent; border-radius: 4px; }
        
        #timeline-container { display: none; width: 100%; }
        #filter-control-group { display: flex; }
        body.night-mode-active #timeline-container { display: flex; }
        body.night-mode-active #filter-control-group { display: none; }
        #timeline-container button { flex-shrink: 0; padding: 2px 6px; font-size: 0.75rem; }
        #timeline-container button.active-hour { background-color: var(--accent-gold); border-color: var(--accent-gold); color: #000; text-shadow: none; }
        
        #refresh-overlay { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; z-index: 15; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease; gap: 10px; }
        #refresh-overlay.visible { opacity: 1; visibility: visible; }
        .refresh-text { font-size: 0.8rem; font-family: var(--font-body); color: var(--accent-main); font-weight: 500; }
        #animation-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; }
        #animated-logo-container { position: relative; display: flex; align-items: center; justify-content: center; width: 200px; height: 40px; }
        #animated-logo-container .ticker-logo { width: 28px; height: 28px; position: absolute; }
        #animated-logo-container .brand-name { font-size: 1.5rem; letter-spacing: 1px; visibility: hidden; color: #ECF0F1; }
        @keyframes eye-move-out-1 { from { left: 50%; transform: translateX(-50%); } to { left: calc(50% - 60px); transform: translateX(0); } }
        @keyframes eye-move-out-2 { from { left: 50%; transform: translateX(-50%); } to { left: calc(50% + 32px); transform: translateX(0); } }
        @keyframes brand-name-reveal { from { opacity: 0; letter-spacing: 5px; } to { opacity: 1; letter-spacing: 1px; } }
        @keyframes animated-eyelid-blink { 50% { transform: scaleY(0.1); } }
        #refresh-overlay.refresh-animation-active #animated-eye-logo-1 { animation: eye-move-out-1 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55) 0.5s forwards; }
        #refresh-overlay.refresh-animation-active #animated-eye-logo-2 { animation: eye-move-out-2 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55) 0.5s forwards; }
        #refresh-overlay.refresh-animation-active #animated-brand-name { visibility: visible; animation: brand-name-reveal 0.8s ease-out 0.8s forwards; }
        #refresh-overlay.refresh-animation-active .eyelid-anim { transform-origin: center; animation: animated-eyelid-blink 0.2s linear 0.2s 1; }
    </style>
</head>
<body data-theme-key="night">
    <section class="news-ticker-container">
        <div class="ticker-body">
            <div class="ticker-main-row">
                <div class="ticker-label" id="ticker-label">
                    <div id="intro-overlay">
                        <div class="color-bar" style="background-color: #c0c0c0;"></div> <div class="color-bar" style="background-color: #c0c000;"></div> <div class="color-bar" style="background-color: #00c0c0;"></div> <div class="color-bar" style="background-color: #00c000;"></div> <div class="color-bar" style="background-color: #c000c0;"></div> <div class="color-bar" style="background-color: #c00000;"></div> <div class="color-bar" style="background-color: #0000c0;"></div>
                    </div>

                    <div id="intro-animation-container">
                        <div id="intro-logo-wrapper">
                            <svg class="intro-eye" id="intro-eye-left" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                               <use href="#eye-paths"/>
                               <path class="eyelid" d="M2,12 C6,12 18,12 22,12" stroke="#2C3E50" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                            <span class="brand-name" id="intro-brand-name">TKP NEWS</span>
                            <svg class="intro-eye" id="intro-eye-right" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                               <use href="#eye-paths"/>
                               <path class="eyelid" d="M2,12 C6,12 18,12 22,12" stroke="#2C3E50" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    
                    <div id="label-image-container">
                        <img id="label-image" src="" alt="Hír kép">
                    </div>
                    
                    <div id="refresh-overlay">
                        <div id="animation-wrapper" style="display: none;">
                            <div id="animated-logo-container">
                                <svg class="ticker-logo" id="animated-eye-logo-1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                   <defs><linearGradient id="animatedEyeGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#E4E6EB"/><stop offset="100%" stop-color="#95A5A6"/></linearGradient></defs>
                                   <path d="M1,12 C1,12 5,4 12,4 C19,4 23,12 23,12 C23,12 19,20 12,20 C5,20 1,12 1,12 Z" stroke="url(#animatedEyeGrad)" stroke-width="1.5" fill="none"/>
                                   <circle cx="12" cy="12" r="3" fill="url(#animatedEyeGrad)"/>
                                   <path class="eyelid-anim" d="M2,12 C6,12 18,12 22,12" stroke="#2C3E50" stroke-width="3" stroke-linecap="round" />
                                </svg>
                               <div class="brand-container">
                                   <span class="brand-name" id="animated-brand-name">TKP NEWS</span>
                               </div>
                               <svg class="ticker-logo" id="animated-eye-logo-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                   <use href="#animatedEyeGrad"/>
                                   <path d="M1,12 C1,12 5,4 12,4 C19,4 23,12 23,12 C23,12 19,20 12,20 C5,20 1,12 1,12 Z" stroke="url(#animatedEyeGrad)" stroke-width="1.5" fill="none"/>
                                   <circle cx="12" cy="12" r="3" fill="url(#animatedEyeGrad)"/>
                                   <path class="eyelid-anim" d="M2,12 C6,12 18,12 22,12" stroke="#2C3E50" stroke-width="3" stroke-linecap="round" />
                                </svg>
                            </div>
                        </div>
                        <div class="refresh-text">Hírek frissítése...</div>
                    </div>

                    <div class="label-content">
                        <div class="label-top-row">
                             <svg class="ticker-logo" id="eye-logo" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="eyeGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#E4E6EB"/><stop offset="100%" stop-color="#95A5A6"/></linearGradient>
                                    <g id="eye-paths">
                                        <path d="M1,12 C1,12 5,4 12,4 C19,4 23,12 23,12 C23,12 19,20 12,20 C5,20 1,12 1,12 Z" stroke="url(#eyeGrad)" stroke-width="1.5" fill="none"/>
                                        <circle class="pupil" cx="12" cy="12" r="3" fill="url(#eyeGrad)"/>
                                    </g>
                                </defs>
                                <use href="#eye-paths"/>
                                <path id="eyelid" d="M2,12 C6,12 18,12 22,12" stroke="#2C3E50" stroke-width="3" stroke-linecap="round" style="transform: scaleY(0);"/>
                            </svg>
                            <div class="brand-container">
                                <span class="brand-name">TKP NEWS</span>
                            </div>
                            <svg class="ticker-logo" id="eye-logo-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <use href="#eye-paths"/>
                                <path id="eyelid-2" d="M2,12 C6,12 18,12 22,12" stroke="#2C3E50" stroke-width="3" stroke-linecap="round" style="transform: scaleY(0);"/>
                            </svg>
                        </div>
                        <div id="clock">--.--.--. ------ --:--</div>
                        <div id="nameday"></div>
                        <div id="manual-refresh-trigger" title="Hírek azonnali frissítése"></div>
                    </div>
                </div>
                <div class="ticker-wrap" id="ticker-wrap">
                    <div id="countdown-overlay">
                        <div id="countdown-clock"></div>
                        <div id="countdown-message">Nyugodalmas jó éjszakát!</div>
                    </div>
                    <div id="block-title-layer"></div>
                    <div id="breaking-title-layer"></div>
                    <div id="ticker-a" class="ticker-track visible"><div class="ticker-content"></div></div>
                    <div id="ticker-b" class="ticker-track"><div class="ticker-content"></div></div>
                    <div id="progress-bar-container"><div id="progress-bar"></div></div>
                </div>
            </div>
            <div class="ticker-controls">
                <div class="control-group nav-controls">
                    <button id="prev-btn" title="Előző hír"><svg class="icon-button" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg><span>Előző</span></button>
                    <span id="news-counter" style="display: none;"></span>
                    <button id="next-btn" title="Következő hír"><svg class="icon-button" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg><span>Következő</span></button>
                </div>
                <div class="central-controls">
                    <div id="timeline-container"></div>
                    <div class="control-group" id="filter-control-group">
                        <span class="control-group-label">Szűrő:</span>
                        <div id="filter-controls"></div>
                    </div>
                </div>
                <span id="night-mode-message" style="display: none;"></span>
                <span id="next-block-indicator" style="display: none;"></span>
            </div>
        </div>
        
        <div id="world-weather-container">
             <div class="placeholder">Időjárás adatok...</div>
             <div id="schedule-widget"></div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        
        // --- KONFIGURÁCIÓ ---
        const WUNDERGROUND_API_KEY = "e1f10a1e78da46f5b10a1e78da96f525"; 
        
        // PWS Állomások (ID -> Név)
        const PWS_MAP = {
            "ISRVR13": "Sárvár",
            "IOSZK4": "Oszkó",
            "ISZNTD6": "Szántód",
            "IBALAT149": "Balatonszemes",
            "IBUZSK1": "Csisztapuszta",
            "ISZEKS12": "Szekszárd",
            "IJNOSH2": "Jánoshalma",
            "IPCS52": "Pécs",
            "IPPRD1": "Páprád",
            "IKISKU42": "Kiskunhalas",
            "INEMES10": "Nemesnádudvar",
            "ISZEGE67": "Szeged",
            "IBKSCS12": "Békéscsaba",
            "IFZESG2": "Füzesgyarmat",
            "IMIKEP2": "Mikepércs",
            "ITGLS2": "Téglás",
            "IGACSL1": "Gacsály",
            "IFLESD1": "Fülesd",
            "IKISSZ3": "Kisszekeres",
            "ILEVEL2": "Levelek",
            "IKEMEC2": "Kemecse",
            "INAGYC6": "Nagycserkesz",
            "ITISZA15": "Tiszavasvári",
            "INEMES19": "Nemesbikk",
            "IEGERS22": "Egerszólát",
            "IBKKSZ5": "Bükkszenterzsébet",
            "IPSZT1": "Pásztó",
            "IPALOT13": "Palotás",
            "IGDLL37": "Gödöllő",
            "IZSMBK6": "Zsámbék",
            "ICSORN6": "Csorna",
            "IGAGYV1": "Gagyvendégi",
            "IMARTO122": "Martonyi",
            "IKAZIN14": "Kazincbarcika",
            "IPUTNO1": "Putnok",
            "IZABAR1": "Zabar",
            "ISALGT1": "Salgótarján",
            "IKARAN11": "Karancslapujtő",
            "IBEKLC3": "Bekölce",
            "IMTRAB1": "Mátraballa",
            "IVC267": "Vác",
            "IPILIS37": "Pilisvörösvár",
            "IFELCS4": "Felcsút",
            "IBUDAK6": "Budakeszi",
            "IBIATO9": "Biatorbágy",
            "ICSKVR4": "Csákvár",
            "IOROSZ2": "Oroszlány",
            "IBALINKA2": "Bakony",
            "ISR67": "Súr",
            "IPANNO3": "Pannonhalma",
            "IKAJRP2": "Kajárpéc",
            "IPPA11": "Pápa",
            "ICELLD14": "Celldömölk",
            "IHEVES2": "Heves",
            "IGYNGY22": "Gyöngyös",
            "ISZCSN9": "Szécsény",
            "ITAHIT11": "Tahitótfalu",
            "IESZTE5": "Esztergom",
            "ITATA16": "Tata",
            "IKARTAL4": "Kartal",
            "IMARTO67": "Martonvásár",
            "ISZOLNOK10": "Szolnok", 
            "ISZOLN13": "Szolnok",
            "INAGYK59": "Nagykőrös",
            "IKECSK31": "Kecskemét",
            "IKALOCSA2": "Kalocsa",
            "IBONYH1": "Bonyhád",
            "ISZENT114": "Szentlőrinc",
            "ILJUBL47": "Ljubljana",
            "IBAKTA4": "Baktalórántháza",
            "IJFEHR1": "Újfehértó",
            "IPAPOS6": "Papos",
            "ISONKD1": "Sonkád",
            "INAPKO1": "Napkor",
            "IHARSN4": "Harsány",
            "IBKKSZ2": "Bükkszentkereszt",
            "INYREG37": "Nyíregyháza",
            "IPUSZT3": "Pusztadobos",
            "ITISZA93": "Tiszaújváros",
            "IEGER76": "Eger",
            "IHAJDD7": "Hajdúdorog",
            "IGYULA12": "Gyula",
            "IMAGYA4": "Magyarcsanád",
            "IHDMEZ21": "Hódmezővásárhely",
            "ISZEGE23": "Szeged-Rókus",
            "ICSENG9": "Csengele",
            "INAGYN1": "Nagynyárád",
            "IKIRLY1": "Királyegyháza",
            "ITAMSI1": "Tamási",
            "IZALAE45": "Zalaegerszeg",
            "IFARKA7": "Farkasgyepű",
            "INYRAC1": "Nyíracsád",
            "ISZAMO11": "Szamosújlak",
            "IGVAVE1": "Gávavencsellő",
            "IEDELN2": "Edelény",
            "INYRI1": "Nyíri",
            "IBTTS1": "Büttös",
            "IZD2": "Ózd"
        };

        // Külföldi városlista (Open-Meteo) - Bővített 50 db
        const FOREIGN_CITIES = [ 
            { name: 'London', lat: 51.50, lon: -0.12 }, { name: 'New York', lat: 40.71, lon: -74.00 }, { name: 'Tokió', lat: 35.68, lon: 139.69 }, { name: 'Peking', lat: 39.90, lon: 116.40 },
            { name: 'Moszkva', lat: 55.75, lon: 37.61 }, { name: 'Sydney', lat: -33.86, lon: 151.20 }, { name: 'Párizs', lat: 48.85, lon: 2.35 }, { name: 'Berlin', lat: 52.52, lon: 13.40 },
            { name: 'Róma', lat: 41.90, lon: 12.49 }, { name: 'Dubai', lat: 25.20, lon: 55.27 }, { name: 'Isztambul', lat: 41.00, lon: 28.97 }, { name: 'Bécs', lat: 48.20, lon: 16.37 },
            { name: 'Los Angeles', lat: 34.05, lon: -118.24 }, { name: 'Rio de Janeiro', lat: -22.90, lon: -43.17 }, { name: 'Kairó', lat: 30.04, lon: 31.23 }, { name: 'Fokváros', lat: -33.92, lon: 18.42 },
            { name: 'Oslo', lat: 59.91, lon: 10.75 }, { name: 'Szingapúr', lat: 1.35, lon: 103.81 }, { name: 'Buenos Aires', lat: -34.60, lon: -58.38 }, { name: 'Madrid', lat: 40.41, lon: -3.70 },
            { name: 'Amszterdam', lat: 52.36, lon: 4.89 }, { name: 'Toronto', lat: 43.65, lon: -79.38 }, { name: 'Helsinki', lat: 60.16, lon: 24.93 }, { name: 'Lisszabon', lat: 38.72, lon: -9.13 },
            { name: 'Athén', lat: 37.98, lon: 23.72 }, { name: 'Dublin', lat: 53.34, lon: -6.26 }, { name: 'Újdelhi', lat: 28.61, lon: 77.20 }, { name: 'Bangkok', lat: 13.75, lon: 100.50 },
            { name: 'Szöul', lat: 37.56, lon: 126.97 }, { name: 'Jakarta', lat: -6.20, lon: 106.84 }, { name: 'Lima', lat: -12.04, lon: -77.04 }, { name: 'Nairobi', lat: -1.29, lon: 36.82 },
            { name: 'Stockholm', lat: 59.32, lon: 18.06 }, { name: 'Varsó', lat: 52.22, lon: 21.01 }, { name: 'Prága', lat: 50.07, lon: 14.43 },
            { name: 'Mexikóváros', lat: 19.43, lon: -99.13 }, { name: 'Mumbai', lat: 19.07, lon: 72.87 }, { name: 'São Paulo', lat: -23.55, lon: -46.63 }, { name: 'Kijev', lat: 50.45, lon: 30.52 },
            { name: 'Brüsszel', lat: 50.85, lon: 4.35 }, { name: 'Koppenhága', lat: 55.67, lon: 12.56 }, { name: 'Reykjavík', lat: 64.14, lon: -21.94 }, { name: 'Tel-Aviv', lat: 32.08, lon: 34.78 },
            { name: 'Hongkong', lat: 22.31, lon: 114.16 }, { name: 'Sanghaj', lat: 31.23, lon: 121.47 }, { name: 'Vancouver', lat: 49.28, lon: -123.12 }, { name: 'Santiago', lat: -33.44, lon: -70.66 },
            { name: 'Casablanca', lat: 33.57, lon: -7.58 }, { name: 'Manila', lat: 14.59, lon: 120.98 }, { name: 'Chicago', lat: 41.87, lon: -87.62 }, { name: 'Las Vegas', lat: 36.16, lon: -115.13 },
            { name: 'Miami', lat: 25.76, lon: -80.19 }, { name: 'München', lat: 48.13, lon: 11.58 }
        ];

        const firebaseConfig = { apiKey: "AIzaSyDgBgiNSxjgWP_jmaoHpf0Qejo8_OO4sPg", authDomain: "robi-oldala.firebaseapp.com", databaseURL: "https://robi-oldala-default-rtdb.europe-west1.firebasedatabase.app", projectId: "robi-oldala", storageBucket: "robi-oldala.appspot.com", messagingSenderId: "300815778397", appId: "1:300815778397:web:ec609be55cc8afd193c3b4" };
        
        const CORS_PROXIES = [
            "https://cors.eu.org/",
            "https://cors-proxy.fringe.zone/",
            "https://thingproxy.freeboard.io/fetch/"
        ];
        
        const BREAKING_KEYWORDS = ['rendkívüli', 'fontos bejelentés', 'most érkezett', 'élőben', 'percről percre', 'breaking', 'rakétacsapás', 'háború'];
        
        const CATEGORY_KEYWORDS = { belföld: ['belföld', 'magyar', 'budapest', 'kormány', 'parlament', 'rendőrség', 'tüntetés', 'forint', 'belügy', 'oktatás'], külföld: ['külföld', 'ukrajna', 'oroszország', 'brüsszel', 'háború', 'európa', 'amerika', 'kína', 'gáza', 'izrael', 'NATO'], gazdaság: ['gazdaság', 'forint', 'euró', 'infláció', 'tőzsde', 'mnb', 'költségvetés', 'adó', 'piac', 'portfolio'], sport: ['sport', 'foci', 'nb1', 'bajnokok ligája', 'forma-1', 'olimpia', 'kézilabda', 'vízilabda', ' FTC', 'válogatott', 'meccs', 'nemzeti sport'], tech: ['tech', 'tudomány', 'mobil', 'apple', 'google', 'mesterséges intelligencia', 'űrkutatás', 'innováció', 'AI', 'elon musk'], 'kékfény': ['kékfény', 'rendőrség', 'baleset', 'bűncselekmény', 'tűz', 'katasztrófa', 'ítélet', 'nyomozás'] };
        const QUOTES = [
            { text: "A legjobb módja a jövő megjóslásának, ha feltaláljuk.", author: "Alan Kay" }, { text: "Az egyetlen korlátot a valóság megteremtésében a képzeletünk szabja.", author: "Ray Bradbury" }, { text: "A siker nem végleges, a kudarc nem végzetes: a folytatáshoz való bátorság az, ami számít.", author: "Winston Churchill" },
            { text: "Az élet 10%-a, ami veled történik, és 90%-a, ahogyan reagálsz rá.", author: "Charles R. Swindoll" }, { text: "Nem az számít, hogy hányszor buksz el, hanem hogy hányszor állsz fel.", author: "Vince Lombardi" }, { text: "A képzelet fontosabb, mint a tudás.", author: "Albert Einstein" },
            { text: "Légy a változás, amit a világban látni szeretnél.", author: "Mahatma Gandhi" }, { text: "Aki nem követ el hibákat, az nem próbálkozik semmi újjal.", author: "Albert Einstein" }, { text: "A legnehezebb dolog a döntés, a többi már csak kitartás kérdése.", author: "Amelia Earhart" },
            { text: "A tegnap a múlt, a holnap a jövő, a ma ajándék.", author: "Eleanor Roosevelt" }, { text: "Az egyetlen út a nagyszerű munkához, ha szereted, amit csinálsz.", author: "Steve Jobs" }, { text: "Az akadályok azok az ijesztő dolgok, amiket akkor látsz, ha leveszed a szemed a célról.", author: "Henry Ford" },
            { text: "Nem azért vallunk kudarcot, mert elbukunk, hanem mert feladjuk.", author: "Konfuciusz" }, { text: "A boldogság nem egy úti cél. Hanem egy utazás.", author: "Roy M. Goodman" }, { text: "A tudás hatalom.", author: "Francis Bacon" },
            { text: "Aki hegyet akar mozgatni, apró kövek elhordásával kezdi.", author: "Konfuciusz" }, { text: "A kreativitás intelligencia, ami szórakozik.", author: "Albert Einstein" }, { text: "A legjobb bosszú a hatalmas siker.", author: "Frank Sinatra" },
            { text: "Aki nem hisz önmagában, az senki másban sem fog hinni.", author: "Roy T. Bennett" }, { text: "A jövő azoké, akik hisznek álmaik szépségében.", author: "Eleanor Roosevelt" }, { text: "Az ezer mérföldes utazás is egyetlen lépéssel kezdődik.", author: "Lao-ce" },
            { text: "A legfontosabb dolog, hogy élvezd az életed – hogy boldog légy –, ez minden, ami számít.", author: "Audrey Hepburn" }, { text: "A siker kulcsa nem a kudarc elkerülése, hanem a kudarcból való tanulás.", author: "Lass Small" }, { text: "A lehetőségek nem kopogtatnak, hanem te teremted meg őket.", author: "Chris Grosser" },
            { text: "A kemény munka legyőzi a tehetséget, ha a tehetség nem dolgozik keményen.", author: "Tim Notke" }, { text: "A ma olvasója holnap vezető lesz.", author: "Margaret Fuller" }, { text: "A bátorság nem a félelem hiánya, hanem a félelem legyőzése.", author: "Nelson Mandela" },
            { text: "Aki mindig a tömegben jár, nem jut messzebb a tömegnél.", author: "Albert Einstein" }, { text: "Az élet olyan, mint a biciklizés. Ahhoz, hogy egyensúlyban maradj, mozognod kell.", author: "Albert Einstein" }, { text: "A legnagyobb dicsőség nem az, ha soha nem bukunk el, hanem ha minden bukás után felállunk.", author: "Konfuciusz" },
            { text: "A siker a lelkesedés elvesztése nélküli haladás kudarcról kudarcra.", author: "Winston Churchill" }, { text: "A tett minden tudás virága és gyümölcse.", author: "James Allen" }, { text: "Aki mindent megért, az mindent megbocsát.", author: "Buddha" },
            { text: "A türelem keserű, de a gyümölcse édes.", author: "Jean-Jacques Rousseau" }, { text: "A világ egy könyv, és aki nem utazik, az csak egy lapot olvas el belőle.", author: "Szent Ágoston" }
        ];
        const CALENDAR_DATA = { honapok: ["január", "február", "március", "április", "május", "június", "július", "augusztus", "szeptember", "október", "november", "december"], napok: ["vasárnap", "hétfő", "kedd", "szerda", "csütörtök", "péntek", "szombat"], nameDays: { "01-01": ["Fruzsina"], "01-02": ["Ábel"], "01-03": ["Benjámin", "Genovéva"], "01-04": ["Leóna", "Titusz"], "01-05": ["Simon"],"01-06": ["Boldizsár"], "01-07": ["Attila", "Ramóna"], "01-08": ["Gyöngyvér"], "01-09": ["Marcell"], "01-10": ["Melánia"],"01-11": ["Ágota"], "01-12": ["Ernő"], "01-13": ["Veronika"], "01-14": ["Bódog"], "01-15": ["Lóránd", "Lóránt"],"01-16": ["Gusztáv"], "01-17": ["Antal", "Antónia"], "01-18": ["Piroska"], "01-19": ["Márió", "Sára"], "01-20": ["Fábián", "Sebestyén"],"01-21": ["Ágnes"], "01-22": ["Artúr", "Vince"], "01-23": ["Rajmund", "Zelma"], "01-24": ["Timót"], "01-25": ["Pál"],"01-26": ["Paula", "Vanda"], "01-27": ["Angelika"], "01-28": ["Karola", "Károly"], "01-29": ["Adél"], "01-30": ["Martina"], "01-31": ["Gerda", "Marcella"],"02-01": ["Ignác"], "02-02": ["Aida", "Karolina"], "02-03": ["Balázs"], "02-04": ["Csenge", "Ráhel"], "02-05": ["Ágota", "Ingrid"],"02-06": ["Dóra", "Dorottya"], "02-07": ["Rómeó", "Tódor"], "02-08": ["Aranka"], "02-09": ["Abigél", "Alex"], "02-10": ["Elvira"],"02-11": ["Bertold", "Marietta"], "02-12": ["Lídia", "Lívia"], "02-13": ["Ella", "Linda"], "02-14": ["Bálint", "Valentin"],"02-15": ["Georgina", "Kolos"], "02-16": ["Julianna", "Lilla"], "02-17": ["Donát"], "02-18": ["Bernadett"], "02-19": ["Zsuzsanna"],"02-20": ["Aladár", "Álmos"], "02-21": ["Eleonóra"], "02-22": ["Gerzson"], "02-23": ["Alfréd"], "02-24": ["Mátyás"],"02-25": ["Géza"], "02-26": ["Edina"], "02-27": ["Ákos", "Bátor"], "02-28": ["Elemér"], "02-29": ["Szökőnap"],"03-01": ["Albin"], "03-02": ["Lujza"], "03-03": ["Kornélia"], "03-04": ["Kázmér"], "03-05": ["Adorján", "Adrián"],"03-06": ["Inez", "Leonóra"], "03-07": ["Tamás"], "03-08": ["Zoltán"], "03-09": ["Fanni", "Franciska"], "03-10": ["Ildikó"],"03-11": ["Szilárd"], "03-12": ["Gergely"], "03-13": ["Ajtony", "Krisztián"], "03-14": ["Matild"], "03-15": ["Kristóf"],"03-16": ["Henrietta"], "03-17": ["Gertrúd", "Patrik"], "03-18": ["Ede", "Sándor"], "03-19": ["Bánk", "József"], "03-20": ["Klaudia"],"03-21": ["Benedek"], "03-22": ["Beáta", "Izolda"], "03-23": ["Emőke"], "03-24": ["Gábor", "Karina"], "03-25": ["Irén", "Írisz"],"03-26": ["Emánuel"], "03-27": ["Hajnalka"], "03-28": ["Gedeon", "Johanna"], "03-29": ["Auguszta"], "03-30": ["Zalán"], "03-31": ["Árpád"],"04-01": ["Hugó"], "04-02": ["Áron"], "04-03": ["Buda", "Richárd"], "04-04": ["Izidor"], "04-05": ["Vince"], "04-06": ["Bíborka", "Vilmos"],"04-07": ["Herman"], "04-08": ["Dénes"], "04-09": ["Erhard"], "04-10": ["Zsolt"], "04-11": ["Leó", "Szaniszló"], "04-12": ["Gyula"],"04-13": ["Ida"], "04-14": ["Tibor"], "04-15": ["Anasztázia", "Tas"], "04-16": ["Csongor"], "04-17": ["Rudolf"],"04-18": ["Andrea", "Ilma"], "04-19": ["Emma"], "04-20": ["Tivadar"], "04-21": ["Konrád"], "04-22": ["Csilla", "Noémi"],"04-23": ["Béla"], "04-24": ["György"], "04-25": ["Márk"], "04-26": ["Ervin"], "04-27": ["Zita"], "04-28": ["Valéria"],"04-29": ["Péter"], "04-30": ["Katalin", "Kitti"],"05-01": ["Fülöp", "Jakab"], "05-02": ["Zsigmond"], "05-03": ["Irma", "Tímea"], "05-04": ["Flórián", "Mónika"], "05-05": ["Adrián", "Györgyi"],"05-06": ["Frida", "Ivett"], "05-07": ["Gizella"], "05-08": ["Mihály"], "05-09": ["Gergely"], "05-10": ["Ármin", "Pálma"],"05-11": ["Ferenc"], "05-12": ["Pongrác"], "05-13": ["Imola", "Szervác"], "05-14": ["Bonifác"], "05-15": ["Szonja", "Zsófia"],"05-16": ["Botond", "Mózes"], "05-17": ["Paszkál"], "05-18": ["Alexandra", "Erik"], "05-19": ["Ivó", "Milán"], "05-20": ["Bernát", "Felícia"],"05-21": ["Konstantin"], "05-22": ["Júlia", "Rita"], "05-23": ["Dezső"], "05-24": ["Eliza", "Eszter"], "05-25": ["Orbán"],"05-26": ["Evelin", "Fülöp"], "05-27": ["Hella"], "05-28": ["Csanád", "Emil"], "05-29": ["Magdolna"], "05-30": ["Janka", "Zsanett"], "05-31": ["Angéla"],"06-01": ["Tünde"], "06-02": ["Anita", "Kármen"], "06-03": ["Klotild"], "06-04": ["Bulcsú"], "06-05": ["Fatime"], "06-06": ["Cintia", "Norbert"],"06-07": ["Róbert"], "06-08": ["Medárd"], "06-09": ["Félix"], "06-10": ["Gréta", "Margit"], "06-11": ["Barnabás"], "06-12": ["Villő"],"06-13": ["Anett", "Antal"], "06-14": ["Vazul"], "06-15": ["Jolán", "Vid"], "06-16": ["Jusztin"], "06-17": ["Alida", "Laura"],"06-18": ["Arnold", "Levente"], "06-19": ["Gyárfás"], "06-20": ["Rafael"], "06-21": ["Alajos", "Leila"], "06-22": ["Paulina"],"06-23": ["Zoltán"], "06-24": ["Iván"], "06-25": ["Vilmos"], "06-26": ["János", "Pál"], "06-27": ["László"], "06-28": ["Irén", "Levente"],"06-29": ["Péter", "Pál"], "06-30": ["Pál"],"07-01": ["Annamária", "Tihamér"], "07-02": ["Ottó"], "07-03": ["Kornél", "Soma"], "07-04": ["Ulrik"], "07-05": ["Emese", "Sarolta"],"07-06": ["Csaba"], "07-07": ["Apollónia"], "07-08": ["Ellák"], "07-09": ["Lukrécia"], "07-10": ["Amália"], "07-11": ["Lili", "Nóra"],"07-12": ["Dalma", "Izabella"], "07-13": ["Jenő"], "07-14": ["Örs", "Stella"], "07-15": ["Henrik", "Roland"], "07-16": ["Valter"],"07-17": ["Elek", "Endre"], "07-18": ["Frigyes"], "07-19": ["Emília"], "07-20": ["Illés"], "07-21": ["Dániel", "Daniella"],"07-22": ["Magdolna"], "07-23": ["Lenke"], "07-24": ["Kincső", "Kinga"], "07-25": ["Jakab", "Kristóf"], "07-26": ["Anikó", "Anna"],"07-27": ["Liliána", "Olga"], "07-28": ["Szabolcs"], "07-29": ["Flóra", "Márta"], "07-30": ["Judit", "Xénia"], "07-31": ["Oszkár"],"08-01": ["Boglárka"], "08-02": ["Lehel"], "08-03": ["Hermina"], "08-04": ["Dominika", "Dominik", "Domonkos"], "08-05": ["Krisztina"],"08-06": ["Berta", "Bettina"], "08-07": ["Ibolya"], "08-08": ["László"], "08-09": ["Emőd"], "08-10": ["Lőrinc"],"08-11": ["Tiborc", "Zsuzsanna"], "08-12": ["Klára"], "08-13": ["Ipoly"], "08-14": ["Marcell"], "08-15": ["Mária"],"08-16": ["Ábrahám"], "08-17": ["Jácint"], "08-18": ["Ilona"], "08-19": ["Huba"], "08-20": ["István"],"08-21": ["Hajna", "Sámuel"], "08-22": ["Menyhért", "Mirjam"], "08-23": ["Bence"], "08-24": ["Bertalan"], "08-25": ["Lajos", "Patrícia"],"08-26": ["Izsó"], "08-27": ["Gáspár"], "08-28": ["Ágoston"], "08-29": ["Beatrix", "Erna"], "08-30": ["Rózsa"], "08-31": ["Bella", "Erika"],"09-01": ["Egon", "Egyed"], "09-02": ["Dorina", "Rebeka"], "09-03": ["Hilda"], "09-04": ["Rozália"], "09-05": ["Lőrinc", "Viktor"],"09-06": ["Zakariás"], "09-07": ["Regina"], "09-08": ["Adrienn", "Mária"], "09-09": ["Ádám"], "09-10": ["Hunor", "Nikolett"],"09-11": ["Teodóra"], "09-12": ["Mária"], "09-13": ["Kornél"], "09-14": ["Roxána", "Szeréna"], "09-15": ["Enikő", "Melitta"],"09-16": ["Edit"], "09-17": ["Zsófia"], "09-18": ["Diána"], "09-19": ["Vilhelmina"], "09-20": ["Friderika"], "09-21": ["Máté", "Mirella"],"09-22": ["Móric"], "09-23": ["Tekla"], "09-24": ["Gellért", "Mercédesz"], "09-25": ["Eufrozina", "Kende"], "09-26": ["Jusztina", "Pál"],"09-27": ["Adalbert"], "09-28": ["Vencel"], "09-29": ["Mihály"], "09-30": ["Jeromos"],"10-01": ["Malvin"], "01-02": ["Petra"], "10-03": ["Helga"], "10-04": ["Ferenc"], "10-05": ["Aurél"], "10-06": ["Brúnó", "Renáta"],"10-07": ["Amália"], "10-08": ["Koppány"], "10-09": ["Dénes"], "10-10": ["Gedeon"], "10-11": ["Brigitta"], "10-12": ["Miksa"],"10-13": ["Ede", "Kálmán"], "10-14": ["Helén"], "10-15": ["Teréz"], "10-16": ["Gál"], "10-17": ["Hedvig"], "10-18": ["Lukács"],"09-19": ["Nándor"], "10-20": ["Vendel"], "10-21": ["Orsolya"], "10-22": ["Előd"], "10-23": ["Gyöngyi"], "10-24": ["Salamon"],"10-25": ["Bianka", "Blanka"], "10-26": ["Dömötör"], "10-27": ["Szabina"], "10-28": ["Simon", "Szimonetta"], "10-29": ["Nárcisz"],"10-30": ["Alfonz"], "10-31": ["Farkas"],"11-01": ["Marianna"], "11-02": ["Achilles"], "11-03": ["Győző"], "11-04": ["Károly"], "11-05": ["Imre"], "11-06": ["Lénárd"],"11-07": ["Rezső"], "11-08": ["Zsombor"], "11-09": ["Tivadar"], "11-10": ["Réka"], "11-11": ["Márton"], "11-12": ["Jónás", "Renátó"],"11-13": ["Szilvia"], "11-14": ["Aliz"], "11-15": ["Albert", "Lipót"], "11-16": ["Ödön"], "11-17": ["Gergely", "Hortenzia"],"11-18": ["Jenő"], "11-19": ["Erzsébet", "Elizabet"], "11-20": ["Jolán"], "11-21": ["Olivér"], "11-22": ["Cecília"],"11-23": ["Kelemen", "Klementina"], "11-24": ["Emma"], "11-25": ["Katalin"], "11-26": ["Virág"], "11-27": ["Virgil"],"11-28": ["Stefánia"], "11-29": ["Taksony"], "11-30": ["Andor", "András"],"12-01": ["Elza"], "12-02": ["Melinda", "Vivien"], "12-03": ["Ferenc", "Olívia"], "12-04": ["Barbara", "Borbála"], "12-05": ["Vilma"],"12-06": ["Miklós"], "12-07": ["Ambrus"], "12-08": ["Mária"], "12-09": ["Natália"], "12-10": ["Judit"], "12-12": ["Gabriella"], "12-13": ["Luca", "Otília"], "12-14": ["Szilárda"], "12-15": ["Valér"], "12-16": ["Aletta", "Etelka"],"12-17": ["Lázár", "Olimpia"], "12-18": ["Auguszta"], "12-19": ["Viola"], "12-20": ["Teofil"], "12-21": ["Tamás"],"12-22": ["Zénó"], "12-23": ["Viktória"], "12-24": ["Ádám", "Éva"], "12-25": ["Eugénia"], "12-26": ["István"],"12-27": ["János"], "12-28": ["Kamilla"], "12-29": ["Tamara", "Tamás"], "12-30": ["Dávid"], "12-31": ["Szilveszter"] } };
        
        const THEMATIC_BLOCKS = [
            { start: 0,    name: 'Éjszakai műszak',      type: 'summary_yesterday',        categories: [], desc: "Csendes percek, amíg a város alszik – itt a tegnap legjava." },
            { start: 6,    name: 'Napindító',            type: 'fresh',                    timeWindowHours: 2, categories: [], desc: "Éjszakai események és a reggel első hírei egy csokorban." },
            { start: 7,    name: 'Reggeli gyors',        type: 'fresh',                    timeWindowHours: 2, categories: [], desc: "Jó reggelt! Kávé mellé tálaljuk a legfrissebbeket." },
            { start: 9,    name: 'Délelőtt a TKP NEWS-al', type: 'fresh',                    timeWindowHours: 2, categories: [], desc: "Lendületben a nap – tarts velünk munka közben is!" },
            { start: 12,   name: 'Délidőben',            type: 'fresh',                    timeWindowHours: 2, categories: [], desc: "Ebédidő? Kapcsolódj ki egy kis friss információval!" },
            { start: 13,   name: 'Délután a TKP NEWS-al',type: 'fresh',                    timeWindowHours: 2, categories: [], desc: "Délutáni körkép: lássuk, merre tart a világ ma." },
            { start: 18,   name: 'Esti gyors',           type: 'fresh',                    timeWindowHours: 2, categories: [], desc: "Munkából hazafelé? Ez történt, míg te dolgoztál." },
            { start: 20,   name: 'Este a TKP NEWS-al',   type: 'fresh',                    timeWindowHours: 2, categories: [], desc: "Esti lazítás: a nap legfontosabb pillanatai egy helyen." },
            { start: 22,   name: 'Késő este a TKP NEWS-al', type: 'fresh',                 timeWindowHours: 4, refreshMinutes: 20, categories: [], desc: "Még nem alszol? Mi sem! Friss hírek éjszakai baglyoknak." },
            { start: 23.98333, name: 'Elköszönés',       type: 'goodbye',                  categories: [], desc: "Köszönjük a figyelmed, holnap is várunk szeretettel!" }
        ];

        const NYIREGYHAZA_COORDS = { lat: 47.95, lon: 21.71 };
        const SKY_PALETTE = {
            DEEP_NIGHT:   { themeKey: 'night',   textColorMode: 'night', top: '#020111', bottom: '#191621' },
            PRE_DAWN:     { themeKey: 'predawn', textColorMode: 'night', top: '#110d2e', bottom: '#3a265e' },
            DAWN:         { themeKey: 'dawn',    textColorMode: 'night', top: '#2c2a65', bottom: '#785a9b' },
            SUNRISE:      { themeKey: 'sunrise', textColorMode: 'night', top: '#5f69c4', bottom: '#f89a7a' },
            MORNING:      { themeKey: 'morning', textColorMode: 'day',   top: '#7DD3FC', bottom: '#C4EFFF' },
            LATE_MORNING: { themeKey: 'day',     textColorMode: 'day',   top: '#5bb8f2', bottom: '#a6ddf6' },
            NOON:         { themeKey: 'day',     textColorMode: 'day',   top: '#2e92e1', bottom: '#84c5f1' },
            AFTERNOON:    { themeKey: 'afternoon',textColorMode: 'day',   top: '#0e67b1', bottom: '#f4a974' },
            SUNSET:       { themeKey: 'sunset',  textColorMode: 'night', top: '#1b328a', bottom: '#f77b5a' },
            DUSK:         { themeKey: 'dusk',    textColorMode: 'night', top: '#1d215b', bottom: '#87517c' },
            EVENING:      { themeKey: 'evening', textColorMode: 'night', top: '#0f0e34', bottom: '#483475' }
        };
        const THEME_COLORS = {
            day:   { textPrimary: '#2c3e50', textSecondary: '#5d6d7e', borderColor: 'rgba(0,0,0,0.1)', itemBg: 'rgba(245, 245, 245, 0.85)', itemBorder: 'rgba(0, 0, 0, 0.1)' },
            night: { textPrimary: '#f0f2f5', textSecondary: '#a8b3c2', borderColor: '#3A3B3C', itemBg: 'rgba(28, 28, 30, 0.85)', itemBorder: 'rgba(255, 255, 255, 0.2)' }
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const feedsRef = ref(database, 'feeds');
        const announcementsRef = ref(database, 'announcements');

        const tracks = { a: document.getElementById('ticker-a'), b: document.getElementById('ticker-b') };
        const tickerWrap = document.getElementById('ticker-wrap');
        const filterControls = document.getElementById('filter-controls');
        const bodyEl = document.body;
        const tickerLabel = document.getElementById('ticker-label');
        const filterControlGroup = document.getElementById('filter-control-group');
        const nightModeMessage = document.getElementById('night-mode-message');
        const worldWeatherContainer = document.getElementById('world-weather-container');
        const brandNameEl = document.querySelector('.brand-name');
        const namedayEl = document.getElementById('nameday');
        const labelContent = document.querySelector('.label-content');
        const labelImageContainer = document.getElementById('label-image-container');
        const labelImage = document.getElementById('label-image');
        const refreshOverlay = document.getElementById('refresh-overlay');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const newsCounter = document.getElementById('news-counter');
        const timelineContainer = document.getElementById('timeline-container');
        const animationWrapper = document.getElementById('animation-wrapper');
        const manualRefreshTriggerEl = document.getElementById('manual-refresh-trigger');
        const nextBlockIndicatorEl = document.getElementById('next-block-indicator');
        const progressBar = document.getElementById('progress-bar');
        const introAnimationContainer = document.getElementById('intro-animation-container');
        const countdownOverlayEl = document.getElementById('countdown-overlay');
        const countdownClockEl = document.getElementById('countdown-clock');


        let activeTrackKey = 'a', rssFeeds = {}, customAnnouncements = [], updateTimeout = null, debounceTimeout = null;
        let activeFilter = 'all';
        let currentThematicBlock = null;
        let newsFetchRetryTimeout = null;
        let masterNewsList = [];
        let fullFilteredNewsList = [];
        let currentFilterPage = 1;
        const FILTER_CHUNK_SIZE = 40;
        
        let flipTimeoutId = null, currentItemIndex = 0, flipStartTime = 0, flipRemainingTime = 0;
        const FLIP_INTERVAL_REGULAR = 15000;
        const FLIP_INTERVAL_INFO = 10000;
        const FLIP_INTERVAL_ANNOUNCEMENT = 15000;

        // BREAKING NEWS GLOBALS
        let breakingNewsQueue = [];
        let isShowingBreaking = false;
        let lastRegularItemIndex = 0; // Hogy visszataláljunk

        let weatherDisplayInterval = null, weatherFetchInterval = null;
        let pwsDataStore = [];
        let foreignDataStore = [];
        let weatherPlaylist = [];
        let weatherIndex = 0;
        const WEATHER_DISPLAY_INTERVAL_DURATION = 8000;
        
        let textGlitchTimeout = null;
        let lastUpdateMinute = -1;
        let lastScheduleMinute = -1;
        let scheduleWidgetTimeout = null;
        
        let fetchStartTime = 0;
        let loadingTimeout = null;
        let isInfoMessageActive = false;
        let isContentLoaded = false;
        let currentNewsLinks = new Set();
        let newsCheckInterval = null;
        let lastNewsCheckTimestamp = 0;
        let accumulatedNewNewsCount = 0;
        let wasPreviousItemBreaking = false;
        let isCountdownActive = false;
        
        async function fetchWithProxyFallback(url) {
            for (const proxy of CORS_PROXIES) {
                try {
                    const response = await fetch(proxy + url, { signal: AbortSignal.timeout(10000) });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    // console.log(`Sikeres letöltés a(z) ${proxy} proxy-n keresztül: ${url}`);
                    return response;
                } catch (error) {
                    // console.warn(`Proxy hiba (${proxy}): ${error.message}. Próbálkozás a következővel...`);
                }
            }
            throw new Error(`Minden proxy sikertelen volt a forrás letöltésekor: ${url}`);
        }


        const stripHtml = (html) => { let doc = new DOMParser().parseFromString(html, 'text/html'); return doc.body.textContent || ""; };
        
        const getSmartDescription = (text, maxLength = 220) => {
            if (!text || text.length <= maxLength) return text;
            let truncated = text.substring(0, maxLength);
            let lastPunctuation = Math.max(truncated.lastIndexOf('.'), truncated.lastIndexOf('!'), truncated.lastIndexOf('?'));
            if (lastPunctuation > maxLength / 2) { return truncated.substring(0, lastPunctuation + 1); }
            let lastSpace = truncated.lastIndexOf(' ');
            return truncated.substring(0, lastSpace > 0 ? lastSpace : maxLength) + '...';
        };

        const extractImageUrl = (item, fullDescriptionHtml) => {
            const mediaContent = item.querySelector('media\\:content, content');
            if (mediaContent && mediaContent.getAttribute('medium') === 'image' && mediaContent.getAttribute('url')) { return mediaContent.getAttribute('url'); }
            if (mediaContent && /\.(jpg|jpeg|png|webp)$/i.test(mediaContent.getAttribute('url'))) { return mediaContent.getAttribute('url'); }
            const enclosure = item.querySelector('enclosure');
            if (enclosure && enclosure.getAttribute('type')?.startsWith('image') && enclosure.getAttribute('url')) { return enclosure.getAttribute('url'); }
            try {
                const doc = new DOMParser().parseFromString(fullDescriptionHtml, 'text/html');
                const img = doc.querySelector('img');
                if (img && img.src) { return img.src; }
            } catch (e) { /* Parsing might fail */ }
            return null;
        };

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getRainDescription(rate) {
            if (rate <= 0) return null;
            if (rate < 0.2) return "Pár csepp";
            if (rate < 2.5) return "Gyenge eső";
            if (rate < 7.6) return "Mérsékelt eső";
            if (rate < 50) return "Heves eső";
            return "Felhőszakadás";
        }

        function getPrecipitationText(rate, temp) {
            if (rate <= 0) return null;
            const isSnow = temp <= 1.5; 
            if (rate < 0.2) return isSnow ? "Hószállingózás" : "Pár csepp";
            if (rate < 2.5) return isSnow ? "Havazás / Olvadás" : "Gyenge eső";
            if (rate < 7.6) return isSnow ? "Mérsékelt havazás" : "Mérsékelt eső";
            return isSnow ? "Erős havazás" : "Felhőszakadás";
        }

        function getWindDirection(deg) {
            if (deg === undefined || deg === null) return "";
            const directions = ["Északi", "Északkeleti", "Keleti", "Délkeleti", "Déli", "Délnyugati", "Nyugati", "Északnyugati"];
            const index = Math.round(((deg %= 360) < 0 ? deg + 360 : deg) / 45) % 8;
            return directions[index];
        }

        function calculateComplexRealFeel(temp, humidity, windSpeed, solarRad) {
            if (temp <= 10) {
                if (windSpeed >= 4.8) {
                    return 13.12 + 0.6215 * temp - 11.37 * Math.pow(windSpeed, 0.16) + 0.3965 * temp * Math.pow(windSpeed, 0.16);
                }
                if (solarRad > 0) {
                    return temp + (solarRad / 400);
                }
                return temp;
            }
            if (temp >= 27) {
                const c1 = -8.78469475556;
                const c2 = 1.61139411;
                const c3 = 2.33854883889;
                const c4 = -0.14611605;
                const c5 = -0.012308094;
                const c6 = -0.0164248277778;
                const c7 = 0.002211732;
                const c8 = 0.00072546;
                const c9 = -0.000003582;
                const HI = c1 + (c2 * temp) + (c3 * humidity) + (c4 * temp * humidity) + (c5 * temp * temp) + (c6 * humidity * humidity) + (c7 * temp * temp * humidity) + (c8 * temp * humidity * humidity) + (c9 * temp * temp * humidity * humidity);
                if (solarRad > 0) {
                    return HI + (solarRad / 200);
                }
                return HI;
            }
            let solarEffect = 0;
            if (solarRad > 0) {
                solarEffect = solarRad / 220;
            }
            let windEffect = 0;
            if (windSpeed > 0) {
                windEffect = (Math.pow(windSpeed, 0.5));
            }
            return temp + solarEffect - (windEffect * 0.5);
        }

        function buildPlaylist() {
            if (pwsDataStore.length === 0 && foreignDataStore.length === 0) return [];
            const round1 = shuffleArray([...pwsDataStore]);
            const round2 = shuffleArray([...pwsDataStore]);
            const foreign = shuffleArray([...foreignDataStore]);
            return [...round1, ...round2, ...foreign];
        }

        async function fetchWeatherData() {
            let newPwsData = [];
            let newForeignData = [];

            if (WUNDERGROUND_API_KEY && PWS_MAP) {
                const pwsKeys = Object.keys(PWS_MAP);
                const pwsPromises = pwsKeys.map(async (stationId) => {
                    try {
                        const url = `https://api.weather.com/v2/pws/observations/current?stationId=${stationId}&format=json&units=m&apiKey=${WUNDERGROUND_API_KEY}&numericPrecision=decimal`;
                        const response = await fetchWithProxyFallback(url);
                        const data = await response.json();
                        if (!data.observations || data.observations.length === 0) return null;
                        const obs = data.observations[0];
                        return {
                            type: 'PWS',
                            name: PWS_MAP[stationId], 
                            id: obs.stationID,
                            time: obs.obsTimeLocal.split(' ')[1].substring(0,5),
                            temp: obs.metric.temp,
                            humidity: obs.humidity,
                            windSpeed: obs.metric.windSpeed,
                            windGust: obs.metric.windGust,
                            windDir: obs.winddir,
                            pressure: obs.metric.pressure,
                            precipRate: obs.metric.precipRate,
                            precipTotal: obs.metric.precipTotal,
                            uv: obs.uv,
                            solarRad: obs.solarRadiation,
                            heatIndex: obs.metric.heatIndex,
                            windChill: obs.metric.windChill,
                            dewpt: obs.metric.dewpt
                        };
                    } catch (error) { return null; }
                });
                const pwsResults = await Promise.all(pwsPromises);
                newPwsData = pwsResults.filter(r => r !== null);
            }

            if (FOREIGN_CITIES && FOREIGN_CITIES.length > 0) {
                const foreignPromises = FOREIGN_CITIES.map(async (city) => {
                    try {
                        const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,is_day,weather_code,wind_speed_10m,surface_pressure&timezone=auto`;
                        const response = await fetch(url);
                        if (!response.ok) return null;
                        const data = await response.json();
                        const current = data.current;
                        const localTime = new Date(); 
                        const timeStr = localTime.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit', timeZone: data.timezone });
                        return {
                            type: 'OM',
                            name: city.name,
                            time: timeStr,
                            temp: current.temperature_2m,
                            humidity: current.relative_humidity_2m,
                            windSpeed: current.wind_speed_10m,
                            pressure: current.surface_pressure,
                            code: current.weather_code,
                            is_day: current.is_day
                        };
                    } catch (e) { return null; }
                });
                const foreignResults = await Promise.all(foreignPromises);
                newForeignData = foreignResults.filter(r => r !== null);
            }

            pwsDataStore = newPwsData;
            foreignDataStore = newForeignData;
            
            if (weatherPlaylist.length === 0) {
                weatherPlaylist = buildPlaylist();
            } else {
                weatherPlaylist = weatherPlaylist.map(item => {
                    if (item.type === 'PWS') {
                        const fresh = pwsDataStore.find(p => p.id === item.id);
                        return fresh || item;
                    } else {
                        const fresh = foreignDataStore.find(f => f.name === item.name);
                        return fresh || item;
                    }
                });
            }

            if (document.visibilityState === 'visible') {
                const currentWidget = document.querySelector('.weather-widget');
                if (currentWidget) {
                    const currentLocationEl = currentWidget.querySelector('.weather-location');
                    const currentLocationName = currentLocationEl ? currentLocationEl.textContent : '';
                    
                    let freshData = pwsDataStore.find(p => p.name === currentLocationName) || 
                                    foreignDataStore.find(f => f.name === currentLocationName);
                    
                    if (freshData) {
                        updateCurrentWidgetValues(freshData);
                    }
                }
            }
        }
        
        function updateCurrentWidgetValues(data) {
            const w = document.querySelector('.weather-widget');
            if (!w) return;

            const updateText = (selector, text) => {
                const el = w.querySelector(selector);
                if (el) el.textContent = text;
            };

            if (data.type === 'PWS') {
                const temp = typeof data.temp === 'number' ? data.temp.toFixed(1) : '--';
                const tempEl = w.querySelector('.pws-temp');
                if (tempEl && tempEl.firstChild) tempEl.firstChild.textContent = temp;

                const pressure = typeof data.pressure === 'number' ? data.pressure.toFixed(1) : '--';
                const precipRate = typeof data.precipRate === 'number' ? data.precipRate : 0;
                const precipTotal = typeof data.precipTotal === 'number' ? data.precipTotal.toFixed(1) : '0';
                const windS = typeof data.windSpeed === 'number' ? data.windSpeed.toFixed(1) : '0';
                
                let precipText = getPrecipitationText(precipRate, data.temp);
                let windDirText = getWindDirection(data.windDir);

                const items = w.querySelectorAll('.pws-item');
                if (items.length >= 4) {
                    items[0].querySelector('.pws-value').textContent = `${data.humidity}%`;
                    items[0].querySelector('.pws-sub-value').textContent = `${pressure} hPa`;
                    
                    items[1].querySelector('.pws-value').textContent = `${windS} km/h`;
                    items[1].querySelector('.pws-sub-value').textContent = windDirText;

                    items[2].querySelector('.pws-value').textContent = `${precipTotal} mm`;
                    
                    if (precipText) {
                        items[3].querySelector('.pws-label').textContent = "Csapadék most";
                        items[3].querySelector('.pws-value').textContent = precipText;
                        items[3].querySelector('.pws-value').style = "font-size: 0.7rem; color: #4fc3f7;";
                        items[3].querySelector('.pws-sub-value').textContent = "";
                    } else {
                        items[3].querySelector('.pws-label').textContent = "Valós hőérzet";
                        let feelsLike = calculateComplexRealFeel(data.temp, data.humidity, data.windSpeed, data.solarRad);
                        items[3].querySelector('.pws-value').textContent = `${feelsLike.toFixed(1)}°C`;
                        items[3].querySelector('.pws-value').style = "font-size: 0.7rem; color: #eee;";
                        items[3].querySelector('.pws-sub-value').textContent = "";
                    }
                }
                updateText('.weather-time', data.time);

            } else {
                const temp = Math.round(data.temp);
                const tempEl = w.querySelector('.pws-temp');
                if (tempEl && tempEl.firstChild) tempEl.firstChild.textContent = temp;
                
                const items = w.querySelectorAll('.pws-item');
                if (items.length >= 3) {
                    items[0].querySelector('.pws-value').textContent = `${data.humidity}%`;
                    items[1].querySelector('.pws-value').textContent = `${Math.round(data.windSpeed)} km/h`;
                    items[2].querySelector('.pws-value').textContent = `${Math.round(data.pressure)} hPa`;
                }
                updateText('.weather-time', data.time);
            }
        }

        function displayWeather() {
            if (weatherIndex >= weatherPlaylist.length) {
                weatherPlaylist = buildPlaylist();
                weatherIndex = 0;
            }

            if (weatherPlaylist.length === 0) {
                 worldWeatherContainer.innerHTML = `<div class="placeholder">Adatok frissítése...</div>`;
                 return;
            }

            const currentData = weatherPlaylist[weatherIndex];
            weatherIndex++;

            let widgetHtml = '';

            if (currentData.type === 'PWS') {
                const temp = typeof currentData.temp === 'number' ? currentData.temp.toFixed(1) : '--';
                const pressure = typeof currentData.pressure === 'number' ? currentData.pressure.toFixed(1) : '--';
                const precipRate = typeof currentData.precipRate === 'number' ? currentData.precipRate : 0;
                const precipTotal = typeof currentData.precipTotal === 'number' ? currentData.precipTotal.toFixed(1) : '0';
                const windS = typeof currentData.windSpeed === 'number' ? currentData.windSpeed.toFixed(1) : '0';
                
                let windDirText = getWindDirection(currentData.windDir);
                let precipText = getPrecipitationText(precipRate, currentData.temp);
                
                let topLabel = "Valós hőérzet";
                let topValue = "";
                let topValueStyle = "font-size: 0.7rem; color: #eee;";
                let topSubValue = "";

                if (precipText) {
                    topLabel = "Csapadék most";
                    topValue = precipText;
                    topValueStyle = "font-size: 0.7rem; color: #4fc3f7;";
                } else {
                    let feelsLike = calculateComplexRealFeel(currentData.temp, currentData.humidity, currentData.windSpeed, currentData.solarRad);
                    topValue = `${feelsLike.toFixed(1)}°C`;
                }

                widgetHtml = `
                    <div class="weather-widget">
                        <div class="weather-header">
                            <div class="weather-location" title="${currentData.id}"><span class="status-dot green"></span>${currentData.name}</div>
                            <div class="weather-time">${currentData.time}</div>
                        </div>
                        
                        <div class="pws-main-data">
                             <div class="pws-temp">${temp}<span class="pws-unit">°C</span></div>
                        </div>

                        <div class="pws-grid">
                            <div class="pws-item" title="Légkör">
                                <div class="pws-label">Pára / Nyomás</div>
                                <div class="pws-value">${currentData.humidity}%</div>
                                <div class="pws-sub-value">${pressure} hPa</div>
                            </div>
                            <div class="pws-item" title="Szél">
                                <div class="pws-label">Szél</div>
                                <div class="pws-value">${windS} km/h</div>
                                <div class="pws-sub-value" style="font-size: 0.6rem;">${windDirText}</div>
                            </div>
                             <div class="pws-item" title="Csapadék">
                                <div class="pws-label">Eddig ma</div>
                                <div class="pws-value" style="${precipTotal > 0 ? 'color:#4fc3f7' : ''}">${precipTotal} mm</div>
                            </div>
                            <div class="pws-item" title="Extra">
                                 <div class="pws-label">${topLabel}</div>
                                <div class="pws-value" style="${topValueStyle}">${topValue}</div>
                                <div class="pws-sub-value">${topSubValue}</div>
                            </div>
                        </div>
                    </div>`;
            } else {
                const temp = Math.round(currentData.temp);
                
                widgetHtml = `
                    <div class="weather-widget">
                        <div class="weather-header">
                            <div class="weather-location">${currentData.name}</div>
                            <div class="weather-time">${currentData.time}</div>
                        </div>
                        <div class="pws-main-data">
                             <div class="pws-temp">${temp}<span class="pws-unit">°C</span></div>
                        </div>
                        <div class="pws-grid">
                             <div class="pws-item">
                                <div class="pws-label">Pára</div>
                                <div class="pws-value">${currentData.humidity}%</div>
                            </div>
                            <div class="pws-item">
                                <div class="pws-label">Szél</div>
                                <div class="pws-value">${Math.round(currentData.windSpeed)} km/h</div>
                            </div>
                             <div class="pws-item">
                                <div class="pws-label">Nyomás</div>
                                <div class="pws-value">${Math.round(currentData.pressure)} hPa</div>
                            </div>
                        </div>
                    </div>`;
            }
            
            worldWeatherContainer.innerHTML = widgetHtml;
        }

        function updateDynamicSkyAndTheme() {
            const now = new Date();
            const times = SunCalc.getTimes(now, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);

            const sunriseTime = times.sunrise;
            const sunsetTime = times.sunset;
            const dayDuration = sunsetTime - sunriseTime;
            
            const sunriseMinus90 = new Date(sunriseTime.getTime() - 90 * 60 * 1000);
            const sunriseMinus45 = new Date(sunriseTime.getTime() - 45 * 60 * 1000);
            const sunsetPlus45 = new Date(sunsetTime.getTime() + 45 * 60 * 1000);
            const sunsetPlus90 = new Date(sunsetTime.getTime() + 90 * 60 * 1000);

            let currentPalette;

            if (now > sunriseTime && now < sunsetTime) {
                const timeSinceSunrise = now - sunriseTime;
                const dayProgress = timeSinceSunrise / dayDuration;

                if (dayProgress < 0.15) currentPalette = SKY_PALETTE.MORNING;
                else if (dayProgress < 0.4) currentPalette = SKY_PALETTE.LATE_MORNING;
                else if (dayProgress < 0.6) currentPalette = SKY_PALETTE.NOON;
                else if (dayProgress < 0.85) currentPalette = SKY_PALETTE.AFTERNOON;
                else currentPalette = SKY_PALETTE.SUNSET;
            } else {
                if (now >= sunsetTime && now < sunsetPlus45) currentPalette = SKY_PALETTE.DUSK;
                else if (now >= sunsetPlus45 && now < sunsetPlus90) currentPalette = SKY_PALETTE.EVENING;
                else if (now < sunriseMinus90) currentPalette = SKY_PALETTE.DEEP_NIGHT;
                else if (now < sunriseMinus45) currentPalette = SKY_PALETTE.PRE_DAWN;
                else if (now < sunriseTime) currentPalette = SKY_PALETTE.DAWN;
                else currentPalette = SKY_PALETTE.DEEP_NIGHT;
            }

            bodyEl.dataset.themeKey = currentPalette.themeKey;
            
            const newGradient = `linear-gradient(145deg, ${currentPalette.top}, ${currentPalette.bottom})`;
            const colors = THEME_COLORS[currentPalette.textColorMode];

            const root = document.documentElement.style;
            root.setProperty('--bg-main-gradient', newGradient);
            root.setProperty('--text-primary', colors.textPrimary);
            root.setProperty('--text-secondary', colors.textSecondary);
            root.setProperty('--border-color', colors.borderColor);
            root.setProperty('--item-bg-color', colors.itemBg);
            root.setProperty('--item-border-color', colors.itemBorder);
        }
        
        function showRefreshState(show, mode = 'text') {
            if (show) {
                labelContent.style.display = 'none';
                refreshOverlay.classList.add('visible');

                if (mode === 'animation') {
                    animationWrapper.style.display = 'flex';
                    refreshOverlay.classList.remove('refresh-animation-active');
                    void refreshOverlay.offsetWidth;
                    refreshOverlay.classList.add('refresh-animation-active');
                } else { 
                    animationWrapper.style.display = 'none';
                }
            } else {
                refreshOverlay.classList.remove('visible', 'refresh-animation-active');
                labelContent.style.display = '';
            }
        }
        
        function generateScheduleHtml(blocks, startIndex, count) {
            let scheduleHTML = '';
            for (let i = startIndex; i < startIndex + count; i++) {
                const blockIndex = (blocks.currentIndex + i) % blocks.all.length;
                const block = blocks.all[blockIndex];
                if (block.type === 'goodbye') continue;
                
                const startTime = formatBlockTime(block.start);
                scheduleHTML += `
                    <div class="schedule-item-v2">
                        <span class="schedule-time">${startTime}</span>
                        <div class="schedule-info">
                            <span class="schedule-title-main">${block.name}</span>
                            <span class="schedule-desc">${block.desc}</span>
                        </div>
                    </div>`;
            }
            return scheduleHTML;
        }

        function displayScheduleWidgetSequence() {
            if (weatherDisplayInterval) {
                clearInterval(weatherDisplayInterval);
                weatherDisplayInterval = null;
            }
            
            clearTimeout(scheduleWidgetTimeout);

            const currentIndex = THEMATIC_BLOCKS.findIndex(b => b.start === currentThematicBlock.start);
            if (currentIndex === -1) return;

            const blockInfo = { all: THEMATIC_BLOCKS, currentIndex: currentIndex };

            const nextItemsHtml = generateScheduleHtml(blockInfo, 1, 3);
            const laterItemsHtml = generateScheduleHtml(blockInfo, 4, 3);

            const fullHtml = `
                <div id="schedule-widget">
                    <div id="schedule-intro" class="schedule-card">
                        <div class="schedule-header">Műsorajánló</div>
                    </div>
                    <div id="schedule-next" class="schedule-card">
                        <div class="schedule-header">
                            Következik
                            <svg viewBox="0 0 24 24"><path d="M13 6l-1.41 1.41L16.17 12l-4.58 4.59L13 18l6-6z M6 6l-1.41 1.41L9.17 12l-4.58 4.59L6 18l6-6z"></path></svg>
                        </div>
                        <div class="schedule-list">${nextItemsHtml}</div>
                    </div>
                    <div id="schedule-later" class="schedule-card">
                        <div class="schedule-header">
                            Később
                            <svg viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"></path></svg>
                        </div>
                        <div class="schedule-list">${laterItemsHtml}</div>
                    </div>
                     <div id="schedule-credits" class="schedule-card">
                        <div class="credits-main-text">
                            Kövesd a 
                            <span class="credits-brand">
                                <svg class="ticker-logo" viewBox="0 0 24 24"><use href="#eye-paths"/></svg>
                                <span>TKP NEWS</span>
                                <svg class="ticker-logo" viewBox="0 0 24 24"><use href="#eye-paths"/></svg>
                            </span> 
                            hírsávot a nap 24 órájában
                        </div>
                        <div class="credits-footer">
                            <span>Készítette: Robi</span>
                            <span>&copy; Copyright by: Robi</span>
                        </div>
                    </div>
                </div>`;
            
            worldWeatherContainer.innerHTML = fullHtml;

            const introCard = document.getElementById('schedule-intro');
            const nextCard = document.getElementById('schedule-next');
            const laterCard = document.getElementById('schedule-later');
            const creditsCard = document.getElementById('schedule-credits');

            const highlightSequence = (cardElement) => {
                const items = cardElement.querySelectorAll('.schedule-item-v2');
                if (items.length === 0) return;

                setTimeout(() => items[0].classList.add('highlight-gold'), 500); // Start after fade-in
                setTimeout(() => {
                    items[0].classList.remove('highlight-gold');
                    if (items[1]) items[1].classList.add('highlight-gold');
                }, 3500);
                setTimeout(() => {
                    if (items[1]) items[1].classList.remove('highlight-gold');
                    if (items[2]) items[2].classList.add('highlight-gold');
                }, 6500);
                 setTimeout(() => {
                    if (items[2]) items[2].classList.remove('highlight-gold');
                }, 9500);
            };

            // --- Animation Sequence ---
            requestAnimationFrame(() => {
                worldWeatherContainer.classList.add('schedule-expanded');
                introCard.classList.add('visible');
            });

            scheduleWidgetTimeout = setTimeout(() => {
                introCard.classList.remove('visible');
                nextCard.classList.add('visible');
                highlightSequence(nextCard);
            }, 5000);

            scheduleWidgetTimeout = setTimeout(() => {
                nextCard.classList.remove('visible');
                laterCard.classList.add('visible');
                highlightSequence(laterCard);
            }, 20000); 
            
            scheduleWidgetTimeout = setTimeout(() => {
                laterCard.classList.remove('visible');
                creditsCard.classList.add('visible');
            }, 35000); 

            scheduleWidgetTimeout = setTimeout(() => {
                creditsCard.classList.remove('visible');
                worldWeatherContainer.classList.remove('schedule-expanded');
                
                scheduleWidgetTimeout = setTimeout(() => {
                    worldWeatherContainer.innerHTML = '<div class="placeholder"></div>';
                    if (!weatherDisplayInterval) {
                        displayWeather();
                        weatherDisplayInterval = setInterval(displayWeather, WEATHER_DISPLAY_INTERVAL_DURATION);
                    }
                }, 1000);

            }, 45000);
        }


        function getCurrentAndNextBlocks(now) {
            const currentTime = now.getHours() + now.getMinutes() / 60;
            let currentBlockIndex = -1;

            for (let i = THEMATIC_BLOCKS.length - 1; i >= 0; i--) {
                if (currentTime >= THEMATIC_BLOCKS[i].start) {
                    currentBlockIndex = i;
                    break;
                }
            }
            if (currentBlockIndex === -1) currentBlockIndex = THEMATIC_BLOCKS.length - 1;
            
            const nextBlockIndex = (currentBlockIndex + 1) % THEMATIC_BLOCKS.length;

            return {
                current: THEMATIC_BLOCKS[currentBlockIndex],
                next: THEMATIC_BLOCKS[nextBlockIndex]
            };
        }

        function updateClock() {
            const now = new Date(); 
            const year = now.getFullYear(), month = String(now.getMonth() + 1).padStart(2, '0'), day = String(now.getDate()).padStart(2, '0'), dayOfWeek = CALENDAR_DATA.napok[now.getDay()], hours = String(now.getHours()).padStart(2, '0'), minutes = String(now.getMinutes()).padStart(2, '0'), seconds = now.getSeconds();
            
            document.getElementById('clock').innerHTML = `${year}.${month}.${day}. ${dayOfWeek} ${hours}<span class="clock-colon">:</span>${minutes}`;
            
            const { current, next } = getCurrentAndNextBlocks(now);

            if (currentThematicBlock && currentThematicBlock.type !== 'summary_yesterday') {
                if (minutes === 59 && seconds >= 50 && !isCountdownActive) {
                    isCountdownActive = true;
                    pauseFlipCycle();
                    tickerWrap.classList.add('countdown-active');
                    countdownOverlayEl.classList.add('visible');
                    
                    if (seconds === 50) {
                        console.log("Óránkénti frissítés indítása a visszaszámlálás alatt...");
                        sessionStorage.removeItem('newsCache');
                        triggerUpdate(true);
                    }
                }

                if (isCountdownActive) {
                    countdownClockEl.textContent = `${hours}:${minutes}:${String(seconds).padStart(2, '0')}`;
                }
                
                if (minutes === 0 && seconds === 0 && isCountdownActive) {
                    isCountdownActive = false;
                    tickerWrap.classList.remove('countdown-active');
                    countdownOverlayEl.classList.remove('visible');
                    console.log("Visszaszámlálás vége, hírciklus indítása elölről.");
                    startFlipCycle(true);
                }
            }
            
            if ((minutes % 20 === 0) && seconds < 10 && minutes !== lastScheduleMinute) {
                lastScheduleMinute = minutes;
                if (document.visibilityState === 'visible' && !isCountdownActive) {
                     // FIX: Az éjféli műsorajánlót kivételesen 00:01-re tesszük
                     if (hours === "00" && minutes === "00") {
                         // Ne fusson le, mert épp az átállás van
                     } else if (hours === "00" && minutes === "01") {
                         displayScheduleWidgetSequence(); // Kivételes futtatás
                     } else {
                         displayScheduleWidgetSequence();
                     }
                }
            }

            if (currentThematicBlock === null || current.start !== currentThematicBlock.start) {
                console.log(`Tematikus blokk váltás: ${current.name}`);
                currentThematicBlock = current;
                
                // ÉJFÉLI JAVÍTÁS: Ha átlépünk "summary_yesterday" módba (00:00),
                // akkor kényszerítjük az adatbázis frissítését és a "tegnapi" szűrő alkalmazását.
                if (current.type === 'summary_yesterday') {
                    sessionStorage.removeItem('newsCache');
                    triggerUpdate(true);
                } else {
                    sessionStorage.removeItem('newsCache');
                    if(isCountdownActive) {
                        isCountdownActive = false;
                        tickerWrap.classList.remove('countdown-active');
                        countdownOverlayEl.classList.remove('visible');
                    }
                    triggerUpdate(true);
                }
                return;
            }
            
            const nextStartTime = new Date(now);
            nextStartTime.setHours(Math.floor(next.start), Math.round((next.start % 1) * 60), 0, 0);
            if (next.start < current.start) nextStartTime.setDate(nextStartTime.getDate() + 1);
            
            // --- NIGHT SHIFT LOGIC START ---
            const secondsSinceMidnight = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const limitSeconds = 5 * 3600 + 45 * 60; // 05:45:00
            let customNightMessage = false;

            if (currentThematicBlock && currentThematicBlock.start === 0) {
                 if (secondsSinceMidnight >= 30 && secondsSinceMidnight < limitSeconds) {
                     nextBlockIndicatorEl.textContent = "06:00-ig az előző nap hírei olvashatók";
                     nextBlockIndicatorEl.style.display = 'block';
                     customNightMessage = true;
                 }
            }
            // --- NIGHT SHIFT LOGIC END ---

            if (!customNightMessage) {
                const timeToNext = nextStartTime - now;
                if (timeToNext > 0 && timeToNext < 15 * 60 * 1000) {
                    const nextBlockStartTime = formatBlockTime(next.start);
                    nextBlockIndicatorEl.textContent = `Következik ${nextBlockStartTime}-tól: ${next.name}`;
                    nextBlockIndicatorEl.style.display = 'block';
                } else {
                    nextBlockIndicatorEl.style.display = 'none';
                }
            }
            
            const refreshInterval = currentThematicBlock.refreshMinutes || 15;
            if (currentThematicBlock.type === 'fresh' && minutes % refreshInterval === 0 && seconds === 0 && minutes !== lastUpdateMinute) {
                lastUpdateMinute = minutes;
                if (document.visibilityState === 'visible' && !isCountdownActive) {
                    console.log(`Automatikus frissítés (${refreshInterval} percenként)...`);
                    sessionStorage.removeItem('newsCache');
                    triggerUpdate(true);
                }
            }
        }
        
        function updateCounter() {
            const items = tracks[activeTrackKey].querySelectorAll('.ticker-item, a.ticker-item');
            if (items.length > 0) {
                const total = (activeFilter !== 'all') ? fullFilteredNewsList.length : items.length;
                const current = (activeFilter !== 'all') ? (currentItemIndex + 1) + ((currentFilterPage - 1) * FILTER_CHUNK_SIZE) : currentItemIndex + 1;
                newsCounter.textContent = `${current} / ${total}`;
                newsCounter.style.display = 'block';
            } else {
                newsCounter.style.display = 'none';
            }
        }

        function setFilter(target) { if (target.tagName !== 'BUTTON' || isInfoMessageActive) return; activeFilter = target.dataset.filter; currentFilterPage = 1; const currentActive = filterControls.querySelector('.active'); if(currentActive) currentActive.classList.remove('active'); target.classList.add('active'); triggerUpdate(); }
        function getFaviconUrl(newsUrl) { try { const url = new URL(newsUrl); return `https://www.google.com/s2/favicons?domain=${url.hostname}&sz=32`; } catch { return ''; } }
        function tagNewsItems(newsItems) { return newsItems.map(item => { const title = item.title.toLowerCase(); item.categories = []; for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) { if (keywords.some(keyword => title.includes(keyword))) item.categories.push(category); } return item; }); }
        function updateFilterButtons(newsItems) { const availableCategories = new Set(newsItems.flatMap(item => item.categories || [])); filterControls.innerHTML = ''; const allBtn = document.createElement('button'); allBtn.dataset.filter = 'all'; allBtn.textContent = 'Összes'; filterControls.appendChild(allBtn); availableCategories.forEach(cat => { const btn = document.createElement('button'); btn.dataset.filter = cat; btn.textContent = cat; filterControls.appendChild(btn); }); let activeBtn = filterControls.querySelector(`[data-filter="${activeFilter}"]`) || filterControls.querySelector('[data-filter="all"]'); activeFilter = activeBtn.dataset.filter; activeBtn.classList.add('active'); }
        function filterNews(newsItems, category) { if (category === 'all') return newsItems; return newsItems.filter(item => item.categories && item.categories.includes(category)); }
        const getSourceName = (url) => { if (url.includes('index.hu')) return 'Index'; if (url.includes('telex.hu')) return 'Telex'; if (url.includes('hvg.hu')) return 'HVG'; if (url.includes('24.hu')) return '24.hu'; if (url.includes('ma.hu')) return 'ma.hu'; if (url.includes('portfolio.hu')) return 'Portfolio'; if (url.includes('origo.hu')) return 'Origo'; if (url.includes('nemzetisport.hu')) return 'NSO'; try { return new URL(url).hostname.replace('www.', '').split('.')[0].toUpperCase(); } catch { return 'Ismeretlen'; } };
        const formatTime = (dateObj) => dateObj.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
        const formatBlockTime = (time) => { const hour = Math.floor(time); const minute = Math.round((time % 1) * 60); return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`; };

        function pauseFlipCycle() { if (flipTimeoutId) { clearTimeout(flipTimeoutId); flipTimeoutId = null; const elapsed = Date.now() - flipStartTime; flipRemainingTime -= elapsed; progressBar.style.animationPlayState = 'paused'; } }
        function resumeFlipCycle() { if (flipRemainingTime > 0 && !isInfoMessageActive && !isCountdownActive && tracks[activeTrackKey].querySelectorAll('.ticker-item, a.ticker-item').length > 1) { flipStartTime = Date.now(); flipTimeoutId = setTimeout(cycleItems, flipRemainingTime); progressBar.style.animationPlayState = 'running';} }
        
        function showBreakingItem(item) {
            isShowingBreaking = true;
            pauseFlipCycle();
            
            const items = tracks[activeTrackKey].querySelectorAll('.ticker-item, a.ticker-item');
            items.forEach(el => el.classList.remove('visible'));
            
            // BREAKING UI
            const breakingHtml = `
                <a href="${item.link}" class="ticker-item breaking-highlight visible" target="_blank" rel="noopener noreferrer" data-image-url="${item.imageUrl || ''}">
                     <div class="item-watermark watermark-breaking">MOST ÉRKEZETT</div>
                     <div class="ticker-item-content-wrapper">
                        <div class="ticker-item-header">
                            <span class="meta">[<span class="source">${item.source}</span> | ${formatTime(new Date())}]</span>
                        </div>
                        <span class="ticker-item-title">${item.title}</span>
                        <span class="ticker-item-description">${getSmartDescription(item.description)}</span>
                    </div>
                </a>`;
            
            // Ideiglenes tárolóba vagy a track-be direkt
            // Mivel a struktúra fix, a legegyszerűbb ha a "ticker-content"-et cseréljük, de az macerás visszacsinálni.
            // Jobb megoldás: létrehozunk egy "breaking-layer"-t, de a jelenlegi kódban a legegyszerűbb:
            // A track-en belül appendelünk egyet, aztán töröljük.
            
            const container = tracks[activeTrackKey].querySelector('.ticker-content');
            const originalContent = container.innerHTML;
            container.innerHTML = breakingHtml;
            
            progressBar.classList.remove('animate');
            void progressBar.offsetWidth;
            progressBar.style.animationDuration = '20s';
            progressBar.classList.add('animate');
            
            flipRemainingTime = 20000;
            flipStartTime = Date.now();
            
            flipTimeoutId = setTimeout(() => {
                // Restore
                container.innerHTML = originalContent;
                // Re-init listeners/elements because HTML was replaced
                const restoredItems = tracks[activeTrackKey].querySelectorAll('.ticker-item, a.ticker-item');
                restoredItems.forEach(el => el.classList.remove('visible'));
                
                // Check queue again
                cycleItems(); 
            }, 20000);
        }

        function showItemAtIndex(index, isManual = false) {
            if (isInfoMessageActive || isCountdownActive) return;
            pauseFlipCycle();
            const items = tracks[activeTrackKey].querySelectorAll('.ticker-item, a.ticker-item');
            if(items.length === 0) return;

            items.forEach(item => item.classList.remove('visible'));
            
            currentItemIndex = (index + items.length) % items.length;
            lastRegularItemIndex = currentItemIndex; // Save position
            
            const currentItem = items[currentItemIndex];
            
            if(currentItem) {
                progressBar.classList.remove('animate');
                void progressBar.offsetWidth; 

                let duration = FLIP_INTERVAL_REGULAR;
                if (currentItem.classList.contains('announcement-item')) duration = FLIP_INTERVAL_ANNOUNCEMENT;
                else if (currentItem.classList.contains('calendar-item-v2') || currentItem.classList.contains('quote-item-v2')) duration = FLIP_INTERVAL_INFO;
                
                progressBar.style.animationDuration = `${duration / 1000}s`;
                progressBar.classList.add('animate');
                
                const isCurrentItemBreaking = currentItem.classList.contains('breaking-highlight');
                const watermarkEl = currentItem.querySelector('.item-watermark');
                const breakingIndicatorEl = currentItem.querySelector('.item-breaking-indicator');

                if (isCurrentItemBreaking) {
                    if (watermarkEl) watermarkEl.style.display = 'none';
                    if (breakingIndicatorEl) breakingIndicatorEl.style.display = 'block';
                } else {
                    if (breakingIndicatorEl) breakingIndicatorEl.style.display = 'none';
                    if (watermarkEl) {
                        watermarkEl.style.display = 'block';
                        // STROBE EFFECT ON RETURN
                        if (isShowingBreaking) {
                            isShowingBreaking = false; // Reset flag
                            watermarkEl.classList.add('strobe-in');
                            watermarkEl.addEventListener('animationend', () => {
                                watermarkEl.classList.remove('strobe-in');
                            }, { once: true });
                        } else if (wasPreviousItemBreaking) {
                             watermarkEl.style.visibility = 'hidden';
                            setTimeout(() => {
                                watermarkEl.style.visibility = 'visible';
                                watermarkEl.classList.add('strobe-in');
                                watermarkEl.addEventListener('animationend', () => {
                                    watermarkEl.classList.remove('strobe-in');
                                }, { once: true });
                            }, 1000);
                        }
                    }
                }

                wasPreviousItemBreaking = isCurrentItemBreaking;
                
                const imageUrl = currentItem.dataset.imageUrl;
                if (imageUrl && imageUrl !== 'null') {
                     fetchWithProxyFallback(imageUrl)
                        .then(response => response.blob())
                        .then(blob => {
                            labelImage.src = URL.createObjectURL(blob);
                            tickerLabel.classList.add('image-mode-active');
                        })
                        .catch(() => tickerLabel.classList.remove('image-mode-active'));
                } else {
                    tickerLabel.classList.remove('image-mode-active');
                }

                requestAnimationFrame(() => { 
                    currentItem.classList.add('visible');
                    updateCounter();
                    if (currentThematicBlock.type === 'summary_yesterday') updateTimeline();
                });

                flipRemainingTime = duration;
                if(currentThematicBlock.type !== 'goodbye') resumeFlipCycle();
            }
        }

        function cycleItems() { 
            if (isInfoMessageActive || isCountdownActive) return;
            
            // 1. Check Breaking Queue
            if (breakingNewsQueue.length > 0) {
                const nextBreaking = breakingNewsQueue.shift();
                showBreakingItem(nextBreaking);
                return;
            }

            // 2. Normal Cycle
            if (isShowingBreaking) {
                // Just returned from breaking news
                showItemAtIndex(lastRegularItemIndex); // Show the one we paused at, or next one? Let's show same to be sure user didn't miss reading.
                // Actually better: show current, and let timer run.
                // But wait, showItemAtIndex sets timer.
                // Let's just let showItemAtIndex handle the strobe.
            } else {
                const items = tracks[activeTrackKey].querySelectorAll('.ticker-item, a.ticker-item');
                if (activeFilter !== 'all' && currentItemIndex >= items.length - 1) {
                    const totalAvailable = fullFilteredNewsList.length;
                    const preliminaryItemsCount = (currentFilterPage === 1) ? preliminaryItems.length : 0;
                    const currentlyLoaded = (items.length - preliminaryItemsCount) + (currentFilterPage - 1) * FILTER_CHUNK_SIZE;

                    if (currentlyLoaded < totalAvailable) {
                        console.log("Hírek végére ért, következő adag betöltése...");
                        currentFilterPage++;
                        triggerUpdate(true, true);
                        return;
                    }
                }
                showItemAtIndex(currentItemIndex + 1); 
            }
        }
        
        function startFlipCycle(startAtFirst = true) {
            if (flipTimeoutId) clearTimeout(flipTimeoutId);
            pauseFlipCycle();
            const items = tracks[activeTrackKey].querySelectorAll('.ticker-item, a.ticker-item');

            if (items.length > 0) {
                const startIndex = startAtFirst ? 0 : currentItemIndex;
                showItemAtIndex(startIndex); 
            } else {
                updateCounter();
                flipRemainingTime = 0;
                progressBar.classList.remove('animate');
            }
        }
        
        function triggerEyeBlink() {
            const eyelid1 = document.getElementById('eyelid');
            const eyelid2 = document.getElementById('eyelid-2');
            if (!eyelid1 || !eyelid2 || document.visibilityState !== 'visible') return;

            eyelid1.style.transform = 'scaleY(1.2)';
            eyelid2.style.transform = 'scaleY(1.2)';
            setTimeout(() => {
                eyelid1.style.transform = 'scaleY(0)';
                eyelid2.style.transform = 'scaleY(0)';
            }, 150);

            const randomInterval = Math.random() * 7000 + 3000;
            setTimeout(triggerEyeBlink, randomInterval);
        }

        function triggerTextGlitch() { 
            if (document.visibilityState !== 'visible' || !bodyEl.classList.contains('intro-finished')) {
                const randomInterval = Math.random() * (20000 - 7000) + 7000;
                setTimeout(triggerTextGlitch, randomInterval);
                return;
            }; 
            brandNameEl.classList.add('glitch-text-active'); 
            setTimeout(() => { 
                brandNameEl.classList.remove('glitch-text-active'); 
            }, 300 + Math.random() * 200); 
            textGlitchTimeout = setTimeout(triggerTextGlitch, Math.random() * (20000 - 7000) + 7000);
        }

        function stopAllAnimatedEffects() { 
            clearTimeout(textGlitchTimeout); textGlitchTimeout = null; 
        }
        
        function startAllAnimatedEffects() { 
            stopAllAnimatedEffects();
            triggerTextGlitch(); 
        }

        async function fetchAndDisplayContent(isManualTrigger = false) {
            // FIX: Ha az első betöltésnél még nincs feed, de a Firebase már elindult, várjunk kicsit
            if (Object.keys(rssFeeds).length === 0) {
                 console.log("Várakozás feedekre...");
                 // Nem return-ölünk azonnal, hanem próbálkozunk
            }
            if (!currentThematicBlock) return;
            
            if (currentThematicBlock.type === 'goodbye') {
                const standbyTrackKey = activeTrackKey === 'a' ? 'b' : 'a';
                const standbyContent = tracks[standbyTrackKey].querySelector('.ticker-content');
                
                standbyContent.innerHTML = `
                    <div class="ticker-item visible goodbye-item">
                        <div class="goodbye-logo-row">
                            <svg class="ticker-logo" viewBox="0 0 24 24"><use href="#eye-paths"/></svg>
                            <h2>Nyugodalmas éjszakát kíván a TKP NEWS</h2>
                            <svg class="ticker-logo" viewBox="0 0 24 24"><use href="#eye-paths"/></svg>
                        </div>
                        <p>Friss hírek legközelebb reggel 6-tól, addig a nap összefoglalója következik.</p>
                    </div>`;
                
                requestAnimationFrame(() => {
                    tracks[standbyTrackKey].classList.add('visible');
                    tracks[activeTrackKey].classList.remove('visible');
                    activeTrackKey = standbyTrackKey;
                    startFlipCycle();
                });
                return; 
            }

            isInfoMessageActive = false;
            fetchStartTime = Date.now();
            clearTimeout(loadingTimeout);
            
            if (!isContentLoaded) {
                showRefreshState(true, isManualTrigger ? 'animation' : 'text');
            } else if (!isCountdownActive) {
                // manualRefreshTriggerEl.innerHTML = 'Frissítem a híreket<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>'; // REMOVED
                manualRefreshTriggerEl.style.cursor = 'default';
                // manualRefreshTriggerEl.style.display = 'block'; // REMOVED
            }
            
            stopNewsCheckCycle();
            accumulatedNewNewsCount = 0;
            // Breaking queue clear on full refresh? Maybe yes, to avoid duplicates or old news
            breakingNewsQueue = []; 

            loadingTimeout = setTimeout(() => {
                if (!isContentLoaded) showRefreshState(false);
                else manualRefreshTriggerEl.style.display = 'none';
                
                const standbyTrackKey = activeTrackKey === 'a' ? 'b' : 'a';
                const standbyContent = tracks[standbyTrackKey].querySelector('.ticker-content');
                standbyContent.innerHTML = `<div class="ticker-item visible" style="text-align: center; align-items: center;">A hírek betöltése a vártnál tovább tart. Kérjük, várjon...</div>`;
                tracks[standbyTrackKey].classList.add('visible');
                tracks[activeTrackKey].classList.remove('visible');
                console.error("News fetch timed out.");
            }, 35000);
            
            clearTimeout(newsFetchRetryTimeout);
            if(!isCountdownActive) pauseFlipCycle();
            timelineContainer.innerHTML = '';
            
            const CACHE_KEY = 'newsCache';
            const CACHE_EXPIRATION_MS = 10 * 60 * 1000;
            let allNewsItems;
            
            const cachedData = JSON.parse(sessionStorage.getItem(CACHE_KEY));
            if (!isManualTrigger && cachedData && (Date.now() - cachedData.timestamp < CACHE_EXPIRATION_MS)) {
                allNewsItems = cachedData.news;
                console.log("Hírek betöltve a gyorsítótárból.");
            }

            if (!allNewsItems) {
                console.log("Hírek letöltése a hálózatról...");
                 // Ha üres a feed lista, ne próbálkozzon, de ne is akadjon el
                 const feedList = Object.keys(rssFeeds).length > 0 ? rssFeeds : {};

                 const newsPromises = Object.entries(feedList).map(async ([key, url]) => {
                    try {
                        const res = await fetchWithProxyFallback(url);
                        
                        const str = url.includes('ma.hu') 
                            ? new TextDecoder('iso-8859-2').decode(await res.arrayBuffer())
                            : await res.text();
                        
                        const data = new window.DOMParser().parseFromString(str, "text/xml");
                        if (data.querySelector("parsererror")) throw new Error("XML parsing error");
                        
                        return { success: true, data: [...data.querySelectorAll("item")].map(item => { const fullDescriptionHtml = item.querySelector("description")?.textContent || ''; return { title: item.querySelector("title")?.textContent || '', link: item.querySelector("link")?.textContent || '#', pubDate: item.querySelector("pubDate")?.textContent || null, description: stripHtml(fullDescriptionHtml), source: getSourceName(url), imageUrl: extractImageUrl(item, fullDescriptionHtml) }; }) };
                    } catch (error) {
                        console.warn(`Hiba a forrás letöltésekor: ${url}`);
                        return { success: false, url, reason: error.message };
                    }
                });
                
                const fetchResults = await Promise.all(newsPromises);

                allNewsItems = tagNewsItems(
                    fetchResults
                        .filter(result => result.success)
                        .flatMap(result => result.data)
                );

                if (allNewsItems.length > 0) {
                    sessionStorage.setItem(CACHE_KEY, JSON.stringify({ news: allNewsItems, timestamp: Date.now() }));
                }
            }
            
            clearTimeout(loadingTimeout); 
            
            if (!allNewsItems || allNewsItems.length === 0) {
                console.warn("Nincsenek megjeleníthető hírek, újrapróbálkozás 5 másodperc múlva...");
                // Ne vegyük le a loading képernyőt ha ez az első futás
                if (isContentLoaded) manualRefreshTriggerEl.style.display = 'none';

                newsFetchRetryTimeout = setTimeout(() => triggerUpdate(true), 5000);
                return;
            }
            
            currentNewsLinks.clear();
            allNewsItems.forEach(item => { if(item.link) currentNewsLinks.add(item.link); });

            const today = new Date();
            const nameDayKey = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const names = CALENDAR_DATA.nameDays[nameDayKey] || [];
            if (names.length > 0) {
                namedayEl.textContent = `${names.join(', ')} névnapja van`;
                namedayEl.style.display = 'block';
            } else {
                namedayEl.style.display = 'none';
            }

            bodyEl.classList.remove('night-mode-active');
            updateFilterButtons(allNewsItems);
            
            let contentItems = [];
            let newsToDisplay;
            let preliminaryItems = [];
            
            const timeLimit = new Date();
            if (activeFilter !== 'all') {
                timeLimit.setHours(0, 0, 0, 0);
            } else if (currentThematicBlock.name === 'Napindító') {
                // FIX: Napindító: Mai 00:00-tól mostanáig
                timeLimit.setHours(0, 0, 0, 0);
            } else if (currentThematicBlock.type === 'fresh') {
                const hours = currentThematicBlock.timeWindowHours || 2;
                timeLimit.setHours(timeLimit.getHours() - hours);
            } else if (currentThematicBlock.type === 'summary_yesterday') {
                // Éjszakai műszak: Teljes tegnapi nap
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0, 0, 0, 0);
                timeLimit.setTime(yesterday.getTime());
                bodyEl.classList.add('night-mode-active');
            }

            let filteredNews = allNewsItems.filter(item => {
                if (!item.pubDate) return false;
                const itemDate = new Date(item.pubDate);
                if (currentThematicBlock.type === 'summary_yesterday' && activeFilter === 'all') {
                    const yesterdayEnd = new Date(timeLimit);
                    yesterdayEnd.setHours(23, 59, 59, 999);
                    return itemDate >= timeLimit && itemDate <= yesterdayEnd;
                }
                return itemDate >= timeLimit;
            });

            if (activeFilter !== 'all') {
                filteredNews = filterNews(filteredNews, activeFilter);
            }
            
            fullFilteredNewsList = filteredNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

            if (activeFilter !== 'all') {
                newsToDisplay = fullFilteredNewsList.slice(0, currentFilterPage * FILTER_CHUNK_SIZE);
            } else if(currentThematicBlock.type === 'summary_yesterday') {
                newsToDisplay = filteredNews.sort((a, b) => new Date(a.pubDate) - new Date(b.pubDate));
            } else {
                newsToDisplay = fullFilteredNewsList;
            }

            if ((activeFilter === 'all' || (isManualTrigger && currentFilterPage === 1)) && !isManualTrigger) {
                const dayOfMonth = today.getDate();
                const monthName = CALENDAR_DATA.honapok[today.getMonth()].toUpperCase();
                const year = today.getFullYear();
                const dayName = CALENDAR_DATA.napok[today.getDay()];
                const dayNameDisplay = dayName.charAt(0).toUpperCase() + dayName.slice(1);
                const sunTimes = SunCalc.getTimes(today, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
                const sunriseStr = formatTime(sunTimes.sunrise);
                const sunsetStr = formatTime(sunTimes.sunset);
                const nameDayText = names.length > 0 ? `<div class="ci-nameday">${names.join(', ')}</div>` : '';
                
                const watermarkHtml = `<div class="item-watermark">${currentThematicBlock.name}</div>`;
                
                const calendarHtml = `
                    <div class="ticker-item calendar-item-v2" data-image-url="">
                        ${watermarkHtml}
                        <div class="ci-left">
                            <div class="ci-day">${String(dayOfMonth).padStart(2, '0')}</div>
                            <div class="ci-month-year">${year}. ${monthName}</div>
                        </div>
                        <div class="ci-right">
                            <div class="ci-dayname">${dayNameDisplay}</div>
                            ${nameDayText}
                            <div class="ci-sun-info">
                                <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8 6 12 2 16 6"/></svg> ${sunriseStr}</span>
                                <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="16 5 12 9 8 5"/></svg> ${sunsetStr}</span>
                            </div>
                        </div>
                    </div>`;
                preliminaryItems.push(calendarHtml);
                
                if(currentThematicBlock.type !== 'summary_yesterday') {
                    const quote = QUOTES[dayOfMonth % QUOTES.length];
                    const quoteHtml = `
                        <div class="ticker-item quote-item-v2" data-image-url="">
                            <div class="item-watermark">${currentThematicBlock.name}</div>
                            <blockquote>“${quote.text}”</blockquote>
                            <div class="quote-divider"><cite>${quote.author}</cite></div>
                        </div>`;
                    preliminaryItems.push(quoteHtml);
                }
            }

            newsToDisplay = [...preliminaryItems, ...newsToDisplay];

            if (currentThematicBlock.type === 'summary_yesterday') generateTimeline();
            
            masterNewsList = newsToDisplay;
            
            contentItems = masterNewsList.map((item) => {
                if (typeof item === 'string') return item;
                
                const time = item.pubDate ? formatTime(new Date(item.pubDate)) : '';
                const faviconImg = item.link ? `<img src="${getFaviconUrl(item.link)}" class="favicon-img" alt="">` : '';
                const isBreaking = BREAKING_KEYWORDS.some(k => item.title.toLowerCase().includes(k));
                
                const watermarkText = (activeFilter !== 'all') ? activeFilter : currentThematicBlock.name;
                const watermarkHtml = `<div class="item-watermark watermark-punched">${watermarkText}</div>`;
                const breakingIndicatorHtml = `<div class="item-breaking-indicator">Rendkívüli hír</div>`;

                return `
                    <a href="${item.link}" class="ticker-item ${isBreaking ? 'breaking-highlight' : ''}" target="_blank" rel="noopener noreferrer" data-image-url="${item.imageUrl || ''}">
                        ${watermarkHtml}
                        ${breakingIndicatorHtml}
                        <div class="ticker-item-content-wrapper">
                            <div class="ticker-item-header">
                                <span class="meta">${faviconImg}[<span class="source">${item.source}</span> | ${time}]</span>
                            </div>
                            <span class="ticker-item-title">${item.title}</span>
                            <span class="ticker-item-description">${getSmartDescription(item.description)}</span>
                        </div>
                    </a>`;
            });
            
            const standbyTrackKey = activeTrackKey === 'a' ? 'b' : 'a';
            const standbyContent = tracks[standbyTrackKey].querySelector('.ticker-content');
            standbyContent.innerHTML = contentItems.join('');
            
            const fetchDuration = Date.now() - fetchStartTime;
            const minDisplayTime = isManualTrigger ? 1000 : 3500;
            const remainingTime = Math.max(0, minDisplayTime - fetchDuration);

            setTimeout(() => {
                if (!isContentLoaded) {
                    showRefreshState(false);
                    isContentLoaded = true;
                } else {
                    manualRefreshTriggerEl.style.display = 'none';
                    manualRefreshTriggerEl.style.cursor = 'pointer';
                }
                
                if (!isCountdownActive) {
                    requestAnimationFrame(() => {
                        tracks[standbyTrackKey].classList.add('visible');
                        tracks[activeTrackKey].classList.remove('visible');
                        activeTrackKey = standbyTrackKey;
                        startFlipCycle(true);
                    });
                }
                lastNewsCheckTimestamp = Date.now();
                startNewsCheckCycle();
            }, remainingTime);
        };

        async function checkForNewNews() {
            if (!currentThematicBlock || currentThematicBlock.type !== 'fresh' || document.visibilityState !== 'visible' || Object.keys(rssFeeds).length === 0) {
                return;
            }

            const checkStartTime = Date.now();
            if (lastNewsCheckTimestamp === 0) {
                lastNewsCheckTimestamp = checkStartTime;
                return;
            }

            try {
                const newsPromises = Object.values(rssFeeds).map(url => fetchWithProxyFallback(url).then(res => res.text()));
                const results = await Promise.allSettled(newsPromises);
                
                for (const result of results) {
                    if (result.status === 'fulfilled') {
                        try {
                            const data = new window.DOMParser().parseFromString(result.value, "text/xml");
                            if (data.querySelector("parsererror")) throw new Error("XML parsing error");
                            const items = data.querySelectorAll("item");
                            
                            items.forEach(item => {
                                const pubDate = new Date(item.querySelector("pubDate")?.textContent);
                                if (pubDate.getTime() > lastNewsCheckTimestamp) {
                                    const link = item.querySelector("link")?.textContent;
                                    // Csak akkor adjuk hozzá, ha még nincs a rendszerben
                                    if (link && !currentNewsLinks.has(link)) {
                                        currentNewsLinks.add(link);
                                        
                                        // 1. Parse ITEM immediately
                                        const fullDescriptionHtml = item.querySelector("description")?.textContent || '';
                                        const newItem = {
                                            title: item.querySelector("title")?.textContent || '',
                                            link: link,
                                            pubDate: pubDate,
                                            description: stripHtml(fullDescriptionHtml),
                                            source: 'BREAKING', // Forrást egyszerűsíthetjük vagy lekérhetjük url-ből
                                            imageUrl: extractImageUrl(item, fullDescriptionHtml)
                                        };
                                        
                                        // Get correct source name if possible (from url map logic ideally, but basic here)
                                        // We can't easily map back to keys here, so we use generic logic
                                        try { newItem.source = new URL(link).hostname.replace('www.', '').split('.')[0].toUpperCase(); } catch(e){}

                                        // 2. Add to Breaking Queue
                                        breakingNewsQueue.push(newItem);
                                    }
                                }
                            });
                        } catch (e) { /* Hiba esetén ugorja a forrást */ }
                    }
                }
                
                lastNewsCheckTimestamp = checkStartTime;

            } catch (error) {
                console.warn("Hiba az új hírek ellenőrzésekor:", error);
            }
        }

        function startNewsCheckCycle() {
            stopNewsCheckCycle();
            if (currentThematicBlock && currentThematicBlock.type === 'fresh') {
                setTimeout(checkForNewNews, 2 * 60 * 1000);
                newsCheckInterval = setInterval(checkForNewNews, 2 * 60 * 1000);
            }
        }

        function stopNewsCheckCycle() {
            if (newsCheckInterval) {
                clearInterval(newsCheckInterval);
                newsCheckInterval = null;
            }
        }

        function generateTimeline() {
            const newsItems = masterNewsList.filter(item => typeof item === 'object' && item.pubDate);
            if (newsItems.length === 0) return;
            const hours = [...new Set(newsItems.map(item => new Date(item.pubDate).getHours()))].sort((a, b) => a - b);
            timelineContainer.innerHTML = hours.map(hour => `<button data-hour="${hour}">${String(hour).padStart(2, '0')}</button>`).join('');
        }

        function updateTimeline() {
            if (!currentThematicBlock || currentThematicBlock.type !== 'summary_yesterday' || masterNewsList.length === 0) return;
            
            let currentNewsItem = masterNewsList[currentItemIndex];
             if (typeof currentNewsItem === 'string') {
                 for(let i = currentItemIndex; i >= 0; i--) {
                    const item = masterNewsList[i];
                    if(item && typeof item === 'object' && item.pubDate) { currentNewsItem = item; break; }
                }
            }
            if (!currentNewsItem || typeof currentNewsItem === 'string' || !currentNewsItem.pubDate) return;

            const currentHour = new Date(currentNewsItem.pubDate).getHours();
            const currentActive = timelineContainer.querySelector('.active-hour');
            if (currentActive && currentActive.dataset.hour !== String(currentHour)) {
                currentActive.classList.remove('active-hour');
            }
            
            const newActive = timelineContainer.querySelector(`[data-hour="${currentHour}"]`);
            if (newActive && !newActive.classList.contains('active-hour')) {
                newActive.classList.add('active-hour');
            }
        }

        const triggerUpdate = (force = false, isManual = false) => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                if (force || document.visibilityState === 'visible') {
                    fetchAndDisplayContent(isManual);
                }
            }, 500);
        };
        
        function stopAllTimers() { clearTimeout(updateTimeout); clearTimeout(debounceTimeout); clearTimeout(newsFetchRetryTimeout); clearTimeout(loadingTimeout); pauseFlipCycle(); if(weatherDisplayInterval) clearInterval(weatherDisplayInterval); if(weatherFetchInterval) clearInterval(weatherFetchInterval); weatherDisplayInterval = null; weatherFetchInterval = null; stopAllAnimatedEffects(); stopNewsCheckCycle(); clearTimeout(scheduleWidgetTimeout); }
        
        async function startAllTimers() { 
            // FIX: Kényszerítjük a hírek azonnali betöltését, nem várjuk meg a timeout-ot
            sessionStorage.removeItem('newsCache'); // cache ürítése a biztos frissítéshez induláskor
            triggerUpdate(true);
            
            if (!weatherFetchInterval) { 
                await fetchWeatherData();
                if (document.visibilityState === 'visible') displayWeather();
                // 30 másodperces frissítés a PWS adatokhoz
                weatherFetchInterval = setInterval(fetchWeatherData, 30000);
            }
            if (!weatherDisplayInterval) {
                 weatherDisplayInterval = setInterval(displayWeather, WEATHER_DISPLAY_INTERVAL_DURATION);
            }
            startAllAnimatedEffects();
        };

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => { 
                document.body.classList.add('loaded'); 
                
                setTimeout(() => {
                    tickerLabel.classList.add('intro-animation-active');
                    setTimeout(() => {
                        introAnimationContainer.style.display = 'none';
                        document.body.classList.add('intro-finished');
                        
                        // FIX: Biztosítjuk, hogy az intro után mindenképpen elinduljon
                        startAllTimers();
                        triggerEyeBlink();
                        
                    }, 5200);

                }, 2000);

            }, 200);
            
            updateClock(); 
            setInterval(updateClock, 1000);
            
            updateDynamicSkyAndTheme(); 
            setInterval(updateDynamicSkyAndTheme, 60 * 1000);
            
            document.addEventListener('visibilitychange', () => { 
                if (document.visibilityState === 'visible') {
                    if (bodyEl.classList.contains('intro-finished')) {
                        updateDynamicSkyAndTheme();
                        resumeFlipCycle();
                        startAllAnimatedEffects();
                        if (!weatherDisplayInterval) {
                            displayWeather();
                            weatherDisplayInterval = setInterval(displayWeather, WEATHER_DISPLAY_INTERVAL_DURATION);
                        }
                         // Ha visszatérünk az oldalra, frissítsünk rá a hírekre is
                         checkForNewNews();
                    }
                } else {
                    stopAllTimers();
                }
            });

            tickerWrap.addEventListener('mouseenter', pauseFlipCycle);
            tickerWrap.addEventListener('mouseleave', resumeFlipCycle);
            prevBtn.addEventListener('click', () => showItemAtIndex(currentItemIndex - 1, true));
            nextBtn.addEventListener('click', () => showItemAtIndex(currentItemIndex + 1, true));
            
            manualRefreshTriggerEl.addEventListener('click', () => {
                if (!refreshOverlay.classList.contains('visible') && !isCountdownActive) {
                    console.log("Manuális frissítés...");
                    sessionStorage.removeItem('newsCache');
                    triggerUpdate(true, true);
                }
            });

            timelineContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const hour = parseInt(e.target.dataset.hour, 10);
                    const firstItemIndex = masterNewsList.findIndex(item => typeof item === 'object' && item.pubDate && new Date(item.pubDate).getHours() === hour);
                    
                    if (firstItemIndex !== -1) {
                         showItemAtIndex(firstItemIndex, true);
                    }
                }
            });
        });

        filterControls.addEventListener('click', (e) => setFilter(e.target));
        // FIX: Firebase adatváltozáskor is azonnali trigger
        onValue(announcementsRef, (snapshot) => { customAnnouncements = snapshot.val() ? Object.values(snapshot.val()) : []; sessionStorage.removeItem('newsCache'); triggerUpdate(true); });
        onValue(feedsRef, (snapshot) => { 
            rssFeeds = snapshot.val() || {};
            sessionStorage.removeItem('newsCache');
            // Ha már betöltött az oldal (intro kész), frissítünk, egyébként a startAllTimers elintézi
            if(bodyEl.classList.contains('intro-finished')) {
                triggerUpdate(true);
            }
        });

    </script>
</body>
</html>
